<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="x5-fullscreen" content="true">
<meta name="full-screen" content="yes">
<meta name="theme-color" content="#317EFB" />
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=0" name="viewport">
<meta name="description" content="SpringCloud 章一1.微服务调用方式基于RestTemplate发起的http请求实现远程调用 步骤: 1.将 RestTemplate 装入 IOC 容器 (springboot启动类就是配置类)     1234@Beanpublic RestTemplate getRestTemp()&amp;#123;    return  new RestTemplate();&amp;#125;  2.注入">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringColud">
<meta property="og:url" content="http://example.com/2022/10/22/SpringColud/index.html">
<meta property="og:site_name" content="成长路上的小湾">
<meta property="og:description" content="SpringCloud 章一1.微服务调用方式基于RestTemplate发起的http请求实现远程调用 步骤: 1.将 RestTemplate 装入 IOC 容器 (springboot启动类就是配置类)     1234@Beanpublic RestTemplate getRestTemp()&amp;#123;    return  new RestTemplate();&amp;#125;  2.注入">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/image-20220304094047697.png">
<meta property="og:image" content="http://example.com/images/image-20220304095723568.png">
<meta property="og:image" content="http://example.com/images/image-20220304113619138.png">
<meta property="og:image" content="http://example.com/images/image-20220304131343444.png">
<meta property="og:image" content="http://example.com/images/image-20220304134050006.png">
<meta property="og:image" content="http://example.com/images/image-20220304134235381.png">
<meta property="og:image" content="http://example.com/images/image-20220305102538998.png">
<meta property="og:image" content="http://example.com/images/image-20220305105922537.png">
<meta property="og:image" content="http://example.com/images/image-20220305105940231.png">
<meta property="og:image" content="http://example.com/images/image-20220305115009189.png">
<meta property="og:image" content="http://example.com/images/image-20220305115138346.png">
<meta property="og:image" content="http://example.com/images/image-20220305115040185.png">
<meta property="og:image" content="http://example.com/images/image-20220305132712211.png">
<meta property="og:image" content="http://example.com/images/image-20220305132749227.png">
<meta property="og:image" content="http://example.com/images/image-20220305133119942.png">
<meta property="og:image" content="http://example.com/images/image-20220305133756634.png">
<meta property="og:image" content="http://example.com/images/image-20220305133907756.png">
<meta property="og:image" content="http://example.com/images/image-20220305134016860.png">
<meta property="og:image" content="http://example.com/images/image-20220305140248557.png">
<meta property="og:image" content="http://example.com/images/image-20220305140327392.png">
<meta property="og:image" content="http://example.com/images/image-20220305140516292.png">
<meta property="og:image" content="http://example.com/images/image-20220305144156562.png">
<meta property="og:image" content="http://example.com/images/image-20220305171624015.png">
<meta property="og:image" content="http://example.com/images/image-20220305172059690.png">
<meta property="og:image" content="http://example.com/images/image-20220409164448484.png">
<meta property="og:image" content="http://example.com/images/image-20220305172217750.png">
<meta property="og:image" content="http://example.com/images/image-20220305174143549.png">
<meta property="og:image" content="http://example.com/images/image-20220306100924283.png">
<meta property="og:image" content="f:/BaiduNetdiskDownload/day02-SpringCloud02/讲义/assets/image-20210714174814204.png">
<meta property="og:image" content="http://example.com/images/image-20220307095614667.png">
<meta property="og:image" content="http://example.com/images/image-20220307095644094.png">
<meta property="og:image" content="f:/BaiduNetdiskDownload/day02-SpringCloud02/讲义/assets/image-20210714190640857.png">
<meta property="og:image" content="http://example.com/images/image-20220307100009898.png">
<meta property="og:image" content="http://example.com/images/image-20220307100437206.png">
<meta property="og:image" content="http://example.com/images/image-20220307100630861.png">
<meta property="og:image" content="http://example.com/images/image-20220307104046608.png">
<meta property="og:image" content="http://example.com/images/image-20220307111648337.png">
<meta property="og:image" content="http://example.com/images/image-20220307111721881.png">
<meta property="og:image" content="http://example.com/images/image-20220307130025204.png">
<meta property="og:image" content="http://example.com/images/image-20220307132634048.png">
<meta property="og:image" content="http://example.com/images/image-20220307133600588.png">
<meta property="og:image" content="http://example.com/images/image-20220307133624282.png">
<meta property="og:image" content="http://example.com/images/image-20220307142937197.png">
<meta property="og:image" content="http://example.com/images/image-20220307153200006.png">
<meta property="og:image" content="http://example.com/images/image-20220308125859983.png">
<meta property="og:image" content="http://example.com/images/image-20220308130305549.png">
<meta property="og:image" content="http://example.com/images/image-20220308130644451.png">
<meta property="og:image" content="http://example.com/images/image-20220308130716324.png">
<meta property="og:image" content="http://example.com/images/image-20220308131147326.png">
<meta property="og:image" content="http://example.com/images/image-20220308131502130.png">
<meta property="og:image" content="http://example.com/images/image-20220308131654050.png">
<meta property="og:image" content="http://example.com/images/image-20220308150957640.png">
<meta property="og:image" content="http://example.com/images/image-20220308151042400.png">
<meta property="og:image" content="http://example.com/images/image-20220308151226705.png">
<meta property="og:image" content="http://example.com/images/image-20220308193951843.png">
<meta property="og:image" content="http://example.com/images/image-20220308205626891.png">
<meta property="og:image" content="http://example.com/images/image-20220308210941752.png">
<meta property="og:image" content="http://example.com/images/image-20220308211304539.png">
<meta property="og:image" content="http://example.com/images/image-20220308211718821.png">
<meta property="og:image" content="http://example.com/images/image-20220309133722685.png">
<meta property="og:image" content="http://example.com/images/image-20220309134230584.png">
<meta property="og:image" content="http://example.com/images/image-20220309134311647.png">
<meta property="og:image" content="http://example.com/images/image-20220309134447805.png">
<meta property="og:image" content="http://example.com/images/image-20220309134536349.png">
<meta property="og:image" content="http://example.com/images/image-20220309134633715.png">
<meta property="og:image" content="http://example.com/images/image-20220309184012533.png">
<meta property="og:image" content="http://example.com/images/image-20220309193639315.png">
<meta property="og:image" content="http://example.com/images/image-20210731181341330.png">
<meta property="og:image" content="http://example.com/images/image-20220310194123304.png">
<meta property="og:image" content="http://example.com/images/image-20220310194511724.png">
<meta property="og:image" content="http://example.com/images/image-20220310195008583.png">
<meta property="og:image" content="http://example.com/images/image-20220310195102572.png">
<meta property="og:image" content="http://example.com/images/image-20220310195830928.png">
<meta property="og:image" content="http://example.com/images/image-20220311183139309.png">
<meta property="og:image" content="http://example.com/images/image-20220311183333577.png">
<meta property="og:image" content="http://example.com/images/image-20210717165309625.png">
<meta property="og:image" content="http://example.com/images/image-20210717165438225.png">
<meta property="og:image" content="http://example.com/images/image-20210717165509466.png">
<meta property="og:image" content="http://example.com/images/image-20210717165552676.png">
<meta property="og:image" content="http://example.com/images/image-20210717170041447.png">
<meta property="og:image" content="http://example.com/images/image-20210717170223317.png">
<meta property="og:image" content="http://example.com/images/image-20210717170705380.png">
<meta property="og:image" content="http://example.com/images/image-20210717170829229.png">
<meta property="og:image" content="http://example.com/images/image-20200525170410401.png">
<meta property="og:image" content="http://example.com/images/image-20210422232835363.png">
<meta property="og:image" content="http://example.com/images/image-20220312113147645.png">
<meta property="og:image" content="http://example.com/images/image-20220312113701789.png">
<meta property="og:image" content="http://example.com/images/image-20220312114123627.png">
<meta property="og:image" content="http://example.com/images/image-20220312114621024.png">
<meta property="og:image" content="http://example.com/images/image-20220312115025066.png">
<meta property="og:image" content="http://example.com/images/image-20220312115112261.png">
<meta property="og:image" content="http://example.com/images/image-20220312115229289.png">
<meta property="og:image" content="http://example.com/images/image-20210510165308064.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day05-Elasticsearch01/资料/assets/image-20210506101053676.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day05-Elasticsearch01/资料/assets/image-20210109105135812.png">
<meta property="og:image" content="http://example.com/images/image-20210506102630393.png">
<meta property="og:image" content="http://example.com/images/image-20210506110249144.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day05-Elasticsearch01/资料/assets/image-20210506110704293.png">
<meta property="og:image" content="http://example.com/images/image-20210506112225508.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day05-Elasticsearch01/资料/assets/image-20201115230900504.png">
<meta property="og:image" content="http://example.com/images/image-20220312135108857.png">
<meta property="og:image" content="http://example.com/images/image-20220312145238953.png">
<meta property="og:image" content="http://example.com/images/image-20220312145747886.png">
<meta property="og:image" content="http://example.com/images/image-20220315194847616.png">
<meta property="og:image" content="http://example.com/images/image-20220315194904634.png">
<meta property="og:image" content="http://example.com/images/image-20220315195214507.png">
<meta property="og:image" content="http://example.com/images/image-20220317130817457.png">
<meta property="og:image" content="http://example.com/images/image-20220317165321711.png">
<meta property="og:image" content="http://example.com/images/image-20220317165426380.png">
<meta property="og:image" content="http://example.com/images/image-20220317165617619.png">
<meta property="og:image" content="http://example.com/images/image-20220317195518450.png">
<meta property="og:image" content="http://example.com/images/image-20220317195601832.png">
<meta property="og:image" content="http://example.com/images/image-20220317200021864.png">
<meta property="og:image" content="http://example.com/images/image-20220318164056473.png">
<meta property="og:image" content="file://D:\BaiduNetdiskDownload\day06-Elasticsearch02%E8%AE%B2%E4%B9%89\assets\vZrdKAh19C.gif?lastModify=1647592987">
<meta property="og:image" content="http://example.com/images/image-20220318165102334.png">
<meta property="og:image" content="http://example.com/images/image-20220318170714395.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day06-Elasticsearch02/讲义/assets/image-20210721193152520.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day06-Elasticsearch02/讲义/assets/image-20210721193458182.png">
<meta property="og:image" content="http://example.com/images/image-20220318181536055.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day06-Elasticsearch02/讲义/assets/image-20210721200643029.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day06-Elasticsearch02/讲义/assets/image-20210721201003229.png">
<meta property="og:image" content="d:/BaiduNetdiskDownload/day06-Elasticsearch02/讲义/assets/image-20210721202705030.png">
<meta property="og:image" content="http://example.com/images/image-20220319113145598.png">
<meta property="og:image" content="http://example.com/images/image-20220320143929353.png">
<meta property="og:image" content="http://example.com/images/image-20220320144227937.png">
<meta property="og:image" content="http://example.com/images/image-20220320144556344.png">
<meta property="og:image" content="http://example.com/images/image-20220320145300122.png">
<meta property="og:image" content="http://example.com/images/image-20210715174252531.png">
<meta property="og:image" content="http://example.com/images/image-20210715190827846.png">
<meta property="og:image" content="http://example.com/images/image-20210715191134448.png">
<meta property="og:image" content="http://example.com/images/image-20210715191241799.png">
<meta property="og:image" content="http://example.com/images/image-20210715191757319.png">
<meta property="og:image" content="http://example.com/images/image-20220401201349351.png">
<meta property="og:image" content="http://example.com/images/image-20220401201515608.png">
<meta property="og:image" content="http://example.com/images/image-20220401202238751.png">
<meta property="og:image" content="http://example.com/images/image-20220401202622297.png">
<meta property="og:image" content="http://example.com/images/image-20210716105408723.png">
<meta property="og:image" content="http://example.com/images/image-20210716105408723.png">
<meta property="og:image" content="http://example.com/images/image-20210716105612312.png">
<meta property="og:image" content="http://example.com/images/image-20210716105812789.png">
<meta property="og:image" content="http://example.com/images/image-20210716110027064.png">
<meta property="og:image" content="http://example.com/images/image-20210716105855951.png">
<meta property="og:image" content="http://example.com/images/image-20210716105956401.png">
<meta property="og:image" content="http://example.com/images/image-20210716110225104.png">
<meta property="og:image" content="http://example.com/images/image-20210716110629796.png">
<meta property="og:image" content="http://example.com/images/image-20210716111012387.png">
<meta property="og:image" content="http://example.com/images/image-20210716111136699.png">
<meta property="og:image" content="http://example.com/images/image-20210716111303701.png">
<meta property="og:image" content="http://example.com/images/image-20210716111404717.png">
<meta property="og:image" content="http://example.com/images/image-20210716111526480.png">
<meta property="og:image" content="http://example.com/images/image-20210716111658541.png">
<meta property="og:image" content="http://example.com/images/image-20210716113147176.png">
<meta property="og:image" content="http://example.com/images/image-20210716113426524.png">
<meta property="og:image" content="http://example.com/images/image-20210716114243558.png">
<meta property="og:image" content="http://example.com/images/image-20210716114429361.png">
<meta property="og:image" content="http://example.com/images/image-20210716114522935.png">
<meta property="og:image" content="http://example.com/images/image-20210716114651137.png">
<meta property="og:image" content="http://example.com/images/image-20210716115014663.png">
<meta property="og:image" content="http://example.com/images/image-20210716115131463.png">
<meta property="og:image" content="http://example.com/images/image-20210716115232426.png">
<meta property="og:image" content="http://example.com/images/image-20210716115717523.png">
<meta property="og:image" content="http://example.com/images/image-20210716120033572.png">
<meta property="og:image" content="http://example.com/images/image-20210716120208509.png">
<meta property="og:image" content="http://example.com/images/image-20210716120319009.png">
<meta property="og:image" content="http://example.com/images/image-20210716120536714.png">
<meta property="og:image" content="http://example.com/images/image-20210716120754527.png">
<meta property="og:image" content="http://example.com/images/image-20210716120840501.png">
<meta property="og:image" content="http://example.com/images/image-20210716121105567.png">
<meta property="og:image" content="http://example.com/images/image-20210716120900365.png">
<meta property="og:image" content="http://example.com/images/image-20210716121201630.png">
<meta property="og:image" content="http://example.com/images/image-20210716120919131.png">
<meta property="og:image" content="http://example.com/images/image-20210716121220305.png">
<meta property="og:image" content="http://example.com/images/image-20210715173215243.png">
<meta property="og:image" content="http://example.com/images/image-20220402170054743.png">
<meta property="og:image" content="http://example.com/images/image-20210716122403502.png">
<meta property="og:image" content="http://example.com/images/image-20210716123705780.png">
<meta property="og:image" content="http://example.com/images/image-20210716123036937.png">
<meta property="og:image" content="http://example.com/images/image-20210716123240518.png">
<meta property="og:image" content="http://example.com/images/image-20210716123411217.png">
<meta property="og:image" content="http://example.com/images/image-20210716123831992.png">
<meta property="og:image" content="http://example.com/images/image-20210716123936844.png">
<meta property="og:image" content="http://example.com/images/image-20210716124229894.png">
<meta property="og:image" content="http://example.com/images/image-20210716124147820.png">
<meta property="og:image" content="http://example.com/images/image-20210716130958518.png">
<meta property="og:image" content="http://example.com/images/image-20210716145934347.png">
<meta property="og:image" content="http://example.com/images/image-20210716150234787.png">
<meta property="og:image" content="http://example.com/images/image-20210716150510956.png">
<meta property="og:image" content="http://example.com/images/image-20210716150605208.png">
<meta property="og:image" content="http://example.com/images/image-20210716150654094.png">
<meta property="og:image" content="http://example.com/images/image-20210716150740434.png">
<meta property="og:image" content="http://example.com/images/image-20210716150911004.png">
<meta property="og:image" content="http://example.com/images/image-20210716151107785.png">
<meta property="og:image" content="http://example.com/images/image-20210716131430682.png">
<meta property="og:image" content="http://example.com/images/image-20210716131522912.png">
<meta property="og:image" content="http://example.com/images/image-20210716151348183.png">
<meta property="og:image" content="http://example.com/images/image-20210716150654094.png">
<meta property="og:image" content="http://example.com/images/image-20210716151538785.png">
<meta property="og:image" content="http://example.com/images/image-20210716151722916.png">
<meta property="og:image" content="http://example.com/images/image-20210716151844817.png">
<meta property="og:image" content="http://example.com/images/image-20210716152010750.png">
<meta property="og:image" content="http://example.com/images/image-20210716152349191.png">
<meta property="og:image" content="http://example.com/images/image-20210716153250134.png">
<meta property="og:image" content="http://example.com/images/image-20210716153301069.png">
<meta property="og:image" content="http://example.com/images/image-20210716153348396.png">
<meta property="og:image" content="http://example.com/images/image-20210716153434095.png">
<meta property="og:image" content="http://example.com/images/image-20210716153938887.png">
<meta property="og:image" content="http://example.com/images/image-20210716154012736.png">
<meta property="og:image" content="http://example.com/images/image-20210716154155238.png">
<meta property="og:image" content="http://example.com/images/image-20210716154215456.png">
<meta property="og:image" content="http://example.com/images/image-20210716154255466.png">
<meta property="og:image" content="d:/360MoveData/Users/LIWEI/Desktop/gulimall/谷粒商城资料整理课件/谷粒商城.assets/image-20210927161514194.png">
<meta property="og:image" content="http://example.com/images/image-20220426144715233.png">
<meta property="og:image" content="http://example.com/images/image-20220426145110055.png">
<meta property="og:image" content="http://example.com/images/image-20220426164613162.png">
<meta property="og:image" content="http://example.com/images/image-20220609202249127.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/be21a1b6cca8c9d5114aa204053f06fb.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/dc4e90573e817878dcd0e0c10845b4e3.png">
<meta property="og:image" content="http://example.com/images/image-20220609210306295.png">
<meta property="og:image" content="http://example.com/images/image-20220609210336461.png">
<meta property="og:image" content="http://example.com/images/image-20220609211511310.png">
<meta property="og:image" content="http://example.com/images/image-20220609210520572.png">
<meta property="og:image" content="http://example.com/images/image-20220609211409565.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210522084808519.gif#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/ed4e87bd7fb021a39d1734ff6da43ebd.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/7754ca32b3e5c17fe365b224e9591b7a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/bdbaddf36d38afb1033d3bc19ea33fee.png">
<meta property="article:published_time" content="2022-10-22T10:49:44.000Z">
<meta property="article:modified_time" content="2022-10-23T07:33:58.666Z">
<meta property="article:author" content="liwei">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20220304094047697.png">


<title >SpringColud</title>

<!-- Favicon -->

    <link href='/img/logo.jpg?v=1.1.1' rel='icon' type='image/png' sizes='16x16' ></link>


    <link href='/img/logo.jpg?v=1.1.1' rel='icon' type='image/png' sizes='32x32' ></link>




<!-- Plugin -->




    
<link rel="stylesheet" href="/css/plugins/bootstrap.row.css">

    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.css">

    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css">


    

    



<!-- Icon -->

    
<link rel="stylesheet" href="/css/plugins/font-awesome.min.css">




<!-- Variable -->
<script>window.ASYNC_CONFIG = {"hostname":"example.com","author":"liwei","root":"/","typed_text":["没有 资格享受生活"],"favicon":{"logo":"/img/logo.jpg","icon16":"/img/logo.jpg","icon32":"/img/logo.jpg","appleTouchIcon":null,"webmanifest":null,"visibilitychange":false,"hidden":"/failure.ico","showText":"(/≧▽≦/)Hey! Good again!","hideText":"(●—●)Oh, crash!"},"theme_version":"1.1.1","theme":{"switch":true,"default":"style-light"},"search":{"enable":false,"type":"engine","href":"https://www.google.com/search?q=site:","domain":null},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms","author":"Post author: ","copyright_link":"Post link: ","copyright_license_title":"Copyright Notice: ","copyright_license_content":"All articles in this blog are licensed under undefined unless otherwise stated."},"creative_commons":{"license":"by-nc-sa","language":"deed.zh","post":false,"clipboard":false},"swup":false};</script>

<!-- Theme mode css -->
<link data-swup-theme rel="stylesheet" href="/css/index.css?v=1.1.1" id="trm-switch-style">
<script>
    let defaultMode = ASYNC_CONFIG.theme.default !=='auto' ?  ASYNC_CONFIG.theme.default : (window.matchMedia("(prefers-color-scheme: light)").matches ? 'style-light' : 'style-dark')
    let catchMode = localStorage.getItem('theme-mode') || defaultMode;
    let type = catchMode === 'style-dark' ? 'add' : 'remove';
    document.documentElement.classList[type]('dark')
</script>

<!-- CDN -->


    

    



<!-- Site Analytics -->
 
<meta name="generator" content="Hexo 5.4.2"></head>

<body>

  <!-- app wrapper -->
  <div class="trm-app-frame">

    <!-- page preloader -->
    <div class="trm-preloader">
    <div class="trm-holder">
        <div class="preloader">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
    <!-- page preloader end -->

    <!-- change mode preloader -->
    <div class="trm-mode-swich-animation-frame">
    <div class="trm-mode-swich-animation">
        <i class="i-sun"><i class="far fa-sun"></i></i>
        <div class="trm-horizon"></div>
        <i class="i-moon"><i class="far fa-moon"></i></i>
    </div>
</div>
    <!-- change mode preloader end -->

      <!-- scroll container -->
      <div id="trm-dynamic-content" class="trm-swup-animation">
        <div id="trm-scroll-container" class="trm-scroll-container" data-scroll-container style="opacity: 0">
          <div data-scroll-section id="content" class="trm-scroll-section">

            <div class="locomotive-scroll__sticky-target" style=" position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>

            <!-- top bar -->
            <header class="trm-top-bar" data-scroll data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="-10">
	<div class="container">
		<div class="trm-left-side">
			<!-- logo -->
			<a href="/" class="trm-logo-frame trm-anima-link">
				
					<img src="/img/logo.jpg" alt="logo">
				
				
					<div class="trm-logo-text">
						小<span>志-LIWEI</span>
					</div>
				
			</a>
			<!-- logo end -->
		</div>
		<div class="trm-right-side">

			<!-- menu -->
			<div class="trm-menu">
				<nav>
					<ul>
						
						<li class="menu-item-has-children ">
							<a  href="/" target="">
								home
							</a>
							
							<ul>
								
								<li>
									<a  href="/archives2/" target="">
										archives2
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li class="menu-item-has-children ">
							<a data-no-swup href="/archives/" target="">
								archives
							</a>
							
						</li>
						
						<li class="menu-item-has-children ">
							<a data-no-swup href="/archives/" target="">
								分类
							</a>
							
						</li>
						
					</ul>
				</nav>
			</div>
			<!-- menu end -->
			
			<!-- mode switcher place -->
			
			<div class="trm-mode-switcher-place">
				<!-- <div class="trm-hidden-switcher"> -->
					<div class="trm-mode-switcher">
					  <i class="far fa-sun"></i>
					  <input class="tgl tgl-light" id="trm-swich" type="checkbox">
					  <label class="trm-swich" for="trm-swich"></label>
					  <i class="far fa-moon"></i>
					</div>
				  <!-- </div> -->
			</div>
			
			<!-- mode switcher place end -->

			 

		</div>
		<div class="trm-menu-btn">
			<span></span>
		</div>
	</div>
</header>
            <!-- top bar end -->

            <!-- body -->
            
<div class="trm-content-start">
    <!-- banner -->
    <div class="trm-banner" data-scroll data-scroll-direction="vertical">
    
    <!-- banner cover -->
    <img style="object-position:top;object-fit:cover;" src="https://w.wallhaven.cc/full/x6/wallhaven-x65qol.jpg" alt="banner" class="trm-banner-cover" data-scroll data-scroll-direction="vertical" data-scroll-speed="-3">
    <!-- banner cover end -->
    

    <!-- banner content -->
    <div class="trm-banner-content trm-overlay">
        <div class="container" data-scroll data-scroll-direction="vertical" data-scroll-speed="0">
            <div class="row">
                
                <div class="col-lg-4"></div>
                
                <div class="col-lg-8">

                    <!-- banner title -->
                    <div class="trm-banner-text ">
                        <div class="trm-label trm-mb-20">
                            Hi my new friend!
                        </div>
                        <h1 class="trm-mb-30 trm-hsmb-font">
                            SpringColud
                        </h1>

                        
                            <ul class="trm-breadcrumbs trm-label">
                                <li>
                                    <a href="/" class="trm-anima-link">Home</a>
                                </li>
                                <li>
                                    <span>
                                        2022
                                    </span
                                ></li>
                            </ul>
                        
                    </div>
                    <!-- banner title end -->

                    <!-- scroll hint -->
                    <a href="#about-triger" data-scroll-to="#about-triger" data-scroll-offset="-130" class="trm-scroll-hint-frame">
                        <div class="trm-scroll-hint"></div>
                        <span class="trm-label">Scroll down</span>
                    </a>
                    <!-- scroll hint end -->

                </div>
            </div>
        </div>
    </div>
    <!-- banner content end -->
</div>
    <!-- banner end -->
    <div class="container">
        <div class="row">
            
                <div class="col-lg-4 hidden-sm">
                    <!-- main card -->
                    

<div class="trm-main-card-frame trm-sidebar">
    <div class="trm-main-card" data-scroll data-scroll-repeat data-scroll-sticky data-scroll-target=".locomotive-scroll__sticky-target" data-scroll-offset="60"> 
    
        <div class="trm-tabs" id="sidebar-tabs">
           <div class="trm-tabs-nav trm-mb-40" id="trm-tabs-nav">
                <div data-to="tabs-user" class="trm-tabs-nav-item"><i class="fas fa-user-alt"></i></div>
                <div data-to="tabs-toc" class="trm-tabs-nav-item active"><i class="fas fa-th-list"></i></div>
           </div>
            <div name="tabs-user" class="trm-tabs-item">
                <!-- card header -->
<div class="trm-mc-header">
    <div class="trm-avatar-frame trm-mb-20"><img class="trm-avatar" src="/img/avatar.jpg" alt="Avatar"> </div>
    <h5 class="trm-name trm-mb-15">
        hello、小志
    </h5>
    
    <div class="trm-label">
        穷人
        <span class="trm-typed-text">
            <!-- Words for theme.user.typedText -->
        </span>
    </div>
    
</div>
<!-- card header end -->

<!-- sidebar social -->
<div class="trm-divider trm-mb-40 trm-mt-40"></div>

<div class="trm-social">
    
        <a href="https://github.com" title="github" rel="nofollow" target="_blank">
            <i class="fab fa-github"></i>
        </a>
    
        <a href="https://cn.bing.com/?form=000047" title="gitee" rel="nofollow" target="_blank">
            <i class="fab fa-edge"></i>
        </a>
    
</div>

<!-- sidebar social end -->

<!-- info -->
<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<ul class="trm-table trm-mb-20">
    
        <li>
            <div class="trm-label">
                地址:
            </div>
            <div class="trm-label trm-label-light">
                HUAT
            </div>
        </li>
    
        <li>
            <div class="trm-label">
                年龄:
            </div>
            <div class="trm-label trm-label-light">
                24
            </div>
        </li>
    
</ul>

<!-- info end -->
<div class="trm-divider trm-mb-40 trm-mt-40"></div>
<!-- action button -->
<div class="text-center">
    <a href="mailto:lweiup@yeah.net" class="trm-btn">
        Contact Me
        <i class="far fa-envelope"></i>
    </a>
</div>
<!-- action button end -->

            </div>
            <div name="tabs-toc" class="trm-tabs-item active">
                <div class="post-toc">
    <ol class="toc"><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#SpringCloud-章一"  data-scroll-to="#SpringCloud-章一"><span class="toc-text">SpringCloud 章一</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-微服务调用方式"  data-scroll-to="#1-微服务调用方式"><span class="toc-text">1.微服务调用方式</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-消费者与提供者"  data-scroll-to="#2-消费者与提供者"><span class="toc-text">2.消费者与提供者</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-Eureka注册中心"  data-scroll-to="#3-Eureka注册中心"><span class="toc-text">3.Eureka注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-1-eureka作用"  data-scroll-to="#3-1-eureka作用"><span class="toc-text">3.1 eureka作用:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-2-在Eurreka架构中，微服务角色有两类"  data-scroll-to="#3-2-在Eurreka架构中，微服务角色有两类"><span class="toc-text">3.2 在Eurreka架构中，微服务角色有两类</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-3-搭建注册中心-Eureka服务端"  data-scroll-to="#3-3-搭建注册中心-Eureka服务端"><span class="toc-text">3.3.搭建注册中心(Eureka服务端):</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-注册客户端-user-service-oorder-service"  data-scroll-to="#3-4-注册客户端-user-service-oorder-service"><span class="toc-text">3.4.注册客户端(user-service&#x2F;oorder-service)</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-5服务拉取"  data-scroll-to="#3-5服务拉取"><span class="toc-text">3.5服务拉取</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-LoadBalanced负载均衡注解："  data-scroll-to="#3-6-LoadBalanced负载均衡注解："><span class="toc-text">3.6@LoadBalanced负载均衡注解：</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-7搭建注册中心-服务注册-服务发现总结"  data-scroll-to="#3-7搭建注册中心-服务注册-服务发现总结"><span class="toc-text">3.7搭建注册中心-服务注册-服务发现总结:</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-Ribbon负载均衡"  data-scroll-to="#4-Ribbon负载均衡"><span class="toc-text">4.Ribbon负载均衡</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#负载均衡策略"  data-scroll-to="#负载均衡策略"><span class="toc-text">负载均衡策略</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#修改负载均衡策略"  data-scroll-to="#修改负载均衡策略"><span class="toc-text">修改负载均衡策略</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#饥饿加载"  data-scroll-to="#饥饿加载"><span class="toc-text">饥饿加载</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-Nacos注册中心"  data-scroll-to="#5-Nacos注册中心"><span class="toc-text">5.Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-1客户端注册到Nacos"  data-scroll-to="#5-1客户端注册到Nacos"><span class="toc-text">5.1客户端注册到Nacos</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-2Nacos分级存储模型"  data-scroll-to="#5-2Nacos分级存储模型"><span class="toc-text">5.2Nacos分级存储模型</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-3NacosRule负载均衡策略"  data-scroll-to="#5-3NacosRule负载均衡策略"><span class="toc-text">5.3NacosRule负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-4实例访问权重分配"  data-scroll-to="#5-4实例访问权重分配"><span class="toc-text">5.4实例访问权重分配</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-5环境隔离-namespace"  data-scroll-to="#5-5环境隔离-namespace"><span class="toc-text">5.5环境隔离 - namespace</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-6临时实例、和非临时实例"  data-scroll-to="#5-6临时实例、和非临时实例"><span class="toc-text">5.6临时实例、和非临时实例</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#总结"  data-scroll-to="#总结"><span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-Nacos与eureka的共同点"  data-scroll-to="#1-Nacos与eureka的共同点"><span class="toc-text">1.Nacos与eureka的共同点</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-Nacos与Eureka的区别"  data-scroll-to="#2-Nacos与Eureka的区别"><span class="toc-text">2.Nacos与Eureka的区别</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#SpringCloud-章二"  data-scroll-to="#SpringCloud-章二"><span class="toc-text">SpringCloud 章二</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-Nacos配置管理"  data-scroll-to="#1-Nacos配置管理"><span class="toc-text">1.Nacos配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-1-服务配置更改热更新"  data-scroll-to="#1-1-服务配置更改热更新"><span class="toc-text">1.1  服务配置更改热更新</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2从微服务拉取配置"  data-scroll-to="#1-2从微服务拉取配置"><span class="toc-text">1.2从微服务拉取配置</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-配置热更新"  data-scroll-to="#1-3-配置热更新"><span class="toc-text">1.3.配置热更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#方式一、-RefreshScope"  data-scroll-to="#方式一、-RefreshScope"><span class="toc-text">方式一、@RefreshScope</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#方式二、使用-ConfigurationProperties注解代替-Value注解。"  data-scroll-to="#方式二、使用-ConfigurationProperties注解代替-Value注解。"><span class="toc-text">方式二、使用@ConfigurationProperties注解代替@Value注解。</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-4多环境配置共享"  data-scroll-to="#1-4多环境配置共享"><span class="toc-text">1.4多环境配置共享</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-5多种配置优先级"  data-scroll-to="#1-5多种配置优先级"><span class="toc-text">1.5多种配置优先级</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-6Nacos集群搭建"  data-scroll-to="#1-6Nacos集群搭建"><span class="toc-text">1.6Nacos集群搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-http客户端Feign-远程调用"  data-scroll-to="#2-http客户端Feign-远程调用"><span class="toc-text">2.http客户端Feign(远程调用)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-1-Feign替代RestTemplate"  data-scroll-to="#2-1-Feign替代RestTemplate"><span class="toc-text">2.1.Feign替代RestTemplate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-1-引入依赖"  data-scroll-to="#2-1-1-引入依赖"><span class="toc-text">2.1.1.引入依赖</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-2-EnableFeignClients在启动类上开启Feign的功能"  data-scroll-to="#2-1-2-EnableFeignClients在启动类上开启Feign的功能"><span class="toc-text">2.1.2.@EnableFeignClients在启动类上开启Feign的功能</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-3-编写Feign的客户端"  data-scroll-to="#2-1-3-编写Feign的客户端"><span class="toc-text">2.1.3.编写Feign的客户端</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-4-测试使用-UserClient访问-userservice服务"  data-scroll-to="#2-1-4-测试使用-UserClient访问-userservice服务"><span class="toc-text">2.1.4.测试使用 UserClient访问 userservice服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2-生产实践问题"  data-scroll-to="#2-2-生产实践问题"><span class="toc-text">2.2 生产实践问题</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2-2抽取方式"  data-scroll-to="#2-2-2抽取方式"><span class="toc-text">2.2.2抽取方式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2-3实现基于抽取的最佳实践"  data-scroll-to="#2-2-3实现基于抽取的最佳实践"><span class="toc-text">2.2.3实现基于抽取的最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-统一网关Gateway"  data-scroll-to="#3-统一网关Gateway"><span class="toc-text">3.统一网关Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-1-为什么需要网关"  data-scroll-to="#3-1-为什么需要网关"><span class="toc-text">3.1.为什么需要网关</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-2-gateway快速入门"  data-scroll-to="#3-2-gateway快速入门"><span class="toc-text">3.2.gateway快速入门</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-3断言-访问规则-工厂"  data-scroll-to="#3-3断言-访问规则-工厂"><span class="toc-text">3.3断言(访问规则)工厂</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-请求过滤器工厂"  data-scroll-to="#3-4-请求过滤器工厂"><span class="toc-text">3.4.请求过滤器工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3-4-1-路由过滤器"  data-scroll-to="#3-4-1-路由过滤器"><span class="toc-text">3.4.1.路由过滤器</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3-4-2-默认过滤器default-filters"  data-scroll-to="#3-4-2-默认过滤器default-filters"><span class="toc-text">3.4.2.默认过滤器default-filters</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3-4-3-总结"  data-scroll-to="#3-4-3-总结"><span class="toc-text">3.4.3.总结</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3-4-4全局过滤器GlobalFilter"  data-scroll-to="#3-4-4全局过滤器GlobalFilter"><span class="toc-text">3.4.4全局过滤器GlobalFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a rel="nofollow" class="toc-link" href="#3-4-4-1定义方式是实现GlobalFilter接口"  data-scroll-to="#3-4-4-1定义方式是实现GlobalFilter接口"><span class="toc-text">3.4.4.1定义方式是实现GlobalFilter接口</span></a></li><li class="toc-item toc-level-5"><a rel="nofollow" class="toc-link" href="#3-4-4-2设置执行顺序-Order注解-实现-Ordered接口"  data-scroll-to="#3-4-4-2设置执行顺序-Order注解-实现-Ordered接口"><span class="toc-text">3.4.4.2设置执行顺序 @Order注解  实现 Ordered接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-5-过滤器执行顺序"  data-scroll-to="#3-5-过滤器执行顺序"><span class="toc-text">3.5.过滤器执行顺序</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-跨域问题"  data-scroll-to="#3-6-跨域问题"><span class="toc-text">3.6.跨域问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#Docker"  data-scroll-to="#Docker"><span class="toc-text">Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-啥是Docker"  data-scroll-to="#1-啥是Docker"><span class="toc-text">1.啥是Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-1解决依赖兼容问题"  data-scroll-to="#1-1解决依赖兼容问题"><span class="toc-text">1.1解决依赖兼容问题</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-Docker解决操作系统环境差异"  data-scroll-to="#1-2-Docker解决操作系统环境差异"><span class="toc-text">1.2.Docker解决操作系统环境差异</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-Docker和虚拟机的区别"  data-scroll-to="#1-3-Docker和虚拟机的区别"><span class="toc-text">1.3.Docker和虚拟机的区别</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-4Docker架构"  data-scroll-to="#1-4Docker架构"><span class="toc-text">1.4Docker架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-4-1镜像和容器"  data-scroll-to="#1-4-1镜像和容器"><span class="toc-text">1.4.1镜像和容器</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-4-2DockerHub"  data-scroll-to="#1-4-2DockerHub"><span class="toc-text">1.4.2DockerHub</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-4-3-Docker架构"  data-scroll-to="#1-4-3-Docker架构"><span class="toc-text">1.4.3.Docker架构</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-4-4-小结"  data-scroll-to="#1-4-4-小结"><span class="toc-text">1.4.4.小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-Docker基本操作"  data-scroll-to="#2-Docker基本操作"><span class="toc-text">2.Docker基本操作</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-1镜像操作"  data-scroll-to="#2-1镜像操作"><span class="toc-text">2.1镜像操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2镜像操作有哪些"  data-scroll-to="#2-2镜像操作有哪些"><span class="toc-text">2.2镜像操作有哪些</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-2容器操作"  data-scroll-to="#2-2容器操作"><span class="toc-text">2.2容器操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2-1-案例-创建并运行一个容器"  data-scroll-to="#2-2-1-案例-创建并运行一个容器"><span class="toc-text">2.2.1.案例-创建并运行一个容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-3数据卷-容器数据管理"  data-scroll-to="#2-3数据卷-容器数据管理"><span class="toc-text">2.3数据卷(容器数据管理)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3-1-什么是数据卷"  data-scroll-to="#2-3-1-什么是数据卷"><span class="toc-text">2.3.1.什么是数据卷</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3-2数据卷操作命令"  data-scroll-to="#2-3-2数据卷操作命令"><span class="toc-text">2.3.2数据卷操作命令</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#小结"  data-scroll-to="#小结"><span class="toc-text">小结:</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-4挂载数据卷"  data-scroll-to="#2-4挂载数据卷"><span class="toc-text">2.4挂载数据卷</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#方式一、带数据卷模式"  data-scroll-to="#方式一、带数据卷模式"><span class="toc-text">方式一、带数据卷模式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#方式二、直接挂载模式"  data-scroll-to="#方式二、直接挂载模式"><span class="toc-text">方式二、直接挂载模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-Dockerfile自定义镜像"  data-scroll-to="#3-Dockerfile自定义镜像"><span class="toc-text">3.Dockerfile自定义镜像</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-1镜像结构"  data-scroll-to="#3-1镜像结构"><span class="toc-text">3.1镜像结构</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-2Dockerfile语法"  data-scroll-to="#3-2Dockerfile语法"><span class="toc-text">3.2Dockerfile语法</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-DockerCompose"  data-scroll-to="#4-DockerCompose"><span class="toc-text">4.DockerCompose</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-1-初识DockerCompose"  data-scroll-to="#4-1-初识DockerCompose"><span class="toc-text">4.1.初识DockerCompose</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-compose文件"  data-scroll-to="#4-2-compose文件"><span class="toc-text">4.2.compose文件</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-3-修改微服务配置"  data-scroll-to="#4-3-修改微服务配置"><span class="toc-text">4.3.修改微服务配置</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-4-部署"  data-scroll-to="#4-4-部署"><span class="toc-text">4.4.部署</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-Docker镜像仓库"  data-scroll-to="#5-Docker镜像仓库"><span class="toc-text">5.Docker镜像仓库</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-1搭建私有镜像仓库"  data-scroll-to="#5-1搭建私有镜像仓库"><span class="toc-text">5.1搭建私有镜像仓库</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-2带有图形化界面"  data-scroll-to="#5-2带有图形化界面"><span class="toc-text">5.2带有图形化界面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-2-1配置Docker信任地址"  data-scroll-to="#5-2-1配置Docker信任地址"><span class="toc-text">5.2.1配置Docker信任地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-3镜像推送和拉取"  data-scroll-to="#5-3镜像推送和拉取"><span class="toc-text">5.3镜像推送和拉取</span></a></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#SpringAMQP"  data-scroll-to="#SpringAMQP"><span class="toc-text">SpringAMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-简单队列"  data-scroll-to="#1-简单队列"><span class="toc-text">1.简单队列</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-工作队列"  data-scroll-to="#2-工作队列"><span class="toc-text">2.工作队列</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-能者多劳"  data-scroll-to="#3-能者多劳"><span class="toc-text">3.能者多劳</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-总结"  data-scroll-to="#4-总结"><span class="toc-text">4.总结</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-3-发布-订阅"  data-scroll-to="#3-3-发布-订阅"><span class="toc-text">3.3.发布&#x2F;订阅</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-4-Fanout"  data-scroll-to="#3-4-Fanout"><span class="toc-text">3.4.Fanout</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-1-声明队列和交换机"  data-scroll-to="#3-4-1-声明队列和交换机"><span class="toc-text">3.4.1.声明队列和交换机</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-2-消息发送"  data-scroll-to="#3-4-2-消息发送"><span class="toc-text">3.4.2.消息发送</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-3-消息接收"  data-scroll-to="#3-4-3-消息接收"><span class="toc-text">3.4.3.消息接收</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-4-4-总结"  data-scroll-to="#3-4-4-总结"><span class="toc-text">3.4.4.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-5-Direct"  data-scroll-to="#3-5-Direct"><span class="toc-text">3.5.Direct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-5-1-基于注解声明队列和交换机"  data-scroll-to="#3-5-1-基于注解声明队列和交换机"><span class="toc-text">3.5.1.基于注解声明队列和交换机</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-5-2-消息发送"  data-scroll-to="#3-5-2-消息发送"><span class="toc-text">3.5.2.消息发送</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-5-3-总结"  data-scroll-to="#3-5-3-总结"><span class="toc-text">3.5.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-6-Topic"  data-scroll-to="#3-6-Topic"><span class="toc-text">3.6.Topic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-1-说明"  data-scroll-to="#3-6-1-说明"><span class="toc-text">3.6.1.说明</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-2-消息发送"  data-scroll-to="#3-6-2-消息发送"><span class="toc-text">3.6.2.消息发送</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-3-消息接收"  data-scroll-to="#3-6-3-消息接收"><span class="toc-text">3.6.3.消息接收</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-6-4-总结"  data-scroll-to="#3-6-4-总结"><span class="toc-text">3.6.4.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-7-消息转换器"  data-scroll-to="#3-7-消息转换器"><span class="toc-text">3.7.消息转换器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-7-1-测试默认转换器"  data-scroll-to="#3-7-1-测试默认转换器"><span class="toc-text">3.7.1.测试默认转换器</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-7-2-配置JSON转换器"  data-scroll-to="#3-7-2-配置JSON转换器"><span class="toc-text">3.7.2.配置JSON转换器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#Elasticsearch分布式搜索引擎"  data-scroll-to="#Elasticsearch分布式搜索引擎"><span class="toc-text">Elasticsearch分布式搜索引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-啥是ES"  data-scroll-to="#1-啥是ES"><span class="toc-text">1.啥是ES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-ELK技术栈"  data-scroll-to="#1-2-ELK技术栈"><span class="toc-text">1.2.ELK技术栈</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-总结"  data-scroll-to="#1-3-总结"><span class="toc-text">1.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-倒排索引"  data-scroll-to="#2-倒排索引"><span class="toc-text">2.倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-1正向索引"  data-scroll-to="#1-2-1正向索引"><span class="toc-text">1.2.1正向索引</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-2-倒排索引"  data-scroll-to="#1-2-2-倒排索引"><span class="toc-text">1.2.2.倒排索引</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-3-正向和倒排"  data-scroll-to="#1-2-3-正向和倒排"><span class="toc-text">1.2.3.正向和倒排</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-3-mysql与elasticsearch"  data-scroll-to="#1-3-3-mysql与elasticsearch"><span class="toc-text">1.3.3.mysql与elasticsearch</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-安装elasticsearch"  data-scroll-to="#3-安装elasticsearch"><span class="toc-text">3.安装elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-2-加载镜像"  data-scroll-to="#1-2-加载镜像"><span class="toc-text">1.2.加载镜像</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-3-运行"  data-scroll-to="#1-3-运行"><span class="toc-text">1.3.运行</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-部署kibana"  data-scroll-to="#2-部署kibana"><span class="toc-text">2.部署kibana</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-1-部署"  data-scroll-to="#2-1-部署"><span class="toc-text">2.1.部署</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-2-DevTools"  data-scroll-to="#2-2-DevTools"><span class="toc-text">2.2.DevTools</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-安装IK分词器"  data-scroll-to="#3-安装IK分词器"><span class="toc-text">3.安装IK分词器</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-1-在线安装ik插件（较慢）"  data-scroll-to="#3-1-在线安装ik插件（较慢）"><span class="toc-text">3.1.在线安装ik插件（较慢）</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-2-离线安装ik插件（推荐）"  data-scroll-to="#3-2-离线安装ik插件（推荐）"><span class="toc-text">3.2.离线安装ik插件（推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1）查看数据卷目录"  data-scroll-to="#1）查看数据卷目录"><span class="toc-text">1）查看数据卷目录</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2）解压缩分词器安装包"  data-scroll-to="#2）解压缩分词器安装包"><span class="toc-text">2）解压缩分词器安装包</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3）上传到es容器的插件数据卷中"  data-scroll-to="#3）上传到es容器的插件数据卷中"><span class="toc-text">3）上传到es容器的插件数据卷中</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4）重启容器"  data-scroll-to="#4）重启容器"><span class="toc-text">4）重启容器</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5）测试："  data-scroll-to="#5）测试："><span class="toc-text">5）测试：</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-3-扩展词词典"  data-scroll-to="#3-3-扩展词词典"><span class="toc-text">3.3 扩展词词典</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-4分词器"  data-scroll-to="#3-4分词器"><span class="toc-text">3.4分词器</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-索引库的操作-相当于Mysql对表的操作"  data-scroll-to="#4-索引库的操作-相当于Mysql对表的操作"><span class="toc-text">4.索引库的操作 (相当于Mysql对表的操作)</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-1-mapping属性-约束"  data-scroll-to="#4-1-mapping属性-约束"><span class="toc-text">4.1 mapping属性 (约束)</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2创建表-create-table"  data-scroll-to="#4-2创建表-create-table"><span class="toc-text">4.2创建表(create table)</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-3查询索引库-show-tables"  data-scroll-to="#4-3查询索引库-show-tables"><span class="toc-text">4.3查询索引库(show tables)</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-4删除索引库"  data-scroll-to="#4-4删除索引库"><span class="toc-text">4.4删除索引库</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-5总结"  data-scroll-to="#4-5总结"><span class="toc-text">4.5总结</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-文档操作"  data-scroll-to="#5-文档操作"><span class="toc-text">5.文档操作</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-1-新增文档"  data-scroll-to="#5-1-新增文档"><span class="toc-text">5.1 新增文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-2-查询文档"  data-scroll-to="#5-2-查询文档"><span class="toc-text">5.2 查询文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-3-删除文档"  data-scroll-to="#5-3-删除文档"><span class="toc-text">5.3 删除文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-6-修改文档"  data-scroll-to="#5-6-修改文档"><span class="toc-text">5.6 修改文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-RestAPI"  data-scroll-to="#6-RestAPI"><span class="toc-text">6.RestAPI</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-1初始化RestClient"  data-scroll-to="#6-1初始化RestClient"><span class="toc-text">6.1初始化RestClient</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-2创建索引库"  data-scroll-to="#6-2创建索引库"><span class="toc-text">6.2创建索引库</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-3删除索引库"  data-scroll-to="#6-3删除索引库"><span class="toc-text">6.3删除索引库</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-4查看索引库是否存在"  data-scroll-to="#6-4查看索引库是否存在"><span class="toc-text">6.4查看索引库是否存在</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#小结-1"  data-scroll-to="#小结-1"><span class="toc-text">小结:</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-5文档操作"  data-scroll-to="#6-5文档操作"><span class="toc-text">6.5文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-5-1插入文档"  data-scroll-to="#6-5-1插入文档"><span class="toc-text">6.5.1插入文档</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-5-1获取文档"  data-scroll-to="#6-5-1获取文档"><span class="toc-text">6.5.1获取文档</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-5-2更新文档"  data-scroll-to="#6-5-2更新文档"><span class="toc-text">6.5.2更新文档</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-5-3删除文档"  data-scroll-to="#6-5-3删除文档"><span class="toc-text">6.5.3删除文档</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-5-4批量插入"  data-scroll-to="#6-5-4批量插入"><span class="toc-text">6.5.4批量插入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#6-5-4-1语法说明"  data-scroll-to="#6-5-4-1语法说明"><span class="toc-text">6.5.4.1语法说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#6-6-小结"  data-scroll-to="#6-6-小结"><span class="toc-text">6.6.小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#DSL查询文档"  data-scroll-to="#DSL查询文档"><span class="toc-text">DSL查询文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-1DSL查询分类"  data-scroll-to="#1-1DSL查询分类"><span class="toc-text">1.1DSL查询分类</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-2全文检索查询"  data-scroll-to="#1-2全文检索查询"><span class="toc-text">1.2全文检索查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-1使用场景"  data-scroll-to="#1-2-1使用场景"><span class="toc-text">1.2.1使用场景</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-2基本语法"  data-scroll-to="#1-2-2基本语法"><span class="toc-text">1.2.2基本语法</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-2-3总结"  data-scroll-to="#1-2-3总结"><span class="toc-text">1.2.3总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-3精准查询"  data-scroll-to="#1-3精准查询"><span class="toc-text">1.3精准查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-1-term查询"  data-scroll-to="#1-3-1-term查询"><span class="toc-text">1.3.1 term查询</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-2-range查询"  data-scroll-to="#1-3-2-range查询"><span class="toc-text">1.3.2.range查询</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-3-3总结"  data-scroll-to="#1-3-3总结"><span class="toc-text">1.3.3总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-4地理坐标查询"  data-scroll-to="#1-4地理坐标查询"><span class="toc-text">1.4地理坐标查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-4-1-geo-biunding-box-矩形范围查询"  data-scroll-to="#1-4-1-geo-biunding-box-矩形范围查询"><span class="toc-text">1.4.1(geo_biunding_box)矩形范围查询.</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-4-2-geo-distance-圆环查询"  data-scroll-to="#1-4-2-geo-distance-圆环查询"><span class="toc-text">1.4.2(geo_distance)圆环查询</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-5复合查询"  data-scroll-to="#1-5复合查询"><span class="toc-text">1.5复合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-5-1算分函数查询"  data-scroll-to="#1-5-1算分函数查询"><span class="toc-text">1.5.1算分函数查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#）小结"  data-scroll-to="#）小结"><span class="toc-text">）小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#1-5-3-布尔查询-bool"  data-scroll-to="#1-5-3-布尔查询-bool"><span class="toc-text">1.5.3 布尔查询 bool</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3）小结"  data-scroll-to="#3）小结"><span class="toc-text">3）小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-搜索结果处理"  data-scroll-to="#2-搜索结果处理"><span class="toc-text">2.搜索结果处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-1排序"  data-scroll-to="#2-1排序"><span class="toc-text">2.1排序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-1普通字段排序"  data-scroll-to="#2-1-1普通字段排序"><span class="toc-text">2.1.1普通字段排序</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-1-2地理坐标排序"  data-scroll-to="#2-1-2地理坐标排序"><span class="toc-text">2.1.2地理坐标排序</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2分页"  data-scroll-to="#2-2分页"><span class="toc-text">2.2分页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-2基本的分页"  data-scroll-to="#2-2基本的分页"><span class="toc-text">2.2基本的分页</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2-2-3-小结"  data-scroll-to="#2-2-3-小结"><span class="toc-text">2.2.3.小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-3高亮"  data-scroll-to="#2-3高亮"><span class="toc-text">2.3高亮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3-1实现高亮"  data-scroll-to="#2-3-1实现高亮"><span class="toc-text">2.3.1实现高亮</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-RestClient查询文档"  data-scroll-to="#3-RestClient查询文档"><span class="toc-text">3.RestClient查询文档</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-数据聚合"  data-scroll-to="#4-数据聚合"><span class="toc-text">4.数据聚合</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-1聚合的种类"  data-scroll-to="#4-1聚合的种类"><span class="toc-text">4.1聚合的种类</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2DSL实现聚合"  data-scroll-to="#4-2DSL实现聚合"><span class="toc-text">4.2DSL实现聚合</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-2聚合结果排序"  data-scroll-to="#4-2-2聚合结果排序"><span class="toc-text">4.2.2聚合结果排序</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-3-限定聚合范围"  data-scroll-to="#4-2-3-限定聚合范围"><span class="toc-text">4.2.3.限定聚合范围</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-4Metric聚合"  data-scroll-to="#4-2-4Metric聚合"><span class="toc-text">4.2.4Metric聚合</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-5小结"  data-scroll-to="#4-2-5小结"><span class="toc-text">4.2.5小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#Sentinel"  data-scroll-to="#Sentinel"><span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-3-2-安装Sentinel"  data-scroll-to="#1-3-2-安装Sentinel"><span class="toc-text">1.3.2.安装Sentinel</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#1-4-微服务整合Sentinel"  data-scroll-to="#1-4-微服务整合Sentinel"><span class="toc-text">1.4.微服务整合Sentinel</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-流量控制"  data-scroll-to="#2-流量控制"><span class="toc-text">2.流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-1-簇点链路"  data-scroll-to="#2-1-簇点链路"><span class="toc-text">2.1.簇点链路</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-1流控模式"  data-scroll-to="#2-1流控模式"><span class="toc-text">2.1流控模式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2关联模式"  data-scroll-to="#2-2关联模式"><span class="toc-text">2.2关联模式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3链路模式"  data-scroll-to="#2-3链路模式"><span class="toc-text">2.3链路模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#添加流控规则"  data-scroll-to="#添加流控规则"><span class="toc-text">添加流控规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#添加流控规则-1"  data-scroll-to="#添加流控规则-1"><span class="toc-text">添加流控规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#6）Jmeter测试"  data-scroll-to="#6）Jmeter测试"><span class="toc-text">6）Jmeter测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-2-3-总结"  data-scroll-to="#2-2-3-总结"><span class="toc-text">2.2.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-3-流控效果"  data-scroll-to="#2-3-流控效果"><span class="toc-text">2.3.流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3-1-warm-up"  data-scroll-to="#2-3-1-warm-up"><span class="toc-text">2.3.1.warm up</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1）配置流控规则："  data-scroll-to="#1）配置流控规则："><span class="toc-text">1）配置流控规则：</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）Jmeter测试"  data-scroll-to="#2）Jmeter测试"><span class="toc-text">2）Jmeter测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-3-2-排队等待"  data-scroll-to="#2-3-2-排队等待"><span class="toc-text">2.3.2.排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）Jmeter测试-1"  data-scroll-to="#2）Jmeter测试-1"><span class="toc-text">2）Jmeter测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#2-4热点参数限流"  data-scroll-to="#2-4热点参数限流"><span class="toc-text">2.4热点参数限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-4-1-全局参数限流"  data-scroll-to="#2-4-1-全局参数限流"><span class="toc-text">2.4.1.全局参数限流</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-4-2-热点参数限流"  data-scroll-to="#2-4-2-热点参数限流"><span class="toc-text">2.4.2.热点参数限流</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#2-4-4-案例"  data-scroll-to="#2-4-4-案例"><span class="toc-text">2.4.4.案例</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#sentinelResource-标记资源"  data-scroll-to="#sentinelResource-标记资源"><span class="toc-text">@sentinelResource()标记资源</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1）标记资源"  data-scroll-to="#1）标记资源"><span class="toc-text">1）标记资源</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）热点参数限流规则"  data-scroll-to="#2）热点参数限流规则"><span class="toc-text">2）热点参数限流规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3）Jmeter测试"  data-scroll-to="#3）Jmeter测试"><span class="toc-text">3）Jmeter测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-1-FeignClient整合Sentinel"  data-scroll-to="#3-1-FeignClient整合Sentinel"><span class="toc-text">3.1.FeignClient整合Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-1-1-修改配置，开启sentinel功能"  data-scroll-to="#3-1-1-修改配置，开启sentinel功能"><span class="toc-text">3.1.1.修改配置，开启sentinel功能</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-1-2-编写失败降级逻辑"  data-scroll-to="#3-1-2-编写失败降级逻辑"><span class="toc-text">3.1.2.编写失败降级逻辑</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-1-3-总结"  data-scroll-to="#3-1-3-总结"><span class="toc-text">3.1.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-2-线程隔离（舱壁模式）"  data-scroll-to="#3-2-线程隔离（舱壁模式）"><span class="toc-text">3.2.线程隔离（舱壁模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-2-1-线程隔离的实现方式"  data-scroll-to="#3-2-1-线程隔离的实现方式"><span class="toc-text">3.2.1.线程隔离的实现方式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-2-2-sentinel的线程隔离"  data-scroll-to="#3-2-2-sentinel的线程隔离"><span class="toc-text">3.2.2.sentinel的线程隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1）配置隔离规则"  data-scroll-to="#1）配置隔离规则"><span class="toc-text">1）配置隔离规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）Jmeter测试-2"  data-scroll-to="#2）Jmeter测试-2"><span class="toc-text">2）Jmeter测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-2-3总结"  data-scroll-to="#3-2-3总结"><span class="toc-text">3.2.3总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#3-3熔断降级"  data-scroll-to="#3-3熔断降级"><span class="toc-text">3.3熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-3-1-慢调用"  data-scroll-to="#3-3-1-慢调用"><span class="toc-text">3.3.1.慢调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1）设置慢调用"  data-scroll-to="#1）设置慢调用"><span class="toc-text">1）设置慢调用</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）设置熔断规则"  data-scroll-to="#2）设置熔断规则"><span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3）测试"  data-scroll-to="#3）测试"><span class="toc-text">3）测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#3-3-2-异常比例、异常数"  data-scroll-to="#3-3-2-异常比例、异常数"><span class="toc-text">3.3.2.异常比例、异常数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1）设置异常请求"  data-scroll-to="#1）设置异常请求"><span class="toc-text">1）设置异常请求</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#2）设置熔断规则-1"  data-scroll-to="#2）设置熔断规则-1"><span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#3）测试-1"  data-scroll-to="#3）测试-1"><span class="toc-text">3）测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-授权规则"  data-scroll-to="#4-授权规则"><span class="toc-text">4.授权规则</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-1-授权规则"  data-scroll-to="#4-1-授权规则"><span class="toc-text">4.1.授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-1-1-基本规则"  data-scroll-to="#4-1-1-基本规则"><span class="toc-text">4.1.1.基本规则</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-1-2-如何获取origin"  data-scroll-to="#4-1-2-如何获取origin"><span class="toc-text">4.1.2.如何获取origin</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-1-3-给网关添加请求头"  data-scroll-to="#4-1-3-给网关添加请求头"><span class="toc-text">4.1.3.给网关添加请求头</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-1-4-配置授权规则"  data-scroll-to="#4-1-4-配置授权规则"><span class="toc-text">4.1.4.配置授权规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#4-2-自定义异常结果"  data-scroll-to="#4-2-自定义异常结果"><span class="toc-text">4.2.自定义异常结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-2-1-异常类型"  data-scroll-to="#4-2-1-异常类型"><span class="toc-text">4.2.1.异常类型</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#4-2-2-自定义异常处理"  data-scroll-to="#4-2-2-自定义异常处理"><span class="toc-text">4.2.2.自定义异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-规则持久化"  data-scroll-to="#5-规则持久化"><span class="toc-text">5.规则持久化</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-1-规则管理模式"  data-scroll-to="#5-1-规则管理模式"><span class="toc-text">5.1.规则管理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-1-1-pull模式"  data-scroll-to="#5-1-1-pull模式"><span class="toc-text">5.1.1.pull模式</span></a></li><li class="toc-item toc-level-3"><a rel="nofollow" class="toc-link" href="#5-1-2-push模式"  data-scroll-to="#5-1-2-push模式"><span class="toc-text">5.1.2.push模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#5-2-实现push模式"  data-scroll-to="#5-2-实现push模式"><span class="toc-text">5.2.实现push模式</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6、JSR303数字校验"  data-scroll-to="#6、JSR303数字校验"><span class="toc-text">6、JSR303数字校验</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-1-基本校验实现"  data-scroll-to="#6-1-基本校验实现"><span class="toc-text">6.1.基本校验实现</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-2、统一异常处理"  data-scroll-to="#6-2、统一异常处理"><span class="toc-text">6.2、统一异常处理</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#6-3分组校验功能"  data-scroll-to="#6-3分组校验功能"><span class="toc-text">6.3分组校验功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#Thymeleaf"  data-scroll-to="#Thymeleaf"><span class="toc-text">Thymeleaf</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a rel="nofollow" class="toc-link" href="#Redisson"  data-scroll-to="#Redisson"><span class="toc-text">Redisson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#可重入锁"  data-scroll-to="#可重入锁"><span class="toc-text">可重入锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-1-验证一：可重入锁是阻塞的吗？"  data-scroll-to="#1-1-验证一：可重入锁是阻塞的吗？"><span class="toc-text">1.1 验证一：可重入锁是阻塞的吗？</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#先验证第一个点，用两个-http-请求来测试抢占锁。"  data-scroll-to="#先验证第一个点，用两个-http-请求来测试抢占锁。"><span class="toc-text">先验证第一个点，用两个 http 请求来测试抢占锁。</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-2-验证二：服务停了，锁会释放吗？"  data-scroll-to="#1-2-验证二：服务停了，锁会释放吗？"><span class="toc-text">1.2 验证二：服务停了，锁会释放吗？</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#原理-看门狗"  data-scroll-to="#原理-看门狗"><span class="toc-text">原理 看门狗</span></a></li><li class="toc-item toc-level-4"><a rel="nofollow" class="toc-link" href="#1-3设置可重入锁的有效时间。"  data-scroll-to="#1-3设置可重入锁的有效时间。"><span class="toc-text">1.3设置可重入锁的有效时间。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#王者方案"  data-scroll-to="#王者方案"><span class="toc-text">王者方案</span></a></li><li class="toc-item toc-level-2"><a rel="nofollow" class="toc-link" href="#分布式读写锁"  data-scroll-to="#分布式读写锁"><span class="toc-text">分布式读写锁</span></a></li></ol></li></ol>
</div>
            </div>
        </div>
    
    </div>
</div>
                    <!-- main card end -->
                </div>
            
            <div class="col-lg-8">
                <div class="trm-content" id="trm-content">
                    <div data-scroll data-scroll-repeat data-scroll-offset="500" id="about-triger"></div>

                    <div class="row hidden-sm">
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="far fa-calendar-alt trm-icon"></i><br>
            10/22
        </div>
    </div>
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="far fa-clock trm-icon"></i><br>
            18:49
        </div>
    </div>
    <div class="col-sm-4">
        <div class="trm-card trm-label trm-label-light text-center">
            <i class="far fa-user trm-icon"></i><br>
            hello、小志
        </div>
    </div>
</div>
<div class="trm-card ">
    <article class="trm-publication">
    <h1 id="SpringCloud-章一"><a href="#SpringCloud-章一" class="headerlink" title="SpringCloud 章一"></a>SpringCloud 章一</h1><h2 id="1-微服务调用方式"><a href="#1-微服务调用方式" class="headerlink" title="1.微服务调用方式"></a>1.微服务调用方式</h2><p>基于RestTemplate发起的http请求实现远程调用</p>
<p>步骤: 1.将 RestTemplate 装入 IOC 容器 (springboot启动类就是配置类)    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemp</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.注入RestTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据 restTemplate 发起http请求</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/user/&quot;</span>+order.getUserId();</span><br><span class="line"> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br><span class="line"><span class="comment">//参数 1. url 地址 2. 返回类型 本是json，但是也可以直接封装成pojo对象</span></span><br></pre></td></tr></table></figure>

<h2 id="2-消费者与提供者"><a href="#2-消费者与提供者" class="headerlink" title="2.消费者与提供者"></a>2.消费者与提供者</h2><ul>
<li><p>服务提供者：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）</p>
</li>
<li><p>服务消费者：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</p>
<p>  <img src="/images/image-20220304094047697.png" alt="image-20220304094047697" loading="lazy"></p>
</li>
</ul>
<p>服务A调用服务B，服务B调用服务C，那么服务B是什么角色？    </p>
<p>服务调用关系<br>            服务提供者：暴露接口给其它微服务调用服务消费者：调用其它微服务提供的接口<br>    <strong>提供者与消费者角色其实是相对的<br>    一个服务可以同时是服务提供者和服务消费者</strong></p>
<h2 id="3-Eureka注册中心"><a href="#3-Eureka注册中心" class="headerlink" title="3.Eureka注册中心"></a>3.Eureka注册中心</h2><p>​    <img src="/images/image-20220304095723568.png" alt="image-20220304095723568" loading="lazy"></p>
<h3 id="3-1-eureka作用"><a href="#3-1-eureka作用" class="headerlink" title="3.1 eureka作用:"></a>3.1 eureka作用:</h3><p><strong>消费者该如何获取服务提供者具体信息？</strong></p>
<p>服务提供者启动时向eureka注册自己的信息</p>
<p>eureka保存这些信息消费者根据服务名称向eureka拉取提供者信息</p>
<p><strong>如果有多个服务提供者，消费者该如何选择？</strong></p>
<p>服务消费者利用负载均衡算法，从服务列表中挑选一个</p>
<p><strong>消费者如何感知服务提供者健康状态？</strong></p>
<p>服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态</p>
<p>eureka会更新记录服务列表信息，心跳不正常会被剔除</p>
<p>消费者就可以拉取到最新的信息</p>
<p>​                </p>
<h3 id="3-2-在Eurreka架构中，微服务角色有两类"><a href="#3-2-在Eurreka架构中，微服务角色有两类" class="headerlink" title="3.2 在Eurreka架构中，微服务角色有两类"></a>3.2 在Eurreka架构中，微服务角色有两类</h3><p><strong>EurekaServer:服务端，注册中心</strong></p>
<p>1.记录服务信息</p>
<p>2.心跳监控</p>
<p><strong>EurekaClient:客户端</strong></p>
<p>Provider:服务提供者,例如案例中的user-service        </p>
<p>consumer:服务消费者，例如案例中的order-service</p>
<p>1.根据服务名称从EurkaServer拉取服务列表</p>
<p>2.基于服务列表做负载均衡，选中一个微服务后发起远程调用。</p>
<p>​                            </p>
<h3 id="3-3-搭建注册中心-Eureka服务端"><a href="#3-3-搭建注册中心-Eureka服务端" class="headerlink" title="3.3.搭建注册中心(Eureka服务端):"></a>3.3.搭建注册中心(Eureka服务端):</h3><p>1创建maven项目，引入spring-cloud-starter-netflix-eureka-<strong>server</strong>的依赖    </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2在启动类上添加**@EnableEurekaServer**注解    </p>
<p>3添加application.yml文件，编写配置。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10086</span> <span class="comment">#服务端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span>	<span class="comment">#服务名称</span></span><br><span class="line">  	<span class="attr">name:</span> <span class="string">eurekaserver</span></span><br><span class="line"><span class="attr">eureka:</span>				</span><br><span class="line">  <span class="attr">client:</span>		</span><br><span class="line">	<span class="attr">service-url:</span>	<span class="comment">#eureka 地址信息 客户端地址 此时 eureka 会将自己注册到注册中心</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-注册客户端-user-service-oorder-service"><a href="#3-4-注册客户端-user-service-oorder-service" class="headerlink" title="3.4.注册客户端(user-service/oorder-service)"></a>3.4.注册客户端(user-service/oorder-service)</h3><p>1创建maven项目，引入spring-cloud-starter-netflix-eureka-<strong>client</strong>的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2在application.yml文件，编写下面的配置:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  	  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span>		</span><br><span class="line">	<span class="attr">service-url:</span>	<span class="comment"># 注册中心的地址，表明此服务需注册到注册中心</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></table></figure>
<p>  <strong>注册列表，通过eureka地址查看</strong></p>
<p><img src="/images/image-20220304113619138.png" alt="image-20220304113619138" loading="lazy"></p>
<p>同时运行多个模块  <strong>Ctrl+D</strong>   环境选项 -Dserver.port=xxxx </p>
<h3 id="3-5服务拉取"><a href="#3-5服务拉取" class="headerlink" title="3.5服务拉取"></a>3.5服务拉取</h3><p>在消费端(order-service)完成服务拉取</p>
<p>服务拉取基于<strong>服务名称</strong>获取服务列表，然后在对服务列表做负载均衡。</p>
<p>1.修改OrderService代码，用服务名代替ip、端口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://userserver/user/&quot;</span>+order.getUserId();</span><br></pre></td></tr></table></figure>

<p>2.在order-service 启动类的RestTemplate添加负载均衡注解：</p>
<h3 id="3-6-LoadBalanced负载均衡注解："><a href="#3-6-LoadBalanced负载均衡注解：" class="headerlink" title="3.6@LoadBalanced负载均衡注解："></a>3.6@LoadBalanced负载均衡注解：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span> <span class="comment">//配置负载均衡</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemp</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7搭建注册中心-服务注册-服务发现总结"><a href="#3-7搭建注册中心-服务注册-服务发现总结" class="headerlink" title="3.7搭建注册中心-服务注册-服务发现总结:"></a>3.7搭建注册中心-服务注册-服务发现总结:</h3><p><img src="/images/image-20220304131343444.png" alt="image-20220304131343444" loading="lazy"></p>
<h2 id="4-Ribbon负载均衡"><a href="#4-Ribbon负载均衡" class="headerlink" title="4.Ribbon负载均衡"></a>4.Ribbon负载均衡</h2><p><img src="/images/image-20220304134050006.png" alt="image-20220304134050006" loading="lazy"></p>
<p>Ribbon的负载均衡规则是一个叫做IRule的接口来定义的，每一个子接口都是一种规则：</p>
<p><img src="/images/image-20220304134235381.png" alt="image-20220304134235381" loading="lazy"></p>
<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><p>​        </p>
<table>
<thead>
<tr>
<th><strong>内置负载均衡规则类</strong></th>
<th><strong>规则描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>RoundRobinRule</td>
<td>简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>对以下两种服务器进行忽略： （1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。（2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也会将其忽略。并发连接数的上限，可以由客户端的<clientName>.<clientConfigNameSpace>.ActiveConnectionsLimit属性进行配置。</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td>
</tr>
<tr>
<td><strong>ZoneAvoidanceRule</strong></td>
<td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>忽略那些短路的服务器，并选择并发数较低的服务器。</td>
</tr>
<tr>
<td>RandomRule</td>
<td>随机选择一个可用的服务器。</td>
</tr>
<tr>
<td>RetryRule</td>
<td>重试机制的选择逻辑</td>
</tr>
</tbody></table>
<h2 id="修改负载均衡策略"><a href="#修改负载均衡策略" class="headerlink" title="修改负载均衡策略"></a>修改负载均衡策略</h2><p>方式一、</p>
<p> 代码方式:在order-service中的启动类中,定义一个新的IRule;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();	<span class="comment">//需要什么规则 就返回什么规则</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二、</p>
<p>application.yml文件中配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span> <span class="comment">#服务名</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span>  <span class="comment">#负载均衡规则</span></span><br></pre></td></tr></table></figure>

<p><strong>方式一 和 方式二 不同之处</strong> </p>
<pre><code>    方式一是全局策略，如果 消费端 有userservice 和 addressservice 等 都用此策略，

    方式二是针对某一种服务 如 userservice，就会从userservice服务列表中用此策略负载均衡。无法全局配置。
</code></pre>
<h2 id="饥饿加载"><a href="#饥饿加载" class="headerlink" title="饥饿加载"></a>饥饿加载</h2><pre><code>    Ribbon默认是采用懒加载，即第一次访问时才会去创建**LoadBalanceClient**，请求时间会很长。
而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：
</code></pre>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">userservice</span> <span class="comment">#服务名</span></span><br></pre></td></tr></table></figure>

<p>clients: 是一个list  如果想加载多个 可用 springboot 配置list 方式    - </p>
<h2 id="5-Nacos注册中心"><a href="#5-Nacos注册中心" class="headerlink" title="5.Nacos注册中心"></a>5.Nacos注册中心</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nacos是阿里巴巴的产品，现在是SpringCloud中的一个组件,相比Eureka功能更加丰富，在国内受欢迎程度较高。</span><br></pre></td></tr></table></figure>

<h3 id="5-1客户端注册到Nacos"><a href="#5-1客户端注册到Nacos" class="headerlink" title="5.1客户端注册到Nacos"></a>5.1客户端注册到Nacos</h3><pre><code>    cloud-demo父工程添加依赖
</code></pre>
<p>​        </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos 依赖管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<pre><code>    注释掉order-service和user-service中原有的eureka依赖。

    添加nacos的客户端依赖
</code></pre>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos客户端依赖包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改user-service&amp;order-service中的application.yml文件，注释eureka地址，添加nacos地址：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务地址</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220305102538998.png" alt="image-20220305102538998" loading="lazy"></p>
<h3 id="5-2Nacos分级存储模型"><a href="#5-2Nacos分级存储模型" class="headerlink" title="5.2Nacos分级存储模型"></a>5.2Nacos分级存储模型</h3><ol>
<li><pre><code>    一级是服务，例如userservice
</code></pre>
</li>
<li><pre><code>    二级是集群，例如杭州或上海
</code></pre>
</li>
<li><p>三级是实例，例如杭州机房的某台部署了userservice的服务器</p>
<pre><code>**服务调用尽可能选择本地集群的服务**，跨集群调用延迟较高
</code></pre>
<p>本地集群不可访问时，再去访问其它集群.</p>
</li>
</ol>
<p>如何设置实例的集群属性</p>
<p>在客户端 服务application.yml添加</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务地址</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">SY</span> <span class="comment">#集群名称 自定义 如 十偃 黄冈</span></span><br></pre></td></tr></table></figure>

<p>多个服务集群名称配置一致  即在一个集群。</p>
<p><img src="/images/image-20220305105922537.png" alt="image-20220305105922537" loading="lazy"></p>
<p><img src="/images/image-20220305105940231.png" alt="image-20220305105940231" loading="lazy"></p>
<p>如将order-service配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务地址</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">SY</span>	<span class="comment">#集群名称 </span></span><br></pre></td></tr></table></figure>

<p><strong>提供者</strong> user-service</p>
<p><img src="/images/image-20220305115009189.png" alt="image-20220305115009189" loading="lazy"></p>
<p><img src="/images/image-20220305115138346.png" alt="image-20220305115138346" loading="lazy"></p>
<p><strong>消费者</strong> order-service</p>
<p><img src="/images/image-20220305115040185.png" alt="image-20220305115040185" loading="lazy"></p>
<p>此时 order-service 和 user-service 8088 8087 同属一个集群(<strong>SY</strong>)。而 user-service 8080 属另一个集群(<strong>HG</strong>)。</p>
<p>配置负载均衡策略</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span>  <span class="comment">#负载均衡规则</span></span><br></pre></td></tr></table></figure>

<p><strong>NacosRule</strong>: <strong>order-service 会优先访问同一集群(SY)  user-service 8088 8087</strong>，<strong>如果同集群的提供者都不能访问，再会去访问其他集群(HG)。</strong></p>
<pre><code>             **集群内的提供者，随机访问**
</code></pre>
<h3 id="5-3NacosRule负载均衡策略"><a href="#5-3NacosRule负载均衡策略" class="headerlink" title="5.3NacosRule负载均衡策略"></a>5.3NacosRule负载均衡策略</h3><ul>
<li><strong>优先选择同集群服务实例列表</strong></li>
<li>本地集群找不到提供者，才去其它集群寻找，并且会报警告</li>
<li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li>
</ul>
<h3 id="5-4实例访问权重分配"><a href="#5-4实例访问权重分配" class="headerlink" title="5.4实例访问权重分配"></a>5.4实例访问权重分配</h3><pre><code>    **作用: 控制不同实例被访问的概率**,**Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高** **,根据权重负载均衡**

    服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求
</code></pre>
<p>1.在Nacos控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</p>
<p><img src="/images/image-20220305132712211.png" alt="image-20220305132712211" loading="lazy"></p>
<ol start="2">
<li>将 user-service 8087 权重设为 8087 ，大大降低了 order-service访问的概率</li>
</ol>
<p><img src="/images/image-20220305132749227.png" alt="image-20220305132749227" loading="lazy"></p>
<p><strong>权重设置为 0 ,该实例不再被访问。</strong></p>
<p><strong>实例的权重控制</strong><br>    Nacos控制台可以设置实例的权重值，0~1之间<br>    同集群内的多个实例，<strong>权重越高被访问的频率越高</strong><br>    权重设置为0则完全不会被访问</p>
<h3 id="5-5环境隔离-namespace"><a href="#5-5环境隔离-namespace" class="headerlink" title="5.5环境隔离 - namespace"></a>5.5环境隔离 - namespace</h3><pre><code>    **Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离**
</code></pre>
<p><img src="/images/image-20220305133119942.png" alt="image-20220305133119942" loading="lazy"></p>
<p><strong>作用: 用来隔离不同环境,不同环境实例不能相互访问</strong></p>
<p><strong>默认是public</strong></p>
<p><img src="/images/image-20220305133756634.png" alt="image-20220305133756634" loading="lazy"></p>
<p>此时配置 新建一个namespace  hello 并配置 orderservice的namespace</p>
<p><img src="/images/image-20220305133907756.png" alt="image-20220305133907756" loading="lazy"></p>
<p><img src="/images/image-20220305134016860.png" alt="image-20220305134016860" loading="lazy"></p>
<p>配置orderservice namespace</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务地址</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">SY</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">b1d8093f-92d5-4628-9553-27ff1253d974</span> <span class="comment">#命名空间 ID</span></span><br></pre></td></tr></table></figure>

<p>重启 orderservice，此时会发现 orderservice 在 hello 下,不在 public 下</p>
<p><img src="/images/image-20220305140248557.png" alt="image-20220305140248557" loading="lazy"></p>
<p><strong>再此通过浏览器访问会发现 orderservice 访问不了 userservice。</strong> <strong>orderservice 和 userservic 阴阳两隔。</strong></p>
<p><strong>此时访问order-service，因为namespace不同，会导致找不到userservice，控制台会报错：</strong></p>
<p><img src="/images/image-20220305140327392.png" alt="image-20220305140327392" loading="lazy"></p>
<pre><code>Nacos环境隔离
    **每个namespace都有唯一id
    服务设置namespace时要写id而不是名称
    不同namespace下的服务互相不可见**
</code></pre>
<p><img src="/images/image-20220305140516292.png" alt="image-20220305140516292" loading="lazy"></p>
<p>nacos配置隔离，配置namespace即可。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">xxxx</span></span><br></pre></td></tr></table></figure>

<h3 id="5-6临时实例、和非临时实例"><a href="#5-6临时实例、和非临时实例" class="headerlink" title="5.6临时实例、和非临时实例"></a>5.6临时实例、和非临时实例</h3><pre><code>    **Nacos 默认实例都是临时实例。**

    ![image-20220305140653179](/images/image-20220305140653179.png)

    **服务注册到Nacos时，可以选择注册为临时或非临时实例，通过下面的配置来设置：**

    ephemeral: false # 设置为非临时实例                
</code></pre>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务地址</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">SY</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">b1d8093f-92d5-4628-9553-27ff1253d974</span> <span class="comment">#命名空间 ID</span></span><br><span class="line">      <span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment"># 设置为非临时实例</span></span><br></pre></td></tr></table></figure>

<pre><code>    **临时实例和非临时实例的区别:**

        1.**临时实例宕机时，会从nacos的服务列表中剔除，而非临时实例则不会**

        **2.临时实例采用心跳模式(实例向Nacos注册中心,发送心跳,表示自己还活着)，非临时实例采用主动检测模式(Nacos注册中心向实例询问是否还活着),非临时实例开销较大**
</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="1-Nacos与eureka的共同点"><a href="#1-Nacos与eureka的共同点" class="headerlink" title="1.Nacos与eureka的共同点"></a>1.Nacos与eureka的共同点</h4><ul>
<li><strong>都支持服务注册和服务拉取</strong></li>
<li><strong>都支持服务提供者心跳方式做健康检测</strong></li>
</ul>
<h4 id="2-Nacos与Eureka的区别"><a href="#2-Nacos与Eureka的区别" class="headerlink" title="2.Nacos与Eureka的区别"></a>2.Nacos与Eureka的区别</h4><ul>
<li><strong>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</strong></li>
<li><strong>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</strong></li>
<li><strong>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时，Eureka每隔30s推送一次，如果这期间有实例挂了，服务列表更新不及时。</strong></li>
<li><strong>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</strong>            </li>
</ul>
<h1 id="SpringCloud-章二"><a href="#SpringCloud-章二" class="headerlink" title="SpringCloud 章二"></a>SpringCloud 章二</h1><h2 id="1-Nacos配置管理"><a href="#1-Nacos配置管理" class="headerlink" title="1.Nacos配置管理"></a>1.Nacos配置管理</h2><h3 id="1-1-服务配置更改热更新"><a href="#1-1-服务配置更改热更新" class="headerlink" title="1.1  服务配置更改热更新"></a>1.1  服务配置更改热更新</h3><p><img src="/images/image-20220305144156562.png" alt="image-20220305144156562" loading="lazy"></p>
<p>服务运行时，无需关闭修改配置。Nacos配置管理，修改配置后会通知对应服务读取配置。</p>
<p>不是将所对应的application.yml中的配置信息都填写,只需将经常需要修改的信息，填写。</p>
<h3 id="1-2从微服务拉取配置"><a href="#1-2从微服务拉取配置" class="headerlink" title="1.2从微服务拉取配置"></a>1.2从微服务拉取配置</h3><p>但如果尚未读取application.yml，又如何得知nacos地址呢？</p>
<p>因此spring引入了一种新的配置文件：<strong>bootstrap.yaml</strong>文件，会在application.yml<strong>之前</strong>被读取，流程如下：</p>
<p><img src="/images/image-20220305171624015.png" alt="image-20220305171624015" loading="lazy"></p>
<p>1）引入nacos-config依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--让bootstrap.yml生效 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）添加bootstrap.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span>	<span class="comment">#环境名称，这里是dev 	</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> 	<span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment"># 指定了读取配置文件的格式</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>	</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<pre><code>    也就是需要和配置中心里的配置文件名字对应

    ![image-20220305172024985](/images/image-20220305172024985.png)
</code></pre>
<p>本例中，就是去读取<code>userservice-dev.yaml</code>：</p>
<p><img src="/images/image-20220305172059690.png" alt="image-20220305172059690" loading="lazy"></p>
<p>配置</p>
<p><img src="/images/image-20220409164448484.png" alt="image-20220409164448484" loading="lazy"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.66</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment">#配置多个配置</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">fea17521-3aa0-4ca8-ac35-a1bc67a5819a</span> <span class="comment">#命名空间</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">other.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">dev</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span> <span class="comment">#是否自动刷新</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">mybatis.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">dev</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">datasource.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">dev</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong> </p>
<p>小坑</p>
<ul>
<li>单个文件：<ul>
<li>name：必须要带<code>.yaml</code></li>
<li>file-extension： 必须是<code>yaml</code>，不可以是<code>yml</code></li>
</ul>
</li>
<li>多个文件：<ul>
<li>nacos上面Data ID必须带上<code>.yaml</code></li>
<li>配置文件中的dataId也要带上<code>.yaml</code></li>
</ul>
</li>
</ul>
<p>3）读取nacos配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入nacos中的配置属性</span></span><br><span class="line"><span class="meta">@Value(value=&quot;$&#123;pattern.dateformat&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String dateformat;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/now&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getNow</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(dateformat);</span><br><span class="line">    <span class="keyword">return</span> format.format(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果</strong></p>
<p><img src="/images/image-20220305172217750.png" alt="image-20220305172217750" loading="lazy"></p>
<h3 id="1-3-配置热更新"><a href="#1-3-配置热更新" class="headerlink" title="1.3.配置热更新"></a>1.3.配置热更新</h3><h4 id="方式一、-RefreshScope"><a href="#方式一、-RefreshScope" class="headerlink" title="方式一、@RefreshScope"></a>方式一、@RefreshScope</h4><p>在@Value注入的变量所在类上添加**@RefreshScope**注解        </p>
<p><img src="/images/image-20220305174143549.png" alt="image-20220305174143549" loading="lazy"></p>
<h4 id="方式二、使用-ConfigurationProperties注解代替-Value注解。"><a href="#方式二、使用-ConfigurationProperties注解代替-Value注解。" class="headerlink" title="方式二、使用@ConfigurationProperties注解代替@Value注解。"></a>方式二、使用@ConfigurationProperties注解代替@Value注解。</h4><pre><code>    在user-service服务中，添加一个类，读取patterrn.dateformat属性：
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PatternProperties</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String dateformat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">PatternProperties properties;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/toNow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDateformat</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(properties.getDateformat());</span><br><span class="line">    <span class="keyword">return</span> format.format(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">将配置交给Nacos管理的步骤</span><br><span class="line">在Nacos中添加配置文件</span><br><span class="line">在微服务中引入nacos的config依赖</span><br><span class="line">在微服务中添加bootstrap.yml，配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件</span><br></pre></td></tr></table></figure>

<p>nacos 里面可以创建多个命名空间，一个命名空间里面可以分多个组</p>
<p>服务发现和配置文件可以在不同组。</p>
<h3 id="1-4多环境配置共享"><a href="#1-4多环境配置共享" class="headerlink" title="1.4多环境配置共享"></a>1.4多环境配置共享</h3><pre><code>    微服务启动时会从nacos读取多个配置文件:
</code></pre>
<ul>
<li><code>[服务名]-[环境名].yaml</code>，例如：userservice-dev.yaml</li>
<li><code>[服务名].yaml</code>，例如：userservice.yaml</li>
</ul>
<p>而[spring.application.name].yaml 不包含环境,因此可以被多个环境共享。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment"># 指定了读取配置文件的格式</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure>

<p>例如 服务一： active ：test</p>
<pre><code>     服务二:    active:   dev
</code></pre>
<p>其他均相同,那么这两个服务均加载 userservice.yaml ,因此共享配置可以写入此文件中。</p>
<p>[spring.application.name].yaml 一定会被加载。</p>
<p>而userservice-dev.yaml 只会被 服务二加载。</p>
<h3 id="1-5多种配置优先级"><a href="#1-5多种配置优先级" class="headerlink" title="1.5多种配置优先级"></a>1.5多种配置优先级</h3><p><img src="/images/image-20220306100924283.png" alt="image-20220306100924283" loading="lazy"></p>
<p>也就是: 当 userservice-dev.yaml 、userservice.yaml、application.yaml中有<strong>相同配置时</strong>， userservice-dev.yaml 优先级 &gt; userservice.yaml &gt;  application.yaml</p>
<h3 id="1-6Nacos集群搭建"><a href="#1-6Nacos集群搭建" class="headerlink" title="1.6Nacos集群搭建"></a>1.6Nacos集群搭建</h3><pre><code>略
</code></pre>
<h2 id="2-http客户端Feign-远程调用"><a href="#2-http客户端Feign-远程调用" class="headerlink" title="2.http客户端Feign(远程调用)"></a>2.http客户端Feign(远程调用)</h2><pre><code>先来看我们以前利用RestTemplate发起远程调用的代码：
</code></pre>
<p><img src="F:\BaiduNetdiskDownload\day02-SpringCloud02\讲义\assets\image-20210714174814204.png" alt="image-20210714174814204" loading="lazy"></p>
<p>存在下面的问题：</p>
<p>•代码可读性差，编程体验不统一</p>
<p>•参数复杂URL难以维护</p>
<h3 id="2-1-Feign替代RestTemplate"><a href="#2-1-Feign替代RestTemplate" class="headerlink" title="2.1.Feign替代RestTemplate"></a>2.1.Feign替代RestTemplate</h3><h4 id="2-1-1-引入依赖"><a href="#2-1-1-引入依赖" class="headerlink" title="2.1.1.引入依赖"></a>2.1.1.引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Feign远程调用依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-EnableFeignClients在启动类上开启Feign的功能"><a href="#2-1-2-EnableFeignClients在启动类上开启Feign的功能" class="headerlink" title="2.1.2.@EnableFeignClients在启动类上开启Feign的功能"></a>2.1.2.@EnableFeignClients在启动类上开启Feign的功能</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>**@EnableFeignClients 会取扫描加了@FeignClient(&quot;userservice&quot;) 注解的类，并将其存入ioc容器中,默认扫描同包和及其子包。**
</code></pre>
<h4 id="2-1-3-编写Feign的客户端"><a href="#2-1-3-编写Feign的客户端" class="headerlink" title="2.1.3.编写Feign的客户端"></a>2.1.3.编写Feign的客户端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span> 	<span class="comment">//nacos中的需要访问的服务名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">        <span class="meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">        User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个客户端主要是基于SpringMVC的注解来声明远程调用的信息，比如：</p>
<ul>
<li>服务名称：userservice</li>
<li>请求方式：GET</li>
<li>请求路径：/user/{id}</li>
<li>请求参数：Long id</li>
<li>返回值类型：User</li>
</ul>
<p>这样，Feign就可以帮助我们发送http请求，无需自己使用RestTemplate来发送了。</p>
<h4 id="2-1-4-测试使用-UserClient访问-userservice服务"><a href="#2-1-4-测试使用-UserClient访问-userservice服务" class="headerlink" title="2.1.4.测试使用 UserClient访问 userservice服务"></a>2.1.4.测试使用 UserClient访问 userservice服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> UserClient userClient;</span><br><span class="line"> <span class="meta">@GetMapping(&quot;&#123;orderId&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> Order <span class="title function_">queryOrderByUserId</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> Long orderId)</span> &#123;</span><br><span class="line">     <span class="comment">// 根据id查询订单并返回</span></span><br><span class="line">     <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.queryOrderById(orderId);</span><br><span class="line">     <span class="comment">//根据 restTemplate 发起http请求</span></span><br><span class="line">     <span class="comment">/*String url = &quot;http://userservice/user/&quot;+order.getUserId();</span></span><br><span class="line"><span class="comment">     User user = restTemplate.getForObject(url, User.class);*/</span></span><br><span class="line">     <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findById(order.getUserId());</span><br><span class="line">     <span class="comment">//封装user</span></span><br><span class="line">     order.setUser(user);</span><br><span class="line">     <span class="keyword">return</span> order;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>Feign 调用 如果有参数 就 加上 RequestParam 或者用 @PathVariable 否则报错，调用方式有问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/order/usernb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getname</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span>;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/usernb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getname</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-生产实践问题"><a href="#2-2-生产实践问题" class="headerlink" title="2.2 生产实践问题"></a>2.2 生产实践问题</h3><p>​            </p>
<p>所谓最近实践，就是使用过程中总结的经验，最好的一种使用方式。</p>
<p>自习观察可以发现，Feign的客户端与服务提供者的controller代码非常相似：</p>
<p>feign客户端：</p>
<p><img src="/images/image-20220307095614667.png" alt="image-20220307095614667" loading="lazy"></p>
<p>UserController:</p>
<p><img src="/images/image-20220307095644094.png" alt="image-20220307095644094" loading="lazy"></p>
<p>有没有一种办法简化这种重复的代码编写呢？</p>
<p>2.2.1.继承方式</p>
<p>一样的代码可以通过继承来共享：</p>
<p>1）定义一个API接口，利用定义方法，并基于SpringMVC注解做声明。</p>
<p>2）Feign客户端和Controller都集成改接口</p>
<p><img src="F:\BaiduNetdiskDownload\day02-SpringCloud02\讲义\assets\image-20210714190640857.png" alt="image-20210714190640857" loading="lazy"></p>
<p>优点：</p>
<ul>
<li>简单</li>
<li>实现了代码共享</li>
</ul>
<p>缺点：</p>
<ul>
<li><p>服务提供方、服务消费方紧耦合</p>
</li>
<li><p>参数列表中的注解映射并不会继承，因此Controller中必须再次声明方法、参数列表、注解</p>
</li>
</ul>
<h3 id="2-2-2抽取方式"><a href="#2-2-2抽取方式" class="headerlink" title="2.2.2抽取方式"></a>2.2.2抽取方式</h3><p>将Feign的Client抽取为独立模块，并且把接口有关的POJO、默认的Feign配置都放到这个模块中，提供给所有消费者使用。</p>
<p>例如，将UserClient、User、Feign的默认配置都抽取到一个feign-api包中，所有微服务引用该依赖包，即可直接使用。</p>
<p><img src="/images/image-20220307100009898.png" alt="image-20220307100009898" loading="lazy"></p>
<h3 id="2-2-3实现基于抽取的最佳实践"><a href="#2-2-3实现基于抽取的最佳实践" class="headerlink" title="2.2.3实现基于抽取的最佳实践"></a>2.2.3实现基于抽取的最佳实践</h3><p>1.创建一个module 命名为feign-api:</p>
<p>2.引入feign的starter依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.将 order-service中编写的UserClient、User复制到feign-api中,并将order-service相关删除。</p>
<p><img src="/images/image-20220307100437206.png" alt="image-20220307100437206" loading="lazy"></p>
<p>4.在order-service中使用feign-api</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入自定义的 feign-api--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5.重启测试</p>
<p><img src="/images/image-20220307100630861.png" alt="image-20220307100630861" loading="lazy"></p>
<p>重启后，发现服务报错了:</p>
<pre><code>        这是因为UserClient 现在在 feign-api 的 clients包下，
</code></pre>
<p>而order-service的@EnableFeignClients注解是在cn.itcast.order包下，不在同一个包，无法扫描到UserClient。</p>
<p>解决扫描包问题</p>
<p>方式一:</p>
<pre><code>指定Feign应该扫描的包：
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;cn.itcast.feign.clients&quot;)</span></span><br></pre></td></tr></table></figure>

<p>方式二:</p>
<pre><code>指定需要加载的Client接口：
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(clients = &#123;UserClient.class&#125;)</span></span><br></pre></td></tr></table></figure>



<h2 id="3-统一网关Gateway"><a href="#3-统一网关Gateway" class="headerlink" title="3.统一网关Gateway"></a>3.统一网关Gateway</h2><h3 id="3-1-为什么需要网关"><a href="#3-1-为什么需要网关" class="headerlink" title="3.1.为什么需要网关"></a>3.1.为什么需要网关</h3><pre><code>    Gateway网关是我们服务的守门神，所有微服务的统一入口。
</code></pre>
<p>网关的<strong>核心功能特性</strong>：</p>
<ul>
<li>请求路由</li>
<li>权限控制</li>
<li>限流</li>
</ul>
<p>架构图:</p>
<p><img src="/images/image-20220307104046608.png" alt="image-20220307104046608" loading="lazy"></p>
<p><strong>权限控制</strong>：网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。</p>
<p><strong>路由和负载均衡</strong>：一切请求都必须先经过gateway，但网关不处理业务，而是根据某种规则，把请求转发到某个微服务，这个过程叫做路由。当然路由的目标服务有多个时，还需要做负载均衡。</p>
<p><strong>限流</strong>：当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大。</p>
<p>在SpringCloud中网关的实现包括两种：</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloudGateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。</p>
<h3 id="3-2-gateway快速入门"><a href="#3-2-gateway快速入门" class="headerlink" title="3.2.gateway快速入门"></a>3.2.gateway快速入门</h3><pre><code>    1.创建模块 gateway

    2.引入依赖
</code></pre>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacos服务发现依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<pre><code>3.编写application.yml配置
</code></pre>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span> <span class="comment">#网关服务端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> <span class="comment"># 路由id，自定义保证唯一即可。</span></span><br><span class="line">          <span class="comment">#uri : http://127.0.0.1:8081  #路由的目标地址就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span> <span class="comment">#路由的目标地址 lb 就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span>           <span class="comment">#路由断言，也就是判断 请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#这个是按照路径匹配 只要以/user/开头就符合要求</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">orderservice</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orderservice</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br></pre></td></tr></table></figure>

<pre><code>    网关将符合Path规则的一切请求,都代理到 uri 参数指定的地址。

    本例中，我们将 `/user/**`开头的请求，代理到`lb://userservice`，lb是负载均衡，根据服务名拉取服务列表，实现负载均衡。
</code></pre>
<p><a target="_blank" rel="noopener" href="http://localhost:10010/order/103">http://localhost:10010/order/103</a></p>
<p><img src="/images/image-20220307111648337.png" alt="image-20220307111648337" loading="lazy"></p>
<p><strong>网关路由的流程图</strong></p>
<p><img src="/images/image-20220307111721881.png" alt="image-20220307111721881" loading="lazy"></p>
<p>3.3总结:</p>
<p>网关搭建步骤:</p>
<pre><code>1.创建模块，引入依赖

2.配置application.yml ,包括服务基本信息、nacos地址、路由配置包括:

                1.路由id： 路由唯一标识

                2.路由目标(uri):路由的目标地址，http代表固定地址，lb代表根据服务名负载均衡。

                3.路由断言(predicate): 判断路由的规则

                4.路由过滤器(filters): 对请求或响应做处理
</code></pre>
<p>接下来，就重点来学习路由断言和路由过滤器的详细知识</p>
<h3 id="3-3断言-访问规则-工厂"><a href="#3-3断言-访问规则-工厂" class="headerlink" title="3.3断言(访问规则)工厂"></a>3.3断言(访问规则)工厂</h3><p>我们在配置文件中写的断言规则只是字符串，这些字符串会被Predicate Factory读取并处理，转变为路由判断的条件</p>
<p>例如Path=/user/**是按照路径匹配，这个规则是由</p>
<p><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code>类来</p>
<p>处理的，像这样的断言工厂在SpringCloudGateway还有十几个:</p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td>After</td>
<td>是某个时间点后的请求</td>
<td>-  After=2037-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Before</td>
<td>是某个时间点之前的请求</td>
<td>-  Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td>
</tr>
<tr>
<td>Between</td>
<td>是某两个时间点之前的请求</td>
<td>-  Between=2037-01-20T17:42:47.789-07:00[America/Denver],  2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Cookie</td>
<td>请求必须包含某些cookie</td>
<td>- Cookie=chocolate, ch.p</td>
</tr>
<tr>
<td>Header</td>
<td>请求必须包含某些header</td>
<td>- Header=X-Request-Id, \d+</td>
</tr>
<tr>
<td>Host</td>
<td>请求必须是访问某个host（域名）</td>
<td>-  Host=<strong>.somehost.org,</strong>.anotherhost.org</td>
</tr>
<tr>
<td>Method</td>
<td>请求方式必须是指定方式</td>
<td>- Method=GET,POST</td>
</tr>
<tr>
<td><strong>Path</strong></td>
<td><strong>请求路径必须符合指定规则</strong></td>
<td><strong>- Path=/red/{segment},/blue/</strong>**</td>
</tr>
<tr>
<td>Query</td>
<td>请求参数必须包含指定参数</td>
<td>- Query=name, Jack或者-  Query=name</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>请求者的ip必须是指定范围</td>
<td>- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td>Weight</td>
<td>权重处理</td>
<td></td>
</tr>
</tbody></table>
<p>我们只需要掌握Path这种路由工程就可以了。Path 匹配多个路径中间用逗号隔开。</p>
<h3 id="3-4-请求过滤器工厂"><a href="#3-4-请求过滤器工厂" class="headerlink" title="3.4.请求过滤器工厂"></a>3.4.请求过滤器工厂</h3><p>GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理：</p>
<p><img src="/images/image-20220307130025204.png" alt="image-20220307130025204" loading="lazy"></p>
<p><strong>简单概括: 请求经过Gateway时，对请求信息进行一系列操作。然后到达各个服务。</strong></p>
<h4 id="3-4-1-路由过滤器"><a href="#3-4-1-路由过滤器" class="headerlink" title="3.4.1.路由过滤器"></a>3.4.1.路由过滤器</h4><p>Spring提供了31种不同的路由过滤器工厂。例如：</p>
<p>种类</p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>AddRequestHeader</td>
<td>给当前请求添加一个请求头</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求中的一个请求头</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>给响应结果中添加一个响应头</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>从响应结果中移除有一个响应头</td>
</tr>
<tr>
<td>RequestRateLimiter</td>
<td>限制请求的流量</td>
</tr>
</tbody></table>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> </span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://userservice</span> </span><br><span class="line">        <span class="attr">predicates:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/user/**</span> </span><br><span class="line">        <span class="attr">filters:</span> <span class="comment"># 过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=hello,</span> <span class="string">liweihaoshuai</span> <span class="comment"># 添加请求头信息</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//order-service</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getNow</span><span class="params">(<span class="meta">@RequestHeader(&quot;HELLO&quot;)</span> String hello)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hello;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220307132634048.png" alt="image-20220307132634048" loading="lazy"></p>
<h4 id="3-4-2-默认过滤器default-filters"><a href="#3-4-2-默认过滤器default-filters" class="headerlink" title="3.4.2.默认过滤器default-filters"></a>3.4.2.默认过滤器default-filters</h4><pre><code>对所有的路由都生效。
</code></pre>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> </span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://userservice</span> </span><br><span class="line">        <span class="attr">predicates:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/user/**</span></span><br><span class="line">        <span class="comment">#filters:  这个只对userservice有效</span></span><br><span class="line">        <span class="comment">#- AddRequestHeader=hello, liweihaoshuai # 添加请求头</span></span><br><span class="line">      <span class="attr">default-filters:</span> <span class="comment"># 默认过滤项</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">AddRequestHeader=Truth,</span> <span class="string">liwei</span> <span class="string">is</span> <span class="string">freaking</span> <span class="string">awesome!</span> </span><br></pre></td></tr></table></figure>

<pre><code>    添加默认过滤器后只要 访问经过网关对所有的路由都有效
</code></pre>
<p>orderservice</p>
<p><img src="/images/image-20220307133600588.png" alt="image-20220307133600588" loading="lazy"></p>
<p>userservice</p>
<p><img src="/images/image-20220307133624282.png" alt="image-20220307133624282" loading="lazy"></p>
<h4 id="3-4-3-总结"><a href="#3-4-3-总结" class="headerlink" title="3.4.3.总结"></a>3.4.3.总结</h4><p>过滤器的作用是什么？</p>
<p>① 对路由的请求或响应做加工处理，比如添加请求头</p>
<p>② 配置在路由下的过滤器只对当前路由的请求生效</p>
<p>defaultFilters的作用是什么？</p>
<p>① 对所有路由都生效的过滤器</p>
<h4 id="3-4-4全局过滤器GlobalFilter"><a href="#3-4-4全局过滤器GlobalFilter" class="headerlink" title="3.4.4全局过滤器GlobalFilter"></a>3.4.4全局过滤器GlobalFilter</h4><p>上面那些过滤器的作用都是固定死的，如果我们希望拦截请求，做自己的业务则没办法实现。</p>
<p>作用:  也是处理一切进入网关的请求和微服务响应，与GatewayFilter作用一样</p>
<p>，区别在于GlobalFilter的逻辑需要自己代码实现。</p>
<h5 id="3-4-4-1定义方式是实现GlobalFilter接口"><a href="#3-4-4-1定义方式是实现GlobalFilter接口" class="headerlink" title="3.4.4.1定义方式是实现GlobalFilter接口"></a>3.4.4.1定义方式是实现GlobalFilter接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//@Order(1) // 设置执行顺序  数字越小优先级越大</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//获取请求参数</span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; queryParams =</span><br><span class="line">                exchange.getRequest().getQueryParams();</span><br><span class="line">        <span class="comment">//获取 username参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> queryParams.getFirst(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(username))&#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 否则  拦截</span></span><br><span class="line">        <span class="comment">//设置状态码</span></span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">//设置执行顺序</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加到springIOC容器 </p>
<p>@Component</p>
<h5 id="3-4-4-2设置执行顺序-Order注解-实现-Ordered接口"><a href="#3-4-4-2设置执行顺序-Order注解-实现-Ordered接口" class="headerlink" title="3.4.4.2设置执行顺序 @Order注解  实现 Ordered接口"></a>3.4.4.2设置执行顺序 @Order注解  实现 Ordered接口</h5><p>因为可能有很多过滤器，因此需要设置过滤器的执行顺序，执行顺序设置有两种方式:</p>
<pre><code>一、在实现GlobalFilter接口的类上 加上@Order注解

二、实现GlobaFilter接口的同时,实现 Ordered接口
</code></pre>
<h3 id="3-5-过滤器执行顺序"><a href="#3-5-过滤器执行顺序" class="headerlink" title="3.5.过滤器执行顺序"></a>3.5.过滤器执行顺序</h3><p>请求进入网关会碰到三类过滤器：当前路由的过滤器、DefaultFilter、GlobalFilter</p>
<p>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter，合并到一个过滤器链（集合）中，排序后依次执行每个过滤器：</p>
<p><img src="/images/image-20220307142937197.png" alt="image-20220307142937197" loading="lazy"></p>
<p>排序的规则是什么?</p>
<ul>
<li>每一个过滤器都必须指定一个int类型的order值，order值越小，优先级越高，执行顺序越靠前。</li>
<li>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定</li>
<li>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。</li>
<li>当过滤器的order值一样时，会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行。</li>
</ul>
<h3 id="3-6-跨域问题"><a href="#3-6-跨域问题" class="headerlink" title="3.6.跨域问题"></a>3.6.跨域问题</h3><p>3.6.1.什么是跨域问题</p>
<p>跨域:域名不一致就是跨域，主要包括:</p>
<pre><code>            域名不同: www.taobao.com 和 3.6.1.什么是跨域问题www.jd.com等

            域名相同: 端口不同:localhost:8080和localhost8081
</code></pre>
<p><strong>跨域问题:浏览器禁止请求的发起者与服务端发生跨域 ajax 请求，请求被拦截的问题。</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment"># 全局的跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 解决options请求被拦截问题</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="comment"># 允许哪些网站的跨域请求</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://localhost:8090&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://www.leyou.com&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220307153200006.png" alt="image-20220307153200006" loading="lazy"></p>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="1-啥是Docker"><a href="#1-啥是Docker" class="headerlink" title="1.啥是Docker"></a>1.啥是Docker</h2><h3 id="1-1解决依赖兼容问题"><a href="#1-1解决依赖兼容问题" class="headerlink" title="1.1解决依赖兼容问题"></a>1.1解决依赖兼容问题</h3><pre><code>    例如一个项目中，部署时需要依赖于node.js、Redis、RabbitMQ、MySQL等，这些服务部署时所需要的函数库、依赖项各不相同，甚至会有冲突。给部署带来了极大的困难。
</code></pre>
<p>Docker为了解决依赖的兼容问题的，采用了两个手段：</p>
<ul>
<li><p><strong>将应用的Libs（函数库）、Deps（依赖）、配置与应用一起打包</strong></p>
</li>
<li><p>将每个应用放到一个隔离<strong>容器</strong>去运行，避免互相干扰</p>
</li>
</ul>
<p><img src="/images/image-20220308125859983.png" alt="image-20220308125859983" loading="lazy"></p>
<h3 id="1-2-Docker解决操作系统环境差异"><a href="#1-2-Docker解决操作系统环境差异" class="headerlink" title="1.2.Docker解决操作系统环境差异"></a>1.2.Docker解决操作系统环境差异</h3><p><img src="/images/image-20220308130305549.png" alt="image-20220308130305549" loading="lazy"></p>
<p>像Centos、Ubuntu 不同操作系统存在环境差异问题，但都是基于Linux内核,每个操作系统都是由其对应的函数库去调用Linux内核，然后内核调用计算机硬件。</p>
<p>Docker如何解决不同系统环境的问题？</p>
<ul>
<li><strong>Docker将用户程序与所需要调用的系统(比如Ubuntu)函数库一起打包</strong></li>
<li>Docker运行到不同操作系统时，直接基于打包的函数库，借助于操作系统的Linux内核来运行</li>
</ul>
<p>小结:</p>
<p>Docker如何解决大型项目依赖关系复杂，不同组件依赖的兼容性问题？</p>
<ul>
<li><p>Docker允许开发中将应用、依赖、函数库、配置一起<strong>打包</strong>，形成可移植<strong>镜像</strong></p>
</li>
<li><p>Docker应用运行在容器中，使用沙箱机制，相互<strong>隔离</strong></p>
</li>
</ul>
<h3 id="1-3-Docker和虚拟机的区别"><a href="#1-3-Docker和虚拟机的区别" class="headerlink" title="1.3.Docker和虚拟机的区别"></a>1.3.Docker和虚拟机的区别</h3><p>虚拟机是在操作系统中模拟硬件设备，然后运行另外一个系统。</p>
<p>Docker是封装了函数库，通过函数库取调用Linux内核，内核调用硬件。</p>
<p><img src="/images/image-20220308130644451.png" alt="image-20220308130644451" loading="lazy"></p>
<p><img src="/images/image-20220308130716324.png" alt="image-20220308130716324" loading="lazy"></p>
<p>小结：</p>
<p>Docker和虚拟机的差异：</p>
<ul>
<li>docker是一个<strong>系统进程</strong>；虚拟机是在操作系统中的操作系统</li>
<li>docker体积小、启动速度快、<strong>性能好</strong>；虚拟机体积大、启动速度慢、<strong>性能一般</strong></li>
</ul>
<h3 id="1-4Docker架构"><a href="#1-4Docker架构" class="headerlink" title="1.4Docker架构"></a>1.4Docker架构</h3><h4 id="1-4-1镜像和容器"><a href="#1-4-1镜像和容器" class="headerlink" title="1.4.1镜像和容器"></a>1.4.1镜像和容器</h4><pre><code>    **镜像(image)**:Docker将应用程序及其所需依赖、甚至是系统 函数库、环境、配置等文件打包在一起，称为镜像。

    **容器(Container)**:**镜像中应用程序**运行后的形成的**进程就是容器**。只是Docker会给容器进程做隔离，对外不可见。
</code></pre>
<p><img src="/images/image-20220308131147326.png" alt="image-20220308131147326" loading="lazy"></p>
<p>每个容器之间用沙箱机制隔离，互不干扰。</p>
<pre><code>    容器只对镜像进行**读操作**，不进行写操作，以防污染镜像，产生不必要的问题。
</code></pre>
<h4 id="1-4-2DockerHub"><a href="#1-4-2DockerHub" class="headerlink" title="1.4.2DockerHub"></a>1.4.2DockerHub</h4><ul>
<li><p>DockerHub：DockerHub是一个官方的Docker镜像的托管平台。这样的平台称为Docker Registry。</p>
</li>
<li><p>国内也有类似于DockerHub 的公开服务，比如 <a target="_blank" rel="noopener" href="https://c.163yun.com/hub">网易云镜像服务</a>、<a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/">阿里云镜像库</a>等。</p>
</li>
</ul>
<p>我们一方面可以将自己的镜像共享到DockerHub，另一方面也可以从DockerHub拉取镜像：</p>
<p><img src="/images/image-20220308131502130.png" alt="image-20220308131502130" loading="lazy"></p>
<h4 id="1-4-3-Docker架构"><a href="#1-4-3-Docker架构" class="headerlink" title="1.4.3.Docker架构"></a>1.4.3.Docker架构</h4><p>我们要使用Docker来操作镜像、容器，就必须要安装Docker。</p>
<p>Docker是一个CS架构的程序，由两部分组成：</p>
<ul>
<li><p>服务端(server)：Docker守护进程，负责处理Docker指令，管理镜像、容器等</p>
</li>
<li><p>客户端(client)：通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令。</p>
</li>
</ul>
<p><img src="/images/image-20220308131654050.png" alt="image-20220308131654050" loading="lazy"></p>
<h4 id="1-4-4-小结"><a href="#1-4-4-小结" class="headerlink" title="1.4.4.小结"></a>1.4.4.小结</h4><p><strong>镜像</strong>：</p>
<ul>
<li>将应用程序及其依赖、环境、配置打包在一起</li>
</ul>
<p><strong>容器</strong>：</p>
<ul>
<li>镜像运行起来就是容器，一个镜像可以运行多个容器</li>
</ul>
<p><strong>Docker</strong>结构：</p>
<ul>
<li><p>服务端：接收命令或远程请求，操作镜像或容器</p>
</li>
<li><p>客户端：发送命令或者请求到Docker服务端</p>
</li>
</ul>
<p>DockerHub：</p>
<ul>
<li>一个镜像托管的服务器，类似的还有阿里云镜像服务，统称为DockerRegistry</li>
</ul>
<h2 id="2-Docker基本操作"><a href="#2-Docker基本操作" class="headerlink" title="2.Docker基本操作"></a>2.Docker基本操作</h2><h2 id="2-1镜像操作"><a href="#2-1镜像操作" class="headerlink" title="2.1镜像操作"></a>2.1镜像操作</h2><p>镜像名称一般分为两部分组成: [repository]:[tag]。</p>
<p>在没有指定tag时，默认是latest，代表最新版本镜像</p>
<p><img src="/images/image-20220308150957640.png" alt="image-20220308150957640" loading="lazy"></p>
<p><img src="/images/image-20220308151042400.png" alt="image-20220308151042400" loading="lazy"></p>
<p>可以拉取多个不同Tag的 repository</p>
<p><img src="/images/image-20220308151226705.png" alt="image-20220308151226705" loading="lazy"></p>
<h3 id="2-2镜像操作有哪些"><a href="#2-2镜像操作有哪些" class="headerlink" title="2.2镜像操作有哪些"></a>2.2镜像操作有哪些</h3><p>docker images      列出所有镜像</p>
<p>docker rmi            删除镜像 ,如果没制定 镜像的tag 默认删除是latest的最新版镜像。</p>
<p>docker pull           拉取镜像</p>
<p>docker  push         存入镜像</p>
<p>docker  save -o             将镜像打包成 tar文件</p>
<p>docker load            加载 打包的tar镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--input, -i` 从tar档案文件读取，而不是`STDIN</span><br><span class="line">--quiet, -q false</span><br><span class="line">抑制负载输出</span><br></pre></td></tr></table></figure>

<p>如果某个命令忘记了 可以 docker 命令名  –help 查看使用</p>
<h2 id="2-2容器操作"><a href="#2-2容器操作" class="headerlink" title="2.2容器操作"></a>2.2容器操作</h2><p>容器操作的命令如图:</p>
<p><img src="/images/image-20220308193951843.png" alt="image-20220308193951843" loading="lazy"></p>
<p>容器保护三个状态：</p>
<ul>
<li>运行：进程正常运行</li>
<li>暂停：进程暂停，CPU不再运行，并不释放内存</li>
<li>停止：进程终止，回收进程占用的内存、CPU等资源</li>
</ul>
<p>其中:</p>
<pre><code>    docker run: 创建并运行一个容器,处于运行状态

    docker pause: 让一个运行的容器暂停

    docker unpause: 让一个容器从暂停状态恢复运行

    docker stop : 停止一个运行的容器。

    docker start: 让一个停止的容器再次运行。

    docker rm: 删除一个容器。
</code></pre>
<h3 id="2-2-1-案例-创建并运行一个容器"><a href="#2-2-1-案例-创建并运行一个容器" class="headerlink" title="2.2.1.案例-创建并运行一个容器"></a>2.2.1.案例-创建并运行一个容器</h3><p>创建并运行nginx容器的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name containerName -p 80:80 -d nginx</span><br></pre></td></tr></table></figure>

<p>命令解读：</p>
<ul>
<li>docker run ：创建并运行一个容器</li>
<li>–name : 给容器起一个名字，比如叫做mn</li>
<li>-p ：将宿主机端口与容器端口映射，冒号<strong>左侧是宿主机端口</strong>，右侧是容器端口</li>
<li>-d：后台运行容器</li>
<li>nginx：镜像名称，例如nginx</li>
</ul>
<p>这里的<code>-p</code>参数，是将容器端口映射到宿主机端口。</p>
<p>默认情况下，容器是隔离环境，我们直接访问宿主机的80端口，肯定访问不到容器中的nginx。</p>
<p><img src="/images/image-20220308205626891.png" alt="image-20220308205626891" loading="lazy"></p>
<p>如果访问不了解决方案:</p>
<pre><code>    https://baijiahao.baidu.com/s?id=1701529012511078833&amp;wfr=spider&amp;for=pc
</code></pre>
<p>2.2.2 进入容器，修改文件</p>
<p>步骤:</p>
<pre><code>1）进入容器。进入我们刚刚创建的nginx容器的命令为：
</code></pre>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it  xz bash</span><br></pre></td></tr></table></figure>

<pre><code>    命令解读：
</code></pre>
<ul>
<li><p>docker exec ：进入容器内部，执行一个命令</p>
</li>
<li><p>-it : 给当前进入的容器创建一个<strong>标准输入、输出终端</strong>，允许我们与容器交互</p>
</li>
<li><p>xiaozhi ：要进入的容器的名称</p>
</li>
<li><p>bash：进入容器后执行的命令，bash是一个linux终端交互命令</p>
</li>
</ul>
<p><img src="/images/image-20220308210941752.png" alt="image-20220308210941752" loading="lazy"></p>
<p>​    </p>
<p>nginx的环境、配置、运行文件全部都在这个文件系统中，包括我们要修改的html文件。</p>
<p>查看DockerHub网站中的nginx页面，可以知道nginx的html目录位置在<code>/usr/share/nginx/html</code></p>
<p>我们执行命令，进入该目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html</span><br></pre></td></tr></table></figure>

<p> 查看目录下文件：</p>
<p><strong><img src="/images/image-20220308211304539.png" alt="image-20220308211304539" loading="lazy"></strong></p>
<p>3）修改index.html的内容</p>
<p>容器内没有vi命令，无法直接修改，我们用下面的命令来修改：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i -e <span class="string">&#x27;s#李小志#李小志好帅#g&#x27;</span> -e <span class="string">&#x27;s#&lt;head&gt;#&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;#g&#x27;</span> index.html</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220308211718821.png" alt="image-20220308211718821" loading="lazy"></p>
<p>总结:</p>
<pre><code>2.2.4.小结
</code></pre>
<p>docker run命令的常见参数有哪些？</p>
<ul>
<li>–name：指定容器名称</li>
<li>-p：指定端口映射</li>
<li>-d：让容器后台运行</li>
</ul>
<p>查看容器日志的命令：</p>
<ul>
<li>docker logs</li>
<li>添加 -f 参数可以持续查看日志</li>
</ul>
<p>查看容器状态：</p>
<ul>
<li>docker ps</li>
<li>docker ps -a 查看所有容器，包括已经停止的</li>
</ul>
<h2 id="2-3数据卷-容器数据管理"><a href="#2-3数据卷-容器数据管理" class="headerlink" title="2.3数据卷(容器数据管理)"></a>2.3数据卷(容器数据管理)</h2><h3 id="2-3-1-什么是数据卷"><a href="#2-3-1-什么是数据卷" class="headerlink" title="2.3.1.什么是数据卷"></a>2.3.1.什么是数据卷</h3><p><strong>数据卷(volume)是一个虚拟目录</strong>，指向宿主机文件系统中的某个目录。</p>
<p><img src="/images/image-20220309133722685.png" alt="image-20220309133722685" loading="lazy"></p>
<p>一旦完成数据卷挂载，对容器的一切操作都会作用在数据卷对应的宿主机目录了。</p>
<p>这样，我们操作宿主机的/var/lib/docker/volumes/html目录，就等于操作容器内的/usr/share/nginx/html目录了</p>
<p><strong>容器1 和 容器2 同时挂载一个数据卷可以达到数据共享的目的。</strong></p>
<h3 id="2-3-2数据卷操作命令"><a href="#2-3-2数据卷操作命令" class="headerlink" title="2.3.2数据卷操作命令"></a>2.3.2数据卷操作命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume [COMMAND]</span><br></pre></td></tr></table></figure>

<pre><code>    COMMAND:

                create 创建一个volume                    

                inspect 显示一个或多个volume的信息
</code></pre>
<p><img src="/images/image-20220309134230584.png" alt="image-20220309134230584" loading="lazy"></p>
<p><img src="/images/image-20220309134311647.png" alt="image-20220309134311647" loading="lazy"></p>
<p>xiaozhi这个数据卷关联的宿主机目录为</p>
<p>/var/lib/docker/volumes/xiaozhi/_data</p>
<pre><code>                ls 列出所有的volume
</code></pre>
<p><img src="/images/image-20220309134447805.png" alt="image-20220309134447805" loading="lazy"></p>
<pre><code>                prune 删除未使用的volume
</code></pre>
<p><img src="/images/image-20220309134536349.png" alt="image-20220309134536349" loading="lazy"></p>
<pre><code>                rm 删除一个或多个指定的volume
</code></pre>
<p><img src="/images/image-20220309134633715.png" alt="image-20220309134633715" loading="lazy"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结:"></a>小结:</h3><p>数据卷的作用：</p>
<ul>
<li><strong>将容器与数据分离，解耦合，方便操作容器内数据，保证数据安全</strong></li>
</ul>
<p>数据卷操作:</p>
<p>​        </p>
<ul>
<li>docker volume create：创建数据卷</li>
<li>docker volume ls：查看所有数据卷</li>
<li>docker volume inspect：查看数据卷详细信息，包括关联的宿主机目录位置</li>
<li>docker volume rm：删除指定数据卷</li>
<li>docker volume prune：删除所有未使用的数据卷</li>
</ul>
<h3 id="2-4挂载数据卷"><a href="#2-4挂载数据卷" class="headerlink" title="2.4挂载数据卷"></a>2.4挂载数据卷</h3><h3 id="方式一、带数据卷模式"><a href="#方式一、带数据卷模式" class="headerlink" title="方式一、带数据卷模式"></a>方式一、带数据卷模式</h3><p>我们在创建容器时,可以通过 -v 参数来挂载一个数据卷到容器内目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name xiaozhi -v liwei:/opt/temp -p 80:80  -d  镜像:tag</span><br></pre></td></tr></table></figure>

<p>-v liwei:/opt/temp : 将 名字为liwei数据卷挂载到容器 /opt/temp 目录 相当于xiaozhi所关联的宿主机目录与容器内/opt/temp目录 同步。</p>
<p><strong>宿主机目录 –&gt; 数据卷 —&gt; 容器内目录</strong></p>
<p><strong>通过 docker inspect 数据卷命令查看 当前卷对应的宿主机目录，此目录与容器所绑定的目录同步。</strong></p>
<h3 id="方式二、直接挂载模式"><a href="#方式二、直接挂载模式" class="headerlink" title="方式二、直接挂载模式"></a>方式二、直接挂载模式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name xiaozhi -v /opt/liwei/:/opt/temp -p 80:80  -d  镜像:tag</span><br></pre></td></tr></table></figure>

<p>自定义目录与容器所绑定的目录同步。</p>
<p><strong>如上述命令 在宿主机上创建liwei目录，与容器内目录temp 同步。</strong></p>
<p>小结:</p>
<p><img src="/images/image-20220309184012533.png" alt="image-20220309184012533" loading="lazy"></p>
<p>数据卷挂载与目录直接挂载的</p>
<ul>
<li><p>数据卷挂载耦合度低，由docker来管理目录，但是目录较深，不好找</p>
</li>
<li><p>目录挂载耦合度高，需要我们自己管理目录，不过目录容易寻找查看</p>
<pre><code>      **数据卷挂载宿主机目录docker规定好，直接挂载自己创建目录。**
</code></pre>
</li>
</ul>
<h2 id="3-Dockerfile自定义镜像"><a href="#3-Dockerfile自定义镜像" class="headerlink" title="3.Dockerfile自定义镜像"></a>3.Dockerfile自定义镜像</h2><p>常见的镜像在DockerHub就能找到，但是我们自己写的项目就必须自己构建镜像了。</p>
<h2 id="3-1镜像结构"><a href="#3-1镜像结构" class="headerlink" title="3.1镜像结构"></a>3.1镜像结构</h2><p>镜像就是将应用程序及其需要的系统函数库、环境、配置、依赖打包而成。</p>
<p>以MySQL为例，来看看镜像的组成结构：</p>
<p><img src="/images/image-20220309193639315.png" alt="image-20220309193639315" loading="lazy"></p>
<p><strong>简而言之: 镜像就是在系统函数库、运行环境基础上，添加应用程序文件、配置文件、依赖文件等组合，然后编写好启动脚本打包在一起形成的文件。</strong></p>
<h2 id="3-2Dockerfile语法"><a href="#3-2Dockerfile语法" class="headerlink" title="3.2Dockerfile语法"></a>3.2<strong>Dockerfile语法</strong></h2><pre><code>**Dockerfile语法作用:**  

                    告诉Docker,镜像组成，BaseImage、拷贝哪些文件需要安装什么依赖、启动脚本是什么。

**Dockerfile**就是一个文本文件，其中包含一个个的**指令(Instruction)**，用指令来说明要执行什么操作来构建镜像。每一个指令都会形成一层**Layer**。

Dockerfile常用命令:

        FROM  指定基础镜像      FROM  centos:7

        ENV        设置环境变量    JAVA_DIR=/usr/local

        COPY      拷贝本地目录到镜像的指定目录   COPY ./jdk8.tar.gz $JAVA_DIR/                                                 COPY ./docker-demo.jar /tmp/app.jar

        RUN        执行Linux的shell命令,一般是安装过程的命令。    # 安装JDK
</code></pre>
<p>RUN cd $JAVA_DIR <br> &amp;&amp; tar -xf ./jdk8.tar.gz <br> &amp;&amp; mv ./jdk1.8.0_144 ./java8</p>
<pre><code>        EXPOSE  指定容器监听的端口,给镜像使用者看的    

        ENTRYPOINT        镜像中应用启动命令，容器运行时调用
</code></pre>
<h2 id="4-DockerCompose"><a href="#4-DockerCompose" class="headerlink" title="4.DockerCompose"></a>4.DockerCompose</h2><p>Docker Compose可以基于Compose文件帮我们快速的部署分布式应用，而无需手动一个个创建和运行容器！</p>
<h2 id="4-1-初识DockerCompose"><a href="#4-1-初识DockerCompose" class="headerlink" title="4.1.初识DockerCompose"></a>4.1.初识DockerCompose</h2><p>Compose文件是一个文本文件，通过指令定义集群中的每个容器如何运行。格式如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"> <span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span>   <span class="comment">#容器名称  --name</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.25</span>  <span class="comment">#镜像名称 版本 -d</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">     <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span>  <span class="comment">#设置密码</span></span><br><span class="line">    <span class="attr">volumes:</span>	<span class="comment">#-v 挂载数据卷</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;/tmp/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;/tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf&quot;</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面的Compose文件就描述一个项目，其中包含两个容器：</p>
<ul>
<li>mysql：一个基于<code>mysql:5.7.25</code>镜像构建的容器，并且挂载了两个目录</li>
<li>web：一个基于<code>docker build</code>临时构建的镜像容器，映射端口时8090</li>
</ul>
<p>DockerCompose的详细语法参考官网：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>
<p>其实DockerCompose文件可以看做是将多个<strong>docker run</strong>命令写到一个文件，只是语法稍有差异。</p>
<h2 id="4-2-compose文件"><a href="#4-2-compose文件" class="headerlink" title="4.2.compose文件"></a>4.2.compose文件</h2><p>查看课前资料提供的cloud-demo文件夹，里面已经编写好了docker-compose文件，而且每个微服务都准备了一个独立的目录：</p>
<p><img src="/images/image-20210731181341330.png" alt="image-20210731181341330" loading="lazy"></p>
<p>内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MODE:</span> <span class="string">standalone</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7.25</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$PWD/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$PWD/mysql/conf:/etc/mysql/conf.d/&quot;</span></span><br><span class="line">  <span class="attr">userservice:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./user-service</span></span><br><span class="line">  <span class="attr">orderservice:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./order-service</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./gateway</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10010:10010&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，其中包含5个service服务：</p>
<ul>
<li><code>nacos</code>：作为注册中心和配置中心<ul>
<li><code>image: nacos/nacos-server</code>： 基于nacos/nacos-server镜像构建</li>
<li><code>environment</code>：环境变量<ul>
<li><code>MODE: standalone</code>：单点模式启动</li>
</ul>
</li>
<li><code>ports</code>：端口映射，这里暴露了8848端口</li>
</ul>
</li>
<li><code>mysql</code>：数据库<ul>
<li><code>image: mysql:5.7.25</code>：镜像版本是mysql:5.7.25</li>
<li><code>environment</code>：环境变量<ul>
<li><code>MYSQL_ROOT_PASSWORD: 123</code>：设置数据库root账户的密码为123</li>
</ul>
</li>
<li><code>volumes</code>：数据卷挂载，这里挂载了mysql的data、conf目录，其中有我提前准备好的数据</li>
</ul>
</li>
<li><code>userservice</code>、<code>orderservice</code>、<code>gateway</code>：都是基于Dockerfile临时构建的</li>
</ul>
<p>4.3.2.修改微服务配置</p>
<h2 id="4-3-修改微服务配置"><a href="#4-3-修改微服务配置" class="headerlink" title="4.3.修改微服务配置"></a>4.3.修改微服务配置</h2><p>因为微服务将来要部署为docker容器，而容器之间互联不是通过IP地址，而是通过容器名。这里我们将order-service、user-service、gateway服务的mysql、nacos地址都修改为基于容器名的访问。</p>
<p>如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/cloud_order?useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">orderservice</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacos:8848</span> <span class="comment"># nacos服务地址</span></span><br></pre></td></tr></table></figure>

<h2 id="4-4-部署"><a href="#4-4-部署" class="headerlink" title="4.4.部署"></a>4.4.部署</h2><p>部署：</p>
<p>进入cloud-demo目录，然后运行下面的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="5-Docker镜像仓库"><a href="#5-Docker镜像仓库" class="headerlink" title="5.Docker镜像仓库"></a>5.Docker镜像仓库</h2><h2 id="5-1搭建私有镜像仓库"><a href="#5-1搭建私有镜像仓库" class="headerlink" title="5.1搭建私有镜像仓库"></a>5.1搭建私有镜像仓库</h2><pre><code>    5.1.1简化版镜像仓库

    Docker官方的Docker Registry是一个基础版本的Docker镜像仓库，具备仓库管理的完整功能，但是没有图形化界面。
</code></pre>
<p>搭建方式比较简单，命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --restart=always \</span><br><span class="line">    --name registry	\</span><br><span class="line">    -p 5000:5000 \</span><br><span class="line">    -v registry-data:/var/lib/registry \</span><br><span class="line">    registry</span><br></pre></td></tr></table></figure>

<p>命令中挂载了一个数据卷registry-data到容器内的/var/lib/registry 目录，这是私有镜像库存放数据的目录。</p>
<p>访问<a target="_blank" rel="noopener" href="http://yourip:5000/v2/_catalog">http://YourIp:5000/v2/_catalog</a> 可以查看当前私有镜像服务中包含的镜像</p>
<h2 id="5-2带有图形化界面"><a href="#5-2带有图形化界面" class="headerlink" title="5.2带有图形化界面"></a>5.2带有图形化界面</h2><p>使用DockerCompose部署带有图象界面的DockerRegistry，命令如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.0&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./registry-data:/var/lib/registry</span></span><br><span class="line">  <span class="attr">ui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">joxit/docker-registry-ui:static</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_TITLE=小志的私有仓库</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_URL=http://registry:5000</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">registry</span></span><br></pre></td></tr></table></figure>

<p><strong>docker-compose.yml</strong></p>
<h3 id="5-2-1配置Docker信任地址"><a href="#5-2-1配置Docker信任地址" class="headerlink" title="5.2.1配置Docker信任地址"></a>5.2.1配置Docker信任地址</h3><p>我们的私服采用的是http协议，默认不被Docker信任，所以需要做一个配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开要修改的文件</span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line"><span class="comment"># 添加内容：</span></span><br><span class="line"><span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;http://192.168.150.101:8080&quot;</span>]</span><br><span class="line"><span class="comment"># 重加载</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment"># 重启docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220310194123304.png" alt="image-20220310194123304" loading="lazy"></p>
<p><strong>每个之间用逗号隔开。</strong></p>
<p>在docker-compose.yml同级目录运行启动仓库容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>浏览器访问<a target="_blank" rel="noopener" href="http://192.168.179.132:8080/?page=1#!%E5%8D%B3%E5%8F%AF%E6%9F%A5%E7%9C%8B%E5%88%B0%E4%BB%93%E5%BA%93">http://192.168.179.132:8080/?page=1#!即可查看到仓库</a></p>
<p><img src="/images/image-20220310194511724.png" alt="image-20220310194511724" loading="lazy"></p>
<h2 id="5-3镜像推送和拉取"><a href="#5-3镜像推送和拉取" class="headerlink" title="5.3镜像推送和拉取"></a>5.3镜像推送和拉取</h2><p>推送镜像到私有镜像服务必须先tag，步骤如下：</p>
<p>① 重新tag本地镜像，名称前缀为私有仓库的地址：192.168.150.101:8080/  相当于去个</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag mysql:latest 192.168.150.101:8080/mysql:1.0 </span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220310195008583.png" alt="image-20220310195008583" loading="lazy"></p>
<p><strong>这两个镜像实则为同一个镜像，相当于复制一份了+33</strong></p>
<p><strong>mysql:1.0 上传到私有库后的名称和版本</strong></p>
<p>② 推送镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 192.168.179.132:8080/mysql:1.0 </span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220310195102572.png" alt="image-20220310195102572" loading="lazy"></p>
<p>③ 拉取镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull 192.168.179.132:8080/mysql:1.0 </span><br></pre></td></tr></table></figure>

<pre><code>    ![image-20220310195219264](/images/image-20220310195219264.png)

    ![image-20220310195844715](/images/image-20220310195844715.png)
</code></pre>
<p><img src="/images/image-20220310195830928.png" alt="image-20220310195830928" loading="lazy"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install vim</span><br></pre></td></tr></table></figure>

<p>docker下安装乌班图<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014001964/article/details/80904331">https://blog.csdn.net/u014001964/article/details/80904331</a></p>
<h1 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h1><h2 id="1-简单队列"><a href="#1-简单队列" class="headerlink" title="1.简单队列"></a>1.简单队列</h2><p>简单队列模式的模型图：</p>
<p><img src="/images/image-20220311183139309.png" alt="image-20220311183139309" loading="lazy"></p>
<p>官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：</p>
<ul>
<li>publisher：消息发布者，将消息发送到队列queue</li>
<li>queue：消息队列，负责接受并缓存消息</li>
<li>consumer：订阅队列，处理队列中的消息</li>
</ul>
<h2 id="2-工作队列"><a href="#2-工作队列" class="headerlink" title="2.工作队列"></a>2.工作队列</h2><p>Work queues，也被称为（Task queues），任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。</p>
<p><img src="/images/image-20220311183333577.png" alt="image-20220311183333577" loading="lazy"></p>
<p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p>
<p>此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。</p>
<p><strong>consumer1 和 consumer2 一人一下消费队列中的消息。</strong></p>
<p>可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。</p>
<p>也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这<strong>样显然是有问题的。</strong></p>
<h2 id="3-能者多劳"><a href="#3-能者多劳" class="headerlink" title="3.能者多劳"></a>3.能者多劳</h2><p>在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span></span><br></pre></td></tr></table></figure>

<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h2><p>Work模型的使用：</p>
<ul>
<li><p>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</p>
</li>
<li><p>通过设置prefetch来控制消费者预取的消息数量</p>
<pre><code>      消息被消费后就从队列中消失
</code></pre>
</li>
</ul>
<h2 id="3-3-发布-订阅"><a href="#3-3-发布-订阅" class="headerlink" title="3.3.发布/订阅"></a>3.3.发布/订阅</h2><p>发布订阅的模型如图：</p>
<p><img src="/images/image-20210717165309625.png" alt="image-20210717165309625" loading="lazy"></p>
<p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：</p>
<ul>
<li>Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li>
<li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型：<ul>
<li>Fanout：广播，将消息交给所有绑定到交换机的队列</li>
<li>Direct：定向，把消息交给符合指定routing key 的队列</li>
<li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li>
</ul>
</li>
<li>Consumer：消费者，与以前一样，订阅队列，没有变化</li>
<li>Queue：消息队列也与以前一样，接收消息、缓存消息。</li>
</ul>
<p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<h2 id="3-4-Fanout"><a href="#3-4-Fanout" class="headerlink" title="3.4.Fanout"></a>3.4.Fanout</h2><p>Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。</p>
<p><img src="/images/image-20210717165438225.png" alt="image-20210717165438225" loading="lazy"></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>1）  可以有多个队列</li>
<li>2）  每个队列都要绑定到Exchange（交换机）</li>
<li>3）  生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li>
<li>4）  交换机把消息发送给绑定过的所有队列</li>
<li>5）  订阅队列的消费者都能拿到消息</li>
</ul>
<p>我们的计划是这样的：</p>
<ul>
<li>创建一个交换机 itcast.fanout，类型是Fanout</li>
<li>创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout</li>
</ul>
<p><img src="/images/image-20210717165509466.png" alt="image-20210717165509466" loading="lazy"></p>
<h3 id="3-4-1-声明队列和交换机"><a href="#3-4-1-声明队列和交换机" class="headerlink" title="3.4.1.声明队列和交换机"></a>3.4.1.声明队列和交换机</h3><p>Spring提供了一个接口Exchange，来表示所有不同类型的交换机：</p>
<p><img src="/images/image-20210717165552676.png" alt="image-20210717165552676" loading="lazy"></p>
<p>在consumer中创建一个类，声明队列和交换机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.FanoutExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Fanout类型交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;itcast.fanout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第1个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1</span><span class="params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第2个队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanout.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列和交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2</span><span class="params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-2-消息发送"><a href="#3-4-2-消息发送" class="headerlink" title="3.4.2.消息发送"></a>3.4.2.消息发送</h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanoutExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;itcast.fanout&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, everyone!&quot;</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-3-消息接收"><a href="#3-4-3-消息接收" class="headerlink" title="3.4.3.消息接收"></a>3.4.3.消息接收</h3><p>在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue1</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1接收到Fanout消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue2</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者2接收到Fanout消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-4-总结"><a href="#3-4-4-总结" class="headerlink" title="3.4.4.总结"></a>3.4.4.总结</h3><p>交换机的作用是什么？</p>
<ul>
<li>接收publisher发送的消息</li>
<li>将消息按照规则路由到与之绑定的队列</li>
<li>不能缓存消息，路由失败，消息丢失</li>
<li>FanoutExchange的会将消息路由到每个绑定的队列</li>
</ul>
<p>声明队列、交换机、绑定关系的Bean是什么？</p>
<ul>
<li>Queue</li>
<li>FanoutExchange</li>
<li>Binding</li>
</ul>
<h2 id="3-5-Direct"><a href="#3-5-Direct" class="headerlink" title="3.5.Direct"></a>3.5.Direct</h2><p>在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。</p>
<p><img src="/images/image-20210717170041447.png" alt="image-20210717170041447" loading="lazy"></p>
<p> 在Direct模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li>
<li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li>
<li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li>
</ul>
<p><strong>案例需求如下</strong>：</p>
<ol>
<li><p>利用@RabbitListener声明Exchange、Queue、RoutingKey</p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</p>
</li>
<li><p>在publisher中编写测试方法，向itcast. direct发送消息</p>
</li>
</ol>
<p><img src="/images/image-20210717170223317.png" alt="image-20210717170223317" loading="lazy"></p>
<h3 id="3-5-1-基于注解声明队列和交换机"><a href="#3-5-1-基于注解声明队列和交换机" class="headerlink" title="3.5.1.基于注解声明队列和交换机"></a>3.5.1.基于注解声明队列和交换机</h3><p>基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。</p>
<p>在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;itcast.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者接收到direct.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;itcast.direct&quot;, type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">    key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者接收到direct.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-2-消息发送"><a href="#3-5-2-消息发送" class="headerlink" title="3.5.2.消息发送"></a>3.5.2.消息发送</h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDirectExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;itcast.direct&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;red&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-3-总结"><a href="#3-5-3-总结" class="headerlink" title="3.5.3.总结"></a>3.5.3.总结</h3><p>描述下Direct交换机与Fanout交换机的差异？</p>
<ul>
<li>Fanout交换机将消息路由给每一个与之绑定的队列</li>
<li>Direct交换机根据RoutingKey判断路由给哪个队列</li>
<li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li>
</ul>
<p>基于@RabbitListener注解声明队列和交换机有哪些常见注解？</p>
<ul>
<li>@Queue</li>
<li>@Exchange</li>
</ul>
<h2 id="3-6-Topic"><a href="#3-6-Topic" class="headerlink" title="3.6.Topic"></a>3.6.Topic</h2><h3 id="3-6-1-说明"><a href="#3-6-1-说明" class="headerlink" title="3.6.1.说明"></a>3.6.1.说明</h3><p><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p>
<p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p>
<p> 通配符规则：</p>
<p><code>#</code>：匹配一个或多个词</p>
<p><code>*</code>：匹配不多不少恰好1个词</p>
<p>举例：</p>
<p><code>item.#</code>：能够匹配<code>item.spu.insert</code> 或者 <code>item.spu</code></p>
<p><code>item.*</code>：只能匹配<code>item.spu</code></p>
<p>​     </p>
<p>图示：</p>
<p> <img src="/images/image-20210717170705380.png" alt="image-20210717170705380" loading="lazy"></p>
<p>解释：</p>
<ul>
<li>Queue1：绑定的是<code>china.#</code> ，因此凡是以 <code>china.</code>开头的<code>routing key</code> 都会被匹配到。包括china.news和china.weather</li>
<li>Queue2：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配。包括china.news和japan.news</li>
</ul>
<p>案例需求：</p>
<p>实现思路如下：</p>
<ol>
<li><p>并利用@RabbitListener声明Exchange、Queue、RoutingKey</p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</p>
</li>
<li><p>在publisher中编写测试方法，向itcast. topic发送消息</p>
</li>
</ol>
<p><img src="/images/image-20210717170829229.png" alt="image-20210717170829229" loading="lazy"></p>
<h3 id="3-6-2-消息发送"><a href="#3-6-2-消息发送" class="headerlink" title="3.6.2.消息发送"></a>3.6.2.消息发送</h3><p>在publisher服务的SpringAmqpTest类中添加测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * topicExchange</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendTopicExchange</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 交换机名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;itcast.topic&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;喜报！孙悟空大战哥斯拉，胜!&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">&quot;china.news&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-6-3-消息接收"><a href="#3-6-3-消息接收" class="headerlink" title="3.6.3.消息接收"></a>3.6.3.消息接收</h3><p>在consumer服务的SpringRabbitListener中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue1&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;itcast.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;china.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者接收到topic.queue1的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">    value = @Queue(name = &quot;topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">    exchange = @Exchange(name = &quot;itcast.topic&quot;, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">    key = &quot;#.news&quot;		</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者接收到topic.queue2的消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>    **//先声明交换机 和队列 之间绑定的关系 下面方法就监听此队列**
</code></pre>
<h3 id="3-6-4-总结"><a href="#3-6-4-总结" class="headerlink" title="3.6.4.总结"></a>3.6.4.总结</h3><p>描述下Direct交换机与Topic交换机的差异？</p>
<ul>
<li>Topic交换机接收的消息RoutingKey必须是多个单词，以 <code>**.**</code> 分割</li>
<li>Topic交换机与队列绑定时的bindingKey可以指定通配符</li>
<li><code>#</code>：代表0个或多个词</li>
<li><code>*</code>：代表1个词</li>
</ul>
<h2 id="3-7-消息转换器"><a href="#3-7-消息转换器" class="headerlink" title="3.7.消息转换器"></a>3.7.消息转换器</h2><p>之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。</p>
<p><img src="/images/image-20200525170410401.png" alt="image-20200525170410401" loading="lazy"></p>
<p>只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：</p>
<ul>
<li>数据体积过大</li>
<li>有安全漏洞</li>
<li>可读性差</li>
</ul>
<p>我们来测试一下。</p>
<h3 id="3-7-1-测试默认转换器"><a href="#3-7-1-测试默认转换器" class="headerlink" title="3.7.1.测试默认转换器"></a>3.7.1.测试默认转换器</h3><p>我们修改消息发送的代码，发送一个Map对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMap</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 准备消息</span></span><br><span class="line">    Map&lt;String,Object&gt; msg = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    msg.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">    msg.put(<span class="string">&quot;age&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;simple.queue&quot;</span>,<span class="string">&quot;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>停止consumer服务</p>
<p>发送消息后查看控制台：</p>
<p><img src="/images/image-20210422232835363.png" alt="image-20210422232835363" loading="lazy"></p>
<h3 id="3-7-2-配置JSON转换器"><a href="#3-7-2-配置JSON转换器" class="headerlink" title="3.7.2.配置JSON转换器"></a>3.7.2.配置JSON转换器</h3><p>显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。</p>
<p>在publisher和consumer两个服务中都引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置消息转换器。</p>
<p>在启动类中添加一个Bean即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Elasticsearch分布式搜索引擎"><a href="#Elasticsearch分布式搜索引擎" class="headerlink" title="Elasticsearch分布式搜索引擎"></a>Elasticsearch分布式搜索引擎</h1><h2 id="1-啥是ES"><a href="#1-啥是ES" class="headerlink" title="1.啥是ES"></a>1.啥是ES</h2><pre><code>ES是一款非常强大的开源搜索引擎，具备
</code></pre>
<p>非常多强大功能，可以从海量数据中快速找到需要的内容。</p>
<h3 id="1-2-ELK技术栈"><a href="#1-2-ELK技术栈" class="headerlink" title="1.2.ELK技术栈"></a>1.2.ELK技术栈</h3><p>elasticsearch结合kibana、Logstash、Beats，也就是elastic stack（ELK）。被广泛应用在日志数据分析、实时监控等领域：</p>
<p>elasticsearch是ELK的核心，负责存储、搜索、分析数据。</p>
<p><img src="/images/image-20220312113147645.png" alt="image-20220312113147645" loading="lazy"></p>
<p>elasticsearch底层是基于lucene来实现的。<br>    Lucene是一个java的搜索引擎类库。</p>
<h3 id="1-3-总结"><a href="#1-3-总结" class="headerlink" title="1.3.总结"></a>1.3.总结</h3><p>什么是elasticsearch？</p>
<ul>
<li>一个开源的分布式搜索引擎，可以用来实现搜索、日志统计、分析、系统监控等功能</li>
</ul>
<p>什么是elastic stack（ELK）？</p>
<ul>
<li>是以elasticsearch为核心的技术栈，包括beats、Logstash、kibana、elasticsearch</li>
</ul>
<p>什么是Lucene？</p>
<ul>
<li>是Apache的开源搜索引擎类库，提供了搜索引擎的核心API</li>
</ul>
<h2 id="2-倒排索引"><a href="#2-倒排索引" class="headerlink" title="2.倒排索引"></a>2.倒排索引</h2><pre><code>倒排索引是基于Mysql这样的正向索引而言的。
</code></pre>
<h3 id="1-2-1正向索引"><a href="#1-2-1正向索引" class="headerlink" title="1.2.1正向索引"></a>1.2.1正向索引</h3><p>那么什么是正向索引呢？例如给下表（tb_goods）中的id创建索引：</p>
<p><img src="/images/image-20220312113701789.png" alt="image-20220312113701789" loading="lazy"></p>
<p>如果是根据id查询，那么直接走索引，查询速度非常快。</p>
<p>但如果是基于title做模糊查询，只能是逐行扫描数据，流程如下：</p>
<p>1）用户搜索数据，条件是title符合<code>&quot;%手机%&quot;</code></p>
<p>2）逐行获取数据，比如id为1的数据</p>
<p>3）判断数据中的title是否符合用户搜索条件</p>
<p>4）如果符合则放入结果集，不符合则丢弃。回到步骤1</p>
<p><strong>逐行扫描，也就是全表扫描，</strong>随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是一场灾难。</p>
<h3 id="1-2-2-倒排索引"><a href="#1-2-2-倒排索引" class="headerlink" title="1.2.2.倒排索引"></a>1.2.2.倒排索引</h3><pre><code>倒排索引中有两个非常重要的概念：

**文档(Document):**用来搜索的数据，其中每一条数据就是一个文档，类似于mysql一行。例如一个商品信息。

**词条(Term):**对文档数据或用户数据，利用某种算法分词。

                    如: 李伟好帅， 就可以分成  李伟 、好帅 这样的词条。
</code></pre>
<p>   <strong>创建倒排索引</strong>是对正向索引的一种特殊处理，流程如下：</p>
<ul>
<li><p>将每一个文档的数据利用算法分词，得到一个个词条</p>
</li>
<li><p>创建表，每行数据包括词条、词条所在文档id、位置等信息</p>
</li>
<li><p>因为词条唯一性，可以给词条创建索引，例如hash表结构索引</p>
<p>  如图：</p>
<p>  <img src="/images/image-20220312114123627.png" alt="image-20220312114123627" loading="lazy"></p>
</li>
</ul>
<p>倒排搜索的搜索流程如下(以搜索”华为手机”为例):</p>
<pre><code>    1.用户输入 &quot;华为手机&quot;进行搜索

    2.对用户内容分词，得到词条 &quot;华为&quot;、&quot;手机&quot;

    3.拿着词条在倒排索引中查找，可以 得到词条的文档id     1,2,3

    4.拿着文档id到正向索引中查找具体文档。
</code></pre>
<p><img src="/images/image-20220312114621024.png" alt="image-20220312114621024" loading="lazy"></p>
<pre><code>    虽然要先查询倒排索引，再查询倒排索引，但是无论是词条、还是文档id都建立了索引，查询速度非常快！无需全表扫描。
</code></pre>
<h3 id="1-2-3-正向和倒排"><a href="#1-2-3-正向和倒排" class="headerlink" title="1.2.3.正向和倒排"></a>1.2.3.正向和倒排</h3><p>​        </p>
<ul>
<li><p><strong>正向索引</strong>是最传统的，根据id索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是<strong>根据文档找词条的过程</strong>。</p>
</li>
<li><p>而<strong>倒排索引</strong>则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的id，然后根据id获取文档。是<strong>根据词条找文档的过程</strong>。</p>
</li>
</ul>
<p>是不是恰好反过来了？</p>
<p><strong>正向索引</strong>：</p>
<ul>
<li>优点：<ul>
<li>可以给多个字段创建索引</li>
<li>根据索引字段搜索、排序速度非常快</li>
</ul>
</li>
<li>缺点：<ul>
<li>根据非索引字段，或者索引字段中的部分词条查找时，只能全表扫描。</li>
</ul>
</li>
</ul>
<p><strong>倒排索引</strong>：</p>
<ul>
<li>优点：<ul>
<li>根据词条搜索、模糊搜索时，速度非常快</li>
</ul>
</li>
<li>缺点：<ul>
<li>只能给词条创建索引，而不是字段</li>
<li>无法根据字段做排序</li>
</ul>
</li>
</ul>
<p>1.3 es的一些概念</p>
<pre><code>    1.3.1.文档和字段

    es是面向文档(Document)存储的，文档数据会被序列化为json格式后存储在elasticsearch中:
</code></pre>
<p><img src="/images/image-20220312115025066.png" alt="image-20220312115025066" loading="lazy"></p>
<p>而Json文档中往往包含很多的<strong>字段（Field）</strong>，类似于数据库中的列。</p>
<p>1.3.2索引和映射</p>
<p><strong>索引（Index）</strong>，就是相同类型的文档的集合。可以看出mysql中的一个表</p>
<p>例如：</p>
<ul>
<li>所有用户文档，就可以组织在一起，称为用户的索引；</li>
<li>所有商品的文档，可以组织在一起，称为商品的索引；</li>
<li>所有订单的文档，可以组织在一起，称为订单的索引；</li>
</ul>
<p><img src="/images/image-20220312115112261.png" alt="image-20220312115112261" loading="lazy"></p>
<p>因此，我们可以把索引当做是数据库中的表。</p>
<p>数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有<strong>映射（mapping）</strong>，<strong>是索引中文档的字段约束信息，类似表的结构约束。</strong></p>
<h3 id="1-3-3-mysql与elasticsearch"><a href="#1-3-3-mysql与elasticsearch" class="headerlink" title="1.3.3.mysql与elasticsearch"></a>1.3.3.mysql与elasticsearch</h3><p>我们统一的把mysql与elasticsearch的概念做一下对比：</p>
<table>
<thead>
<tr>
<th><strong>MySQL</strong></th>
<th><strong>Elasticsearch</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Table</td>
<td>Index</td>
<td>索引(index)，就是文档的集合，类似数据库的表(table)</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
<td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是JSON格式</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
<td>字段（Field），就是JSON文档中的字段，类似数据库中的列（Column）</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
<td>Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
<td>DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD</td>
</tr>
</tbody></table>
<p>是不是说，我们学习了elasticsearch就不再需要mysql了呢？</p>
<p>并不是如此，两者各自有自己的擅长支出：</p>
<ul>
<li><p>Mysql：擅长事务类型操作，<strong>可以确保数据的安全和一致性</strong></p>
</li>
<li><p>Elasticsearch：擅长海量数据的搜索、分析、计算</p>
</li>
</ul>
<p>因此在企业中，往往是两者结合使用：</p>
<ul>
<li>对安全性要求较高的写操作，使用mysql实现</li>
<li>对查询性能要求较高的搜索需求，使用elasticsearch实现</li>
<li>两者再基于某种方式，实现数据的同步，保证一致性</li>
</ul>
<p><img src="/images/image-20220312115229289.png" alt="image-20220312115229289" loading="lazy"></p>
<h3 id="3-安装elasticsearch"><a href="#3-安装elasticsearch" class="headerlink" title="3.安装elasticsearch"></a>3.安装elasticsearch</h3><pre><code>1.1创建网络

因为我们还需要部署kibana容器，因此需要让es和kibana容器互联。这里先创建一个网络：
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create es-net</span><br></pre></td></tr></table></figure>

<h2 id="1-2-加载镜像"><a href="#1-2-加载镜像" class="headerlink" title="1.2.加载镜像"></a>1.2.加载镜像</h2><p>这里我们采用elasticsearch的7.12.1版本的镜像，这个镜像体积非常大，接近1G。不建议大家自己pull。</p>
<p>课前资料提供了镜像的tar包：</p>
<p><img src="/images/image-20210510165308064.png" alt="image-20210510165308064" loading="lazy"></p>
<p>大家将其上传到虚拟机中，然后运行命令加载即可：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入数据</span></span><br><span class="line">docker load -i es.tar</span><br></pre></td></tr></table></figure>

<p>同理还有<code>kibana</code>的tar包也需要这样做。</p>
<h2 id="1-3-运行"><a href="#1-3-运行" class="headerlink" title="1.3.运行"></a>1.3.运行</h2><p>运行docker命令，部署单点es：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">	--name es \</span><br><span class="line">    -e <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> \</span><br><span class="line">    -e <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">    -v es-data:/usr/share/elasticsearch/data \</span><br><span class="line">    -v es-plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">    --privileged \</span><br><span class="line">    --network es-net \</span><br><span class="line">    -p 9200:9200 \</span><br><span class="line">    -p 9300:9300 \</span><br><span class="line">elasticsearch:7.12.1</span><br></pre></td></tr></table></figure>

<p>命令解释：</p>
<ul>
<li><code>-e &quot;cluster.name=es-docker-cluster&quot;</code>：设置集群名称</li>
<li><code>-e &quot;http.host=0.0.0.0&quot;</code>：监听的地址，可以外网访问</li>
<li><code>-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</code>：内存大小</li>
<li><code>-e &quot;discovery.type=single-node&quot;</code>：非集群模式</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code>：挂载逻辑卷，绑定es的数据目录</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code>：挂载逻辑卷，绑定es的日志目录</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>：挂载逻辑卷，绑定es的插件目录</li>
<li><code>--privileged</code>：授予逻辑卷访问权</li>
<li><code>--network es-net</code> ：加入一个名为es-net的网络中</li>
<li><code>-p 9200:9200</code>：端口映射配置</li>
</ul>
<p>在浏览器中输入：<a target="_blank" rel="noopener" href="http://192.168.150.101:9200/">http://192.168.150.101:9200</a> 即可看到elasticsearch的响应结果：</p>
<p><img src="D:\BaiduNetdiskDownload\day05-Elasticsearch01\资料\assets\image-20210506101053676.png" alt="image-20210506101053676" loading="lazy"></p>
<h2 id="2-部署kibana"><a href="#2-部署kibana" class="headerlink" title="2.部署kibana"></a>2.部署kibana</h2><p>kibana可以给我们提供一个elasticsearch的可视化界面，便于我们学习。</p>
<h2 id="2-1-部署"><a href="#2-1-部署" class="headerlink" title="2.1.部署"></a>2.1.部署</h2><p>运行docker命令，部署kibana</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name kibana \</span><br><span class="line">-e ELASTICSEARCH_HOSTS=http://es:9200 \</span><br><span class="line">--network=es-net \</span><br><span class="line">-p 5601:5601  \</span><br><span class="line">kibana:7.12.1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--network es-net</code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</li>
<li><code>-p 5601:5601</code>：端口映射配置</li>
</ul>
<p>kibana启动一般比较慢，需要多等待一会，可以通过命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f kibana</span><br></pre></td></tr></table></figure>

<p>查看运行日志，当查看到下面的日志，说明成功：</p>
<p><img src="D:\BaiduNetdiskDownload\day05-Elasticsearch01\资料\assets\image-20210109105135812.png" alt="image-20210109105135812" loading="lazy"></p>
<p>此时，在浏览器输入地址访问：<a href="http://192.168.150.101:5601，即可看到结果">http://192.168.150.101:5601，即可看到结果</a></p>
<h2 id="2-2-DevTools"><a href="#2-2-DevTools" class="headerlink" title="2.2.DevTools"></a>2.2.DevTools</h2><p>kibana中提供了一个DevTools界面：</p>
<p><img src="/images/image-20210506102630393.png" alt="image-20210506102630393" loading="lazy"></p>
<p>这个界面中可以编写DSL来操作elasticsearch。并且对DSL语句有自动补全功能。</p>
<h2 id="3-安装IK分词器"><a href="#3-安装IK分词器" class="headerlink" title="3.安装IK分词器"></a>3.安装IK分词器</h2><h2 id="3-1-在线安装ik插件（较慢）"><a href="#3-1-在线安装ik插件（较慢）" class="headerlink" title="3.1.在线安装ik插件（较慢）"></a>3.1.在线安装ik插件（较慢）</h2><p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a> github ik下载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入容器内部</span></span><br><span class="line">docker exec -it elasticsearch /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在线下载并安装</span></span><br><span class="line">./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">退出</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>

<h2 id="3-2-离线安装ik插件（推荐）"><a href="#3-2-离线安装ik插件（推荐）" class="headerlink" title="3.2.离线安装ik插件（推荐）"></a>3.2.离线安装ik插件（推荐）</h2><h3 id="1）查看数据卷目录"><a href="#1）查看数据卷目录" class="headerlink" title="1）查看数据卷目录"></a>1）查看数据卷目录</h3><p>安装插件需要知道elasticsearch的plugins目录位置，而我们用了数据卷挂载，因此需要查看elasticsearch的数据卷目录，通过下面命令查看:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect es-plugins</span><br></pre></td></tr></table></figure>

<p>显示结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-05-06T10:06:34+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/es-plugins/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es-plugins&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>说明plugins目录被挂载到了：<code>/var/lib/docker/volumes/es-plugins/_data </code>这个目录中。</p>
<h3 id="2）解压缩分词器安装包"><a href="#2）解压缩分词器安装包" class="headerlink" title="2）解压缩分词器安装包"></a>2）解压缩分词器安装包</h3><p>下面我们需要把课前资料中的ik分词器解压缩，重命名为ik</p>
<p><img src="/images/image-20210506110249144.png" alt="image-20210506110249144" loading="lazy"></p>
<h3 id="3）上传到es容器的插件数据卷中"><a href="#3）上传到es容器的插件数据卷中" class="headerlink" title="3）上传到es容器的插件数据卷中"></a>3）上传到es容器的插件数据卷中</h3><p>也就是<code>/var/lib/docker/volumes/es-plugins/_data </code>：</p>
<p><img src="D:\BaiduNetdiskDownload\day05-Elasticsearch01\资料\assets\image-20210506110704293.png" alt="image-20210506110704293" loading="lazy"></p>
<h3 id="4）重启容器"><a href="#4）重启容器" class="headerlink" title="4）重启容器"></a>4）重启容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4、重启容器</span></span><br><span class="line">docker restart es</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看es日志</span></span><br><span class="line">docker logs -f es</span><br></pre></td></tr></table></figure>

<h3 id="5）测试："><a href="#5）测试：" class="headerlink" title="5）测试："></a>5）测试：</h3><p>IK分词器包含两种模式：</p>
<ul>
<li><p><code>ik_smart</code>：最少切分</p>
</li>
<li><p><code>ik_max_word</code>：最细切分</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;黑马程序员学习java太棒了&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;黑马&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;程序员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;程序&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;学习&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ENGLISH&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;太棒了&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;太棒&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;了&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h2 id="3-3-扩展词词典"><a href="#3-3-扩展词词典" class="headerlink" title="3.3 扩展词词典"></a>3.3 扩展词词典</h2><pre><code>    随着互联网的发展，“造词运动”也越发的频繁。出现了很多新的词语，在原有的词汇列表中并不存在。比如：“**白嫖”，“嘤嘤怪**” 等。
</code></pre>
<p>所以我们的词汇也需要不断的更新，IK分词器提供了扩展词汇的功能。</p>
<p>1）打开IK分词器config目录：</p>
<p><img src="/images/image-20210506112225508.png" alt="image-20210506112225508" loading="lazy"></p>
<p>2）在IKAnalyzer.cfg.xml配置文件内容添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>start.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）新建一个 start.dic，可以参考config目录下复制一个配置文件进行修改</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">白嫖</span></span><br><span class="line"><span class="attr">嘤嘤怪</span></span><br></pre></td></tr></table></figure>

<p>4）重启elasticsearch </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker restart es</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 日志</span></span><br><span class="line">docker logs -f es</span><br></pre></td></tr></table></figure>

<p><img src="D:\BaiduNetdiskDownload\day05-Elasticsearch01\资料\assets\image-20201115230900504.png" alt="image-20201115230900504" loading="lazy"></p>
<p>日志中已经成功加载ext.dic配置文件</p>
<p>5）测试效果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;嘤嘤怪白嫖学Java就业超过90%,奥力给！&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220312135108857.png" alt="image-20220312135108857" loading="lazy"></p>
<p><strong>就是对ik分词器进行扩展，添加一些没有的词组。</strong></p>
<h2 id="3-4分词器"><a href="#3-4分词器" class="headerlink" title="3.4分词器"></a>3.4分词器</h2><p>分词器的作用是什么？</p>
<ul>
<li>创建倒排索引时对文档分词</li>
<li>用户搜索时，对输入的内容分词</li>
</ul>
<p>IK分词器有几种模式？</p>
<ul>
<li>ik_smart：智能切分，粗粒度</li>
<li>ik_max_word：最细切分，细粒度</li>
</ul>
<h2 id="4-索引库的操作-相当于Mysql对表的操作"><a href="#4-索引库的操作-相当于Mysql对表的操作" class="headerlink" title="4.索引库的操作 (相当于Mysql对表的操作)"></a>4.索引库的操作 (相当于Mysql对表的操作)</h2><h2 id="4-1-mapping属性-约束"><a href="#4-1-mapping属性-约束" class="headerlink" title="4.1 mapping属性 (约束)"></a>4.1 mapping属性 (约束)</h2><pre><code>    **type**: 字段数据类型，常见的简单类型有:

            字符串: text(可分词的文本)、keyword(精确值，例如国家、品牌、姓名、ip地址等)分开了就没有意义。

            数值: long、integer、short、byte、double 、float

            布尔: boolean  (true  false)

            日期: date

            对象: object

    **index**: 是否创建索引，查找，默认为true。

    **analyzer**: 使用哪种分词器

    **properties**: 该字段的子字段
</code></pre>
<p><img src="/images/image-20220312145238953.png" alt="image-20220312145238953" loading="lazy"></p>
<h2 id="4-2创建表-create-table"><a href="#4-2创建表-create-table" class="headerlink" title="4.2创建表(create table)"></a>4.2创建表(create table)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /索引库名</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span>  </span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3查询索引库-show-tables"><a href="#4-3查询索引库-show-tables" class="headerlink" title="4.3查询索引库(show tables)"></a>4.3查询索引库(show tables)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220312145747886.png" alt="image-20220312145747886" loading="lazy"></p>
<p>4.4修改索引库</p>
<pre><code>es 是不允许修改索引库,索引库**一旦创建，无法修改mapping**。

但是可以向索引库中添加新字段

#修改索引库
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /xiaozhi/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;:&#123;</span><br><span class="line">    &quot;字段名&quot;:&#123;</span><br><span class="line">      &quot;type&quot;:&quot;integer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>    不能想索引库中添加已有的字段，否则报错。
</code></pre>
<h2 id="4-4删除索引库"><a href="#4-4删除索引库" class="headerlink" title="4.4删除索引库"></a>4.4删除索引库</h2><p>​        </p>
<pre><code>    #删除索引库
    DELETE /xiaozhi
</code></pre>
<h2 id="4-5总结"><a href="#4-5总结" class="headerlink" title="4.5总结"></a>4.5总结</h2><p>索引库操作有哪些？</p>
<ul>
<li>创建索引库：PUT /索引库名</li>
<li>查询索引库：GET /索引库名</li>
<li>删除索引库：DELETE /索引库名</li>
<li>添加字段：PUT /索引库名/_mapping</li>
</ul>
<h2 id="5-文档操作"><a href="#5-文档操作" class="headerlink" title="5.文档操作"></a>5.文档操作</h2><h2 id="5-1-新增文档"><a href="#5-1-新增文档" class="headerlink" title="5.1 新增文档"></a>5.1 新增文档</h2><p>​        </p>
<p>POST /索引库名/<strong>_doc</strong>/文档id<br>{</p>
<pre><code>            &quot;字段1&quot;: &quot;value&quot;,

            &quot;字段2&quot;: &quot;value&quot;,

                        .
</code></pre>
<p>}    </p>
<pre><code>    文档id ，自己设定，如果自己不设置，则 es 自动设置
</code></pre>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /xiaozhi/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="string">&quot;李伟好帅&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;lixiaozhi@hotmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;李&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="string">&quot;伟&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-查询文档"><a href="#5-2-查询文档" class="headerlink" title="5.2 查询文档"></a>5.2 查询文档</h2><pre><code>    GET /索引库名/文档id

    #查询文档
    GET /xiaozhi/_doc/1
</code></pre>
<h2 id="5-3-删除文档"><a href="#5-3-删除文档" class="headerlink" title="5.3 删除文档"></a>5.3 删除文档</h2><pre><code>    DELETE /索引库名/文档id
</code></pre>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#删除文档</span><br><span class="line">DELETE /xiaozhi/_doc/<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="5-6-修改文档"><a href="#5-6-修改文档" class="headerlink" title="5.6 修改文档"></a>5.6 修改文档</h2><pre><code> **方式一:  全量修改，会删除旧文档，添加新文档。**

     **PUT** /索引库名/**_doc**/文档id
</code></pre>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /xiaozhi/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;liwei@hotmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;李&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="string">&quot;先生&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>	</span><br></pre></td></tr></table></figure>

<pre><code>  方式二:  增量(局部)修改，修改指定字段值

   **POST** /索引库名/**_update**/文档id
</code></pre>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /xiaozhi/_update/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="string">&quot;李伟超级帅，希望将来的一天能过上好日子&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;313178628@qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;QQ&quot;</span><span class="punctuation">:</span><span class="number">313178628</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="6-RestAPI"><a href="#6-RestAPI" class="headerlink" title="6.RestAPI"></a>6.RestAPI</h2><p>数据结构如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_hotel` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店名称；例：7天酒店&#x27;</span>,</span><br><span class="line">  `address` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店地址；例：航头路&#x27;</span>,</span><br><span class="line">  `price` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店价格；例：329&#x27;</span>,</span><br><span class="line">  `score` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店评分；例：45，就是4.5分&#x27;</span>,</span><br><span class="line">  `brand` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店品牌；例：如家&#x27;</span>,</span><br><span class="line">  `city` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;所在城市；例：上海&#x27;</span>,</span><br><span class="line">  `star_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店星级，从低到高分别是：1星到5星，1钻到5钻&#x27;</span>,</span><br><span class="line">  `business` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商圈；例：虹桥&#x27;</span>,</span><br><span class="line">  `latitude` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;纬度；例：31.2497&#x27;</span>,</span><br><span class="line">  `longitude` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经度；例：120.3925&#x27;</span>,</span><br><span class="line">  `pic` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;酒店图片；例:/img/1.jpg&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<p>来看下酒店数据的索引库结构:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">PUT /hotel</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;starName&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;business&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>几个特殊字段说明：</p>
<ul>
<li>location：地理坐标，里面包含精度、纬度</li>
<li>all：一个组合字段，其目的是将多字段的值 利用copy_to合并，提供给用户搜索</li>
</ul>
<p><img src="/images/image-20220315194847616.png" alt="image-20220315194847616" loading="lazy"></p>
<p>copy_to说明：</p>
<p><img src="/images/image-20220315194904634.png" alt="image-20220315194904634" loading="lazy"></p>
<h2 id="6-1初始化RestClient"><a href="#6-1初始化RestClient" class="headerlink" title="6.1初始化RestClient"></a>6.1初始化RestClient</h2><p>在elasticsearch提供的API中，与elasticsearch一切交互都封装在一个名为RestHighLevelClient的类中，必须先完成这个对象的初始化，建立与elasticsearch的连接。</p>
<p>分为三步：</p>
<p>1.引入es的RestHighLevelClient依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.因为SpringBoot默认的ES版本是7.6.2，所以我们需要覆盖默认的ES版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.初始化RestHighLevelClient</p>
<p>初始化的代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RestHighLevelClient client <span class="operator">=</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(</span><br><span class="line">        HttpHost.create(&quot;http://192.168.150.101:9200&quot;)</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<h2 id="6-2创建索引库"><a href="#6-2创建索引库" class="headerlink" title="6.2创建索引库"></a>6.2创建索引库</h2><p>.1代码解读</p>
<p><img src="/images/image-20220315195214507.png" alt="image-20220315195214507" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"> <span class="meta">@BeforeEach</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">bf</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        HttpHost.create(<span class="string">&quot;http://192.168.179.132:9200&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span>  <span class="comment">//创建索引库</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mapp</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.创建Request对象</span></span><br><span class="line">    <span class="type">CreateIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>); <span class="comment">//索引库名</span></span><br><span class="line">    <span class="comment">//2. 请求参数 </span></span><br><span class="line">    request.source(Tools.MAPPING_TEMPLATE, XContentType.JSON); <span class="comment">// Tools.MAPPING_TEMPLATE 对应的dsl语句</span></span><br><span class="line">    <span class="comment">//3.发送请求</span></span><br><span class="line">    client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码分为三步:</p>
<pre><code>    1.创建Request对象.因为是创建索引库的操作,因此Requestt是CreateIndexRequest.

    2.添加请求参数,其实就是DSL的json参数部分.因为json字符串很长,就封装到了 Tools类中。

    3.发送请求,client.indices()方法返回值IndicesClient类型,封装了索引库操作有关的方法。
</code></pre>
<h2 id="6-3删除索引库"><a href="#6-3删除索引库" class="headerlink" title="6.3删除索引库"></a>6.3删除索引库</h2><p>删除索引库的DSL语句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /hotel</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">DeleteIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    client.indices().delete(request,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4查看索引库是否存在"><a href="#6-4查看索引库是否存在" class="headerlink" title="6.4查看索引库是否存在"></a>6.4查看索引库是否存在</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断索引库是否存在</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exist</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">GetIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> client.indices().exists(request,RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists?<span class="string">&quot;存在&quot;</span>:<span class="string">&quot;不存在&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除和查看索引库无需传递参数。</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结:"></a>小结:</h2><pre><code>    索引库操作的基本步骤:

            初始化RestHighLeveClient

            创建XxxIndexRequest  Xxx是Create、Get、Delete

            准备DSL(Create时需要)

            发送请求.调用RestHighLevelClient # indices().xxx()方法，xxx是create、exists、delete
</code></pre>
<h2 id="6-5文档操作"><a href="#6-5文档操作" class="headerlink" title="6.5文档操作"></a>6.5文档操作</h2><h3 id="6-5-1插入文档"><a href="#6-5-1插入文档" class="headerlink" title="6.5.1插入文档"></a>6.5.1插入文档</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /索引库/_doc/id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	 <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span><span class="string">&quot;李伟好帅。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  	 <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;lixiaozhi@hotmail.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  	 <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;李&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="string">&quot;伟&quot;</span></span><br><span class="line"> 	 <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过酒店id从数据库中获取对应数据,然后将数据序列化插入到索引库。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertdoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.根据id查询酒店数据</span></span><br><span class="line">    <span class="type">Hotel</span> <span class="variable">hotel</span> <span class="operator">=</span> hotelService.getById(<span class="number">61083L</span>);</span><br><span class="line">    <span class="comment">// 2.转换为文档类型</span></span><br><span class="line">    <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">    <span class="comment">// 3.将HotelDoc转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(hotelDoc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.准备Request对象</span></span><br><span class="line">    <span class="type">IndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(hotelDoc.getId().toString());</span><br><span class="line">    <span class="comment">// 2.准备Json文档</span></span><br><span class="line">    request.source(json, XContentType.JSON);</span><br><span class="line">    <span class="comment">// 3.发送请求</span></span><br><span class="line">    client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>id(String id) 因为es都是 字符串类型</p>
<p>JSON.toJSON(hotelDoc) 将 对象序列化为json对象。</p>
<h3 id="6-5-1获取文档"><a href="#6-5-1获取文档" class="headerlink" title="6.5.1获取文档"></a>6.5.1获取文档</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库/_doc/文档id</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.准备Request</span></span><br><span class="line"><span class="type">GetRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;61083&quot;</span>);</span><br><span class="line"><span class="comment">// 2.发送请求，得到响应</span></span><br><span class="line"><span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.get(request, RequestOptions.DEFAULT);</span><br><span class="line"><span class="comment">// 3.解析响应结果</span></span><br><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> response.getSourceAsString();</span><br><span class="line">System.out.println(json);</span><br><span class="line"><span class="comment">//将json 字符串反序列化为java对象</span></span><br><span class="line"><span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(json, HotelDoc.class);</span><br><span class="line">System.out.println(hotelDoc);</span><br></pre></td></tr></table></figure>



<h3 id="6-5-2更新文档"><a href="#6-5-2更新文档" class="headerlink" title="6.5.2更新文档"></a>6.5.2更新文档</h3><p>方式一  全量修改 ，如果指定id不存在,则变成新增加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /xiaozhi/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;email&quot;:&quot;liwei@hotmail.com&quot;,</span><br><span class="line">  &quot;name&quot;:&#123;</span><br><span class="line">    &quot;firstName&quot;:&quot;李&quot;,</span><br><span class="line">    &quot;lastName&quot;:&quot;先生&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二 增量修改 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /xiaozhi/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;   </span><br><span class="line">      &quot;info&quot;:&quot;李伟超级帅&quot;,</span><br><span class="line">      &quot;email&quot;:&quot;313178628@qq.com&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">UpdateRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;61083&quot;</span>);</span><br><span class="line">    request.doc(</span><br><span class="line">            <span class="string">&quot;price&quot;</span>,<span class="string">&quot;666&quot;</span>,</span><br><span class="line">            <span class="string">&quot;starName&quot;</span>,<span class="string">&quot;八壮&quot;</span></span><br><span class="line">    );</span><br><span class="line">    client.update(request,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-3删除文档"><a href="#6-5-3删除文档" class="headerlink" title="6.5.3删除文档"></a>6.5.3删除文档</h3><p>DELETE /索引库/id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDoc</span><span class="params">()</span><span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">    <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;hotel&quot;</span>, <span class="string">&quot;36934&quot;</span>);</span><br><span class="line">    client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结:</p>
<p>文档操作有哪些？</p>
<ul>
<li>创建文档：POST /{索引库名}/_doc/文档id   { json文档 }</li>
<li>查询文档：GET /{索引库名}/_doc/文档id</li>
<li>删除文档：DELETE /{索引库名}/_doc/文档id</li>
<li>修改文档：<ul>
<li>全量修改：PUT /{索引库名}/_doc/文档id { json文档 }</li>
<li>增量修改：POST /{索引库名}/_update/文档id { “doc”: {字段}}</li>
</ul>
</li>
</ul>
<h3 id="6-5-4批量插入"><a href="#6-5-4批量插入" class="headerlink" title="6.5.4批量插入"></a>6.5.4批量插入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//批量插入</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">batchIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Hotel&gt; hotels = hotelService.list();</span><br><span class="line">    <span class="comment">//从数据库中查询数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建BulkRequest对象</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Hotel hotel : hotels) &#123;</span><br><span class="line">        <span class="comment">//将 hotel对象转换为 hotelDoc对象</span></span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">        <span class="comment">//将 IndexRequest对象添加到 bulkRequest中</span></span><br><span class="line">        bulkRequest.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>)</span><br><span class="line">                .id(hotelDoc.getId().toString())</span><br><span class="line">                .source(JSON.toJSON(hotel),XContentType.JSON));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发送请求</span></span><br><span class="line">    client.bulk(bulkRequest,RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-5-4-1语法说明"><a href="#6-5-4-1语法说明" class="headerlink" title="6.5.4.1语法说明"></a>6.5.4.1语法说明</h4><pre><code>    批量处理BulkRequest，其本质就是将多个**普通的CRUD请求组合在一起发送**。
</code></pre>
<p>其中提供了一个add方法，用来添加其他请求：</p>
<p><img src="/images/image-20220317130817457.png" alt="image-20220317130817457" loading="lazy"></p>
<p>可以看到，能添加的请求包括：</p>
<ul>
<li>IndexRequest，也就是新增</li>
<li>UpdateRequest，也就是修改</li>
<li>DeleteRequest，也就是删除</li>
</ul>
<h3 id="6-6-小结"><a href="#6-6-小结" class="headerlink" title="6.6.小结"></a>6.6.小结</h3><p>文档操作的基本步骤：</p>
<ul>
<li>初始化RestHighLevelClient</li>
<li>创建XxxRequest。XXX是Index、Get、Update、Delete、Bulk</li>
<li>准备参数（Index、Update、Bulk时需要）</li>
<li>发送请求。调用RestHighLevelClient#.xxx()方法，xxx是index、get、update、delete、bulk</li>
<li>解析结果（Get时需要）</li>
</ul>
<h2 id="DSL查询文档"><a href="#DSL查询文档" class="headerlink" title="DSL查询文档"></a>DSL查询文档</h2><h2 id="1-1DSL查询分类"><a href="#1-1DSL查询分类" class="headerlink" title="1.1DSL查询分类"></a>1.1DSL查询分类</h2><p><strong>查询所有</strong>: 查询出所有数据，一般测试用。例如:</p>
<pre><code>match_all
</code></pre>
<p><strong>全文检索(full text) 查询</strong>: 利用分词器对用户输入内容进行分词，然后去倒排索引库中匹配。例如:</p>
<ul>
<li><pre><code>    match_query
</code></pre>
</li>
<li><pre><code>    multi_match_query
</code></pre>
</li>
</ul>
<p><strong>精确查询</strong>: 根据精确词条值查找数据，一般是查找     keyword、数值、日期、boolean等类型字段。例如:</p>
<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
<p><strong>地理(geo)查询</strong>: 根据经纬度查询。例如:</p>
<ul>
<li><pre><code>geo_distance
</code></pre>
</li>
<li><pre><code>geo_bounding_box
</code></pre>
</li>
</ul>
<p><strong>复合(compound)查询</strong>: 复合查询可以将上述各种查询条件组合起来，合并查询条件。例如:</p>
<ul>
<li><pre><code>bool
</code></pre>
</li>
<li><pre><code>function_score
</code></pre>
</li>
</ul>
<p>基本的语法基本一致</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line"></span><br><span class="line">    &quot;查询类型&quot;:&#123;</span><br><span class="line"></span><br><span class="line">    	&quot;查询条件&quot;: &quot;条件值&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以查询所有为例，其中：</p>
<pre><code>查询类型为match_all

没有查询条件
</code></pre>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其他查询无非就是查询类型、查询条件的变化。</p>
<h2 id="1-2全文检索查询"><a href="#1-2全文检索查询" class="headerlink" title="1.2全文检索查询"></a>1.2全文检索查询</h2><h3 id="1-2-1使用场景"><a href="#1-2-1使用场景" class="headerlink" title="1.2.1使用场景"></a>1.2.1使用场景</h3><p>全文检索查询的基本流程如下:</p>
<ul>
<li><pre><code>    对用户搜索的内容做分词，得到词条
</code></pre>
</li>
<li><pre><code>    根据词条去倒排索引库中匹配，得到文档id
</code></pre>
</li>
<li><pre><code>    根据文档id找到文档，返回给用户
</code></pre>
</li>
</ul>
<p>比较常见场景:</p>
<pre><code>商城的输入框搜索

百度输入框搜索
</code></pre>
<p><strong>因为是拿着词条去匹配</strong>，因此参与搜索的字段也必须是可分词的text类型的字段。</p>
<h3 id="1-2-2基本语法"><a href="#1-2-2基本语法" class="headerlink" title="1.2.2基本语法"></a>1.2.2基本语法</h3><p>常见的全文检索查询包括:</p>
<ul>
<li><pre><code>    match查询:    单字段查询
</code></pre>
</li>
<li><pre><code>    multi_match查询:    多字段查询,任意一个字段符合条件就算符合查询条件
</code></pre>
</li>
<li><pre><code>    match_all 查询所有
</code></pre>
</li>
</ul>
<p>match查询语法如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;字段&quot;</span><span class="punctuation">:</span> <span class="string">&quot;条件值&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>multi_match查询语法如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;条件值&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;字段1&quot;</span><span class="punctuation">,</span><span class="string">&quot;字段2&quot;</span><span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>match_all语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /indeNmae/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>match栗子:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span> <span class="string">&quot;外滩&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220317165321711.png" alt="image-20220317165321711" loading="lazy"></p>
<p><img src="/images/image-20220317165426380.png" alt="image-20220317165426380" loading="lazy"></p>
<p>multi_match栗子:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="string">&quot;外滩&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;city&quot;</span><span class="punctuation">,</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;business&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220317165617619.png" alt="image-20220317165617619" loading="lazy"></p>
<p>可以看到，两种查询结果是一样的，为什么?</p>
<p>因为我们将city name business值都利用copy_to复制到了all字段中。因此你根据三个字段搜索，和根据all字段搜索效果当然一样了。</p>
<p>但是，搜索字段越多，对查询性能影响越大，因此建议采用copy_to，然后单字段查询的方式。</p>
<h3 id="1-2-3总结"><a href="#1-2-3总结" class="headerlink" title="1.2.3总结"></a>1.2.3总结</h3><pre><code>match和multi_match的区别是什么？

match: 根据一个字段查询

multi_match:根据多个字段查询,查询字段越多,查询性能越差。
</code></pre>
<h2 id="1-3精准查询"><a href="#1-3精准查询" class="headerlink" title="1.3精准查询"></a>1.3精准查询</h2><p>精准查询是查找keyword、数值、日期、boolean等类型字段。所以不会对搜索条件分词。常见的有</p>
<pre><code>term:     精确值查询  A=B的形式

range:    范围内查询  类似于    a &lt; value &lt; b
</code></pre>
<h3 id="1-3-1-term查询"><a href="#1-3-1-term查询" class="headerlink" title="1.3.1 term查询"></a>1.3.1 term查询</h3><p>因为精确查询字段搜的是不分词字段，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p>
<p>语法说明:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;字段&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;VALUE&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>栗子:</p>
<p>#精确查询  term 精确值 查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;北京&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220317195518450.png" alt="image-20220317195518450" loading="lazy"></p>
<p>但是，当我搜索的内容不是词条，而是多个词语形成的短语时，反而搜索不到：</p>
<p><img src="/images/image-20220317195601832.png" alt="image-20220317195601832" loading="lazy"></p>
<h3 id="1-3-2-range查询"><a href="#1-3-2-range查询" class="headerlink" title="1.3.2.range查询"></a>1.3.2.range查询</h3><p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。</p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// range查询</span></span><br><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;字段&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="comment">// 这里的gte代表大于等于，gt则代表大于</span></span><br><span class="line">        <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">20</span> <span class="comment">// lte代表小于等于，lt则代表小于</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>栗子:</p>
<p>#精确查询 range 范围查询  查询price 在 2688 到 3000之间</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gt&quot;</span><span class="punctuation">:</span> <span class="number">2688</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">3000</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220317200021864.png" alt="image-20220317200021864" loading="lazy"></p>
<h3 id="1-3-3总结"><a href="#1-3-3总结" class="headerlink" title="1.3.3总结"></a>1.3.3总结</h3><p>精确查询常见的有哪些?</p>
<ul>
<li>term查询:根据词条精确匹配,一般搜索keyword类型、数值类型、布尔类型、日期类型字段</li>
<li>range查询:根据数值范围查询，可以是数值、日期的范围。</li>
</ul>
<h2 id="1-4地理坐标查询"><a href="#1-4地理坐标查询" class="headerlink" title="1.4地理坐标查询"></a>1.4地理坐标查询</h2><p>所谓的地理坐标查询,其实就是根据经纬度查询。</p>
<p>常见的使用场景包括:</p>
<pre><code>    携程:搜索附近的酒店

    滴滴:搜索附近出租车

    微信:搜索附近的人
</code></pre>
<h3 id="1-4-1-geo-biunding-box-矩形范围查询"><a href="#1-4-1-geo-biunding-box-矩形范围查询" class="headerlink" title="1.4.1(geo_biunding_box)矩形范围查询."></a>1.4.1(geo_biunding_box)矩形范围查询.</h3><pre><code>查询坐标落在某个矩形范围的所有文档。

![DKV9HZbVS6](file://D:\BaiduNetdiskDownload\day06-Elasticsearch02\%E8%AE%B2%E4%B9%89\assets\DKV9HZbVS6.gif?lastModify=1647592064)

查询时,需要指定矩形的左上、右下两个点的坐标,然后画出一个矩形,落在该矩形内都是符合条件的点。
</code></pre>
<p>语法查询:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;geo_bounding_box&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;top_left&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">//左上点</span></span><br><span class="line">					<span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span><span class="number">31.1</span></span><br><span class="line">					<span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span><span class="number">121.5</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;bottom_right&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span><span class="number">30.9</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span><span class="number">127.7</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span>	</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220318164056473.png" alt="image-20220318164056473" loading="lazy"></p>
<h2 id="1-4-2-geo-distance-圆环查询"><a href="#1-4-2-geo-distance-圆环查询" class="headerlink" title="1.4.2(geo_distance)圆环查询"></a>1.4.2(geo_distance)圆环查询</h2><p>附近查询,也叫做距离查询(geo_disance):查询到指定中心点小于某个距离值的所有文档。</p>
<p>换句话来说，在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p>
<p><img src="file://D:\BaiduNetdiskDownload\day06-Elasticsearch02%E8%AE%B2%E4%B9%89\assets\vZrdKAh19C.gif?lastModify=1647592987" alt="vZrdKAh19C" loading="lazy"></p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /indexName/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;distance&quot;</span><span class="punctuation">:</span><span class="string">&quot;3km&quot;</span><span class="punctuation">,</span> <span class="comment">//半径</span></span><br><span class="line">			<span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;31.21,121.5&quot;</span> <span class="comment">//圆心</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220318165102334.png" alt="image-20220318165102334" loading="lazy"></p>
<h2 id="1-5复合查询"><a href="#1-5复合查询" class="headerlink" title="1.5复合查询"></a>1.5复合查询</h2><p>复合(compound)查询: 复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：</p>
<ul>
<li>function score: 算分函数查询,可以控制文档相关性算分，控制文档排名</li>
<li>boolquery:布尔查询,利用逻辑关系组合多个其他的查询，实现复杂搜索</li>
</ul>
<h3 id="1-5-1算分函数查询"><a href="#1-5-1算分函数查询" class="headerlink" title="1.5.1算分函数查询"></a>1.5.1算分函数查询</h3><p>根据相关度打分是比较合理的需求，但<strong>合理的不一定是产品经理需要</strong>的。</p>
<p>以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁掏的钱多排名就越靠前。</p>
<p>要想认为控制相关性算分，就需要利用elasticsearch中的function score 查询了。</p>
<p>语法说明:</p>
<p><img src="/images/image-20220318170714395.png" alt="image-20220318170714395" loading="lazy"></p>
<p>function score查询中包含四部分内容:</p>
<pre><code>    原始查询条件: query部分,基于这个条件搜索文档,并且基于BM25算法给文档打分,**原始算分**(**query** **score**)

    过滤条件: filter部分,符合该条件的文档才会重新算分。

    算分函数:覅喝filter条件的文档要根据这个函数做运算，**得到的函数算分**(function score),有四种函数

    weight:函数结果是常量

    field_value_factor:  以文档中的某个字段值作为函数结果。

    random_score: 以随机数作为函数结果。

    script_score: 自定义算分函数算法
</code></pre>
<p>运算模式:算分函数的结果＼原始查询的相关性算分，两者之间的运算分式，包括：</p>
<ul>
<li>multiply：相乘</li>
<li>replace：用function score替换query score</li>
<li>其他，例如：sum、avg、max、min</li>
</ul>
<p>function score的运行流程如下：</p>
<ul>
<li>1）根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong>（query score）</li>
<li>2）根据<strong>过滤条件</strong>，过滤文档</li>
<li>3）符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong>（function score）</li>
<li>4）将<strong>原始算分</strong>（query score）和<strong>函数算分</strong>（function score）基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li>
</ul>
<p>因此，其中的关键点是：</p>
<ul>
<li>过滤条件：决定哪些文档的算分被修改</li>
<li>算分函数：决定函数算分的算法</li>
<li>运算模式：决定最终算分结果</li>
</ul>
<p>栗子:      </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;function_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;上海&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;functions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;如家&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;boost_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p> 测试，在未添加算分函数时，如家得分如下：</p>
<p><img src="D:\BaiduNetdiskDownload\day06-Elasticsearch02\讲义\assets\image-20210721193152520.png" alt="image-20210721193152520" loading="lazy"></p>
<p>添加了算分函数后，如家得分就提升了：</p>
<p><img src="D:\BaiduNetdiskDownload\day06-Elasticsearch02\讲义\assets\image-20210721193458182.png" alt="image-20210721193458182" loading="lazy"></p>
<h4 id="）小结"><a href="#）小结" class="headerlink" title="）小结"></a>）小结</h4><p>function score query定义的三要素是什么？</p>
<ul>
<li>过滤条件：哪些文档要加分</li>
<li>算分函数：如何计算function score</li>
<li>加权方式：function score 与 query score如何运算</li>
</ul>
<h3 id="1-5-3-布尔查询-bool"><a href="#1-5-3-布尔查询-bool" class="headerlink" title="1.5.3 布尔查询 bool"></a>1.5.3 布尔查询 bool</h3><p>布尔查询是一个或多个查询字句的组合，<strong>每一个子句就是一个子查询</strong>。子查询的组合方式有:</p>
<ul>
<li><pre><code>must:必须匹配每个子查询，类似 &quot;与&quot;
</code></pre>
</li>
<li><pre><code>should:选择性匹配子查询，类似于&quot;或&quot;
</code></pre>
</li>
<li><pre><code>must_not:必须不匹配，不参与算分，类似 &quot;非&quot;
</code></pre>
</li>
<li><pre><code>filter: 必须匹配,不参与算分
</code></pre>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;上海&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;皇冠假日&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华美达&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">500</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">45</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>栗子</p>
<p>需求：搜索名字包含“如家”，价格不高于400，在坐标31.21,121.5周围10km范围内的酒店。</p>
<p>分析：</p>
<ul>
<li>名称搜索，属于全文检索查询，应该参与算分。放到must中</li>
<li>价格不高于400，用range查询，属于过滤条件，不参与算分。放到must_not中</li>
<li>周围10km范围内，用geo_distance查询，属于过滤条件，不参与算分。放到filter中</li>
</ul>
<p>栗子</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line"><span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;如家&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gt&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;geo_distance&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;distance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10km&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span> <span class="number">31.21</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span> <span class="number">121.5</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/image-20220318181536055.png" alt="image-20220318181536055" loading="lazy"></p>
<h4 id="3）小结"><a href="#3）小结" class="headerlink" title="3）小结"></a>3）小结</h4><p>bool查询有几种逻辑关系？</p>
<ul>
<li>must：必须匹配的条件，可以理解为“与”</li>
<li>should：选择性匹配的条件，可以理解为“或”</li>
<li>must_not：必须不匹配的条件，不参与打分</li>
<li>filter：必须匹配的条件，不参与打分</li>
</ul>
<h2 id="2-搜索结果处理"><a href="#2-搜索结果处理" class="headerlink" title="2.搜索结果处理"></a>2.搜索结果处理</h2><p>搜索的结果可以按照用户指定的方式去处理或展示。</p>
<h3 id="2-1排序"><a href="#2-1排序" class="headerlink" title="2.1排序"></a>2.1排序</h3><p>elasticsearch默认是根据相关度算分(_score)来排序,但也支持自定义方式对<strong>搜索结果排序</strong>。可以排序字段类型有:</p>
<p>keyword类型、数值类型、地理坐标类型、日期类型等。</p>
<h4 id="2-1-1普通字段排序"><a href="#2-1-1普通字段排序" class="headerlink" title="2.1.1普通字段排序"></a>2.1.1普通字段排序</h4><p>keyword、数值、日期类型语法基本一致。</p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span> <span class="comment">//升序</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span> <span class="comment">//降序</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure>

<p><strong>栗子</strong>：</p>
<p>需求描述：酒店数据按照用户评价（score)降序排序，评价相同的按照价格(price)升序排序</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span> <span class="string">&quot;如家&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>sort 是一个数组，也就是说明可以多字段排序。</p>
<h4 id="2-1-2地理坐标排序"><a href="#2-1-2地理坐标排序" class="headerlink" title="2.1.2地理坐标排序"></a>2.1.2地理坐标排序</h4><p>地理坐标略有不同</p>
<p>语法:</p>
<p>​    </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span> <span class="string">&quot;外滩&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span><span class="string">&quot;维度,经度&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span><span class="punctuation">,</span> <span class="comment">//排序方式</span></span><br><span class="line">        <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="string">&quot;km&quot;</span> <span class="comment">//排序的距离单位</span></span><br><span class="line">      <span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>  这个查询的含义是:</p>
<ul>
<li><pre><code>指定一个坐标,作为目标点
</code></pre>
</li>
<li><pre><code>计算每一个文档中,指定字段(必须是geo_point类型)的坐标到目标点的距离是多少
</code></pre>
</li>
<li><pre><code>根据距离排序
</code></pre>
</li>
</ul>
<p>栗子:</p>
<p>对字段有外滩有<strong>外滩</strong>经纬度: 31.245409, 121.492969 的 酒店,</p>
<p>寻找我周围距离最近的酒店。</p>
<p>GET /hotel/_search<br>{<br>  “query”: {</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span> <span class="string">&quot;外滩&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_geo_distance&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="string">&quot;31.245409, 121.492969&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="string">&quot;km&quot;</span></span><br><span class="line">        </span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2分页"><a href="#2-2分页" class="headerlink" title="2.2分页"></a>2.2分页</h3><p>es默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。</p>
<p>rom、size参数来控制要返回的分页结果</p>
<pre><code>    from:从第几个文档开始

    size: 总共查询几个文档
</code></pre>
<p>类似于Mysql 中 limit  ？, ？</p>
<h4 id="2-2基本的分页"><a href="#2-2基本的分页" class="headerlink" title="2.2基本的分页"></a>2.2基本的分页</h4><p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span>   </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span>   </span><br><span class="line">    <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span><span class="comment">//页码</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span><span class="comment">//每页获取的文档总数</span></span><br><span class="line">     <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>这里是查询990开始的数据，也就是 第990~第1000条 数据。</p>
<p>不过，elasticsearch内部分页时，必须先查询 0~1000条，然后截取其中的990 ~ 1000的这10条：</p>
<p><img src="D:\BaiduNetdiskDownload\day06-Elasticsearch02\讲义\assets\image-20210721200643029.png" alt="image-20210721200643029" loading="lazy"></p>
<p>查询TOP1000，如果es是单点模式，这并无太大影响。</p>
<p>但是elasticsearch将来一定是集群，例如我集群有5个节点，我要查询TOP1000的数据，并不是每个节点查询200条就可以了。</p>
<p>因为节点A的TOP200，在另一个节点可能排到10000名以外了。</p>
<p>因此要想获取整个集群的TOP1000，必须先查询出每个节点的TOP1000，汇总结果后，重新排名，重新截取TOP1000。</p>
<p><img src="D:\BaiduNetdiskDownload\day06-Elasticsearch02\讲义\assets\image-20210721201003229.png" alt="image-20210721201003229" loading="lazy"></p>
<p>那如果我要查询9900~10000的数据呢？是不是要先查询TOP10000呢？那每个节点都要查询10000条？汇总到内存中？</p>
<p>当查询分页深度较大时，汇总数据过多，对内存和CPU会产生非常大的压力，因此elasticsearch会禁止from+ size 超过10000的请求。</p>
<p>针对深度分页，ES提供了两种解决方案，<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html">官方文档</a>：</p>
<ul>
<li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li>
<li>scroll：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。</li>
</ul>
<h4 id="2-2-3-小结"><a href="#2-2-3-小结" class="headerlink" title="2.2.3.小结"></a>2.2.3.小结</h4><ul>
<li><p><code>from + size</code>：</p>
<ul>
<li>优点：支持随机翻页</li>
<li>缺点：深度分页问题，默认查询上限（from + size）是10000</li>
<li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li>
</ul>
</li>
<li><p><code>after search</code>：</p>
<ul>
<li>优点：没有查询上限（单次查询的size不超过10000）</li>
<li>缺点：只能向后逐页查询，不支持随机翻页</li>
<li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li>
</ul>
</li>
<li><p><code>scroll</code>：</p>
<ul>
<li>优点：没有查询上限（单次查询的size不超过10000）</li>
<li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li>
<li>场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。</li>
</ul>
</li>
</ul>
<h2 id="2-3高亮"><a href="#2-3高亮" class="headerlink" title="2.3高亮"></a>2.3高亮</h2><p>什么是高亮显示呢？</p>
<p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：</p>
<p><img src="D:\BaiduNetdiskDownload\day06-Elasticsearch02\讲义\assets\image-20210721202705030.png" alt="image-20210721202705030" loading="lazy"></p>
<p>高亮显示的实现分为两步：</p>
<ul>
<li>1）给文档中的所有关键字都添加一个标签，例如<code>&lt;em&gt;</code>标签</li>
<li>2）页面给<code>&lt;em&gt;</code>标签编写CSS样式</li>
</ul>
<h3 id="2-3-1实现高亮"><a href="#2-3-1实现高亮" class="headerlink" title="2.3.1实现高亮"></a>2.3.1实现高亮</h3><p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;FIELD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TEXT&quot;</span> <span class="comment">// 查询条件，高亮一定要使用全文检索查询</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 指定要高亮的字段</span></span><br><span class="line">      <span class="attr">&quot;FIELD&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span>  <span class="comment">// 用来标记高亮字段的前置标签</span></span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span> <span class="comment">// 用来标记高亮字段的后置标签</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意：**</p>
<ul>
<li>高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li>
<li>默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li>
<li>如果要对非搜索字段高亮，则需要添加一个属性：required_field_match=false</li>
</ul>
<p>栗子</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;all&quot;</span><span class="punctuation">:</span><span class="string">&quot;外滩689&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;require_field_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">       </span><br><span class="line">       <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;require_field_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure>
<p><img src="/images/image-20220319113145598.png" alt="image-20220319113145598" loading="lazy"></p>
<p>注意: 如检索内容中没有相关词，就不会显示。</p>
<pre><code>    如: &quot;外滩689&quot; 如果其他文档 price不是689 那么此文档 price就不会高亮。
</code></pre>
<h2 id="3-RestClient查询文档"><a href="#3-RestClient查询文档" class="headerlink" title="3.RestClient查询文档"></a>3.RestClient查询文档</h2><p>文档的查询同样使用RestHighLevelClient对象。</p>
<p>基本步骤包括:</p>
<ol>
<li><pre><code>    准备Request对象
</code></pre>
</li>
<li><pre><code>    准备请求参数
</code></pre>
</li>
<li><pre><code>    发起请求
</code></pre>
</li>
<li><pre><code>  解析响应
</code></pre>
</li>
</ol>
<h2 id="4-数据聚合"><a href="#4-数据聚合" class="headerlink" title="4.数据聚合"></a>4.数据聚合</h2><p><strong>聚合</strong>(<strong>aggregations</strong>）可以让我们极其方便的实现对数据的</p>
<p>统计、分析、运算。例如:</p>
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul>
<p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p>
<h2 id="4-1聚合的种类"><a href="#4-1聚合的种类" class="headerlink" title="4.1聚合的种类"></a>4.1聚合的种类</h2><p>聚合常见的有三类:</p>
<p>桶(Bucket)聚合:用来对文档做分组</p>
<ul>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
<p>度量(Metric)聚合: 最大值、最小值、平均值</p>
<ul>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul>
<p><strong>管道（pipeline）</strong>聚合：其它聚合的结果为基础做聚合</p>
<p><strong>注意：</strong>参加聚合的字段必须是keyword、日期、数值、布尔类型</p>
<h2 id="4-2DSL实现聚合"><a href="#4-2DSL实现聚合" class="headerlink" title="4.2DSL实现聚合"></a>4.2DSL实现聚合</h2><p>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="comment">//设置size为0，结果中不包含文档，只包含聚合结果</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">// 定义聚合</span></span><br><span class="line">		<span class="attr">&quot;聚合名字&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">//给聚合起个名字 </span></span><br><span class="line">			<span class="attr">&quot;聚合类型&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">// 聚合的类型，按照品牌值聚合，所以选择term</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">20</span> <span class="comment">// 希望获取的聚合结果数量</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220320143929353.png" alt="image-20220320143929353" loading="lazy"></p>
<h2 id="4-2-2聚合结果排序"><a href="#4-2-2聚合结果排序" class="headerlink" title="4.2.2聚合结果排序"></a>4.2.2聚合结果排序</h2><p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。</p>
<p>我们可以指定order属性，自定义聚合的排序方式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;_count&quot;</span><span class="punctuation">:</span><span class="string">&quot;asc&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">20</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220320144227937.png" alt="image-20220320144227937" loading="lazy"></p>
<h2 id="4-2-3-限定聚合范围"><a href="#4-2-3-限定聚合范围" class="headerlink" title="4.2.3.限定聚合范围"></a>4.2.3.限定聚合范围</h2><p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p>
<p>我们可以限定要聚合的文档范围，只要添加query条件即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span><span class="number">200</span> <span class="comment">//只对200元以下的文档聚合</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">		</span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;聚合名称&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">20</span></span><br><span class="line">			</span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		</span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220320144556344.png" alt="image-20220320144556344" loading="lazy"></p>
<p>数量明显减少。</p>
<h2 id="4-2-4Metric聚合"><a href="#4-2-4Metric聚合" class="headerlink" title="4.2.4Metric聚合"></a>4.2.4Metric聚合</h2><p>min、max、avg等值。</p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET /hotel/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;brandAgg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;brand&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">20</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">// 是brands聚合的子聚合，也就是分组后对每组分别计算</span></span><br><span class="line">                <span class="attr">&quot;score_stats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">//聚合名称</span></span><br><span class="line">                    <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> <span class="comment">//聚合类型,这里stats可以计算min、max、avg等</span></span><br><span class="line">                      	<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;score&quot;</span> <span class="comment">//聚合字段，这里是score</span></span><br><span class="line">                        </span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                    </span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">		</span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p>
<p>相当于 order by 后 再 avg  max  min 这些</p>
<p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p>
<p><img src="/images/image-20220320145300122.png" alt="image-20220320145300122" loading="lazy"></p>
<h2 id="4-2-5小结"><a href="#4-2-5小结" class="headerlink" title="4.2.5小结"></a>4.2.5小结</h2><p>aggs代表聚合，与query统计，此时query的作用是</p>
<pre><code>    限定聚合的文档范围
</code></pre>
<p>聚合必须的三要素:</p>
<ul>
<li><pre><code>    聚合名称
</code></pre>
</li>
<li><pre><code>    聚合类型
</code></pre>
</li>
<li><pre><code>    聚合字段
</code></pre>
</li>
</ul>
<p>聚合可配置属性有：</p>
<ul>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
<li>field：指定聚合字段</li>
</ul>
<h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">https://sentinelguard.io/zh-cn/index.html</a></p>
<p>Sentinel 具有以下特征:</p>
<p>•<strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p>
<p>•<strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p>
<p>•<strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p>
<p>•<strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p>
<h2 id="1-3-2-安装Sentinel"><a href="#1-3-2-安装Sentinel" class="headerlink" title="1.3.2.安装Sentinel"></a>1.3.2.安装Sentinel</h2><p>1）下载</p>
<p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">GitHub</a>下载。</p>
<p>课前资料也提供了下载好的jar包：</p>
<p><img src="/images/image-20210715174252531.png" alt="image-20210715174252531" loading="lazy"></p>
<p>2）运行</p>
<p>将jar包放到任意非中文目录，执行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>

<p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p>
<table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>server.port</td>
<td>8080</td>
<td>服务端口</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username</td>
<td>sentinel</td>
<td>默认用户名</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password</td>
<td>sentinel</td>
<td>默认密码</td>
</tr>
</tbody></table>
<p>例如，修改端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>





<p>3）访问</p>
<p>访问<a href="http://localhost:8080页面，就可以看到sentinel的控制台了：">http://localhost:8080页面，就可以看到sentinel的控制台了：</a></p>
<p><img src="/images/image-20210715190827846.png" alt="image-20210715190827846" loading="lazy"></p>
<p>需要输入账号和密码，默认都是：sentinel</p>
<p>登录后，发现一片空白，什么都没有：</p>
<p><img src="/images/image-20210715191134448.png" alt="image-20210715191134448" loading="lazy"></p>
<p>这是因为我们还没有与微服务整合。</p>
<h2 id="1-4-微服务整合Sentinel"><a href="#1-4-微服务整合Sentinel" class="headerlink" title="1.4.微服务整合Sentinel"></a>1.4.微服务整合Sentinel</h2><p>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</p>
<p>1）引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>2）配置控制台</p>
<p>修改application.yaml文件，添加下面内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br></pre></td></tr></table></figure>



<p>3）访问order-service的任意端点</p>
<p>打开浏览器，访问<a target="_blank" rel="noopener" href="http://localhost:8088/order/101%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%89%8D%E8%83%BD%E8%A7%A6%E5%8F%91sentinel%E7%9A%84%E7%9B%91%E6%8E%A7%E3%80%82">http://localhost:8088/order/101，这样才能触发sentinel的监控。</a></p>
<p>然后再访问sentinel的控制台，查看效果：</p>
<p><img src="/images/image-20210715191241799.png" alt="image-20210715191241799" loading="lazy"></p>
<h2 id="2-流量控制"><a href="#2-流量控制" class="headerlink" title="2.流量控制"></a>2.流量控制</h2><p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p>
<h3 id="2-1-簇点链路"><a href="#2-1-簇点链路" class="headerlink" title="2.1.簇点链路"></a>2.1.簇点链路</h3><p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做<strong>簇点链路</strong>。簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</p>
<p>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</p>
<p>例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}</p>
<p><img src="/images/image-20210715191757319.png" alt="image-20210715191757319" loading="lazy"></p>
<p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p>
<ul>
<li>流控：流量控制</li>
<li>降级：降级熔断</li>
<li>热点：热点参数限流，是限流的一种</li>
<li>授权：请求的权限控制</li>
</ul>
<h3 id="2-1流控模式"><a href="#2-1流控模式" class="headerlink" title="2.1流控模式"></a>2.1流控模式</h3><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p>
<ul>
<li><strong>直接</strong>：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li>
<li><strong>关联</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li>
<li>链<strong>路</strong>：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li>
</ul>
<p><strong>直接模式: 直接对某个请求设置限流</strong></p>
<p><img src="/images/image-20220401201349351.png" alt="image-20220401201349351" loading="lazy"></p>
<h3 id="2-2关联模式"><a href="#2-2关联模式" class="headerlink" title="2.2关联模式"></a>2.2关联模式</h3><p>统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p>
<p><img src="/images/image-20220401201515608.png" alt="image-20220401201515608" loading="lazy"></p>
<h3 id="2-3链路模式"><a href="#2-3链路模式" class="headerlink" title="2.3链路模式"></a>2.3链路模式</h3><p>只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p>
<p><strong>配置示例</strong>：</p>
<p>例如有两条请求链路：</p>
<ul>
<li><p>/test1 –&gt; /A/common</p>
</li>
<li><p>/test1 –&gt; /B/common</p>
</li>
</ul>
<p><img src="/images/image-20220401202238751.png" alt="image-20220401202238751" loading="lazy"></p>
<p><strong>链路模式</strong>中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p>
<p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span> <span class="comment"># 关闭context整合</span></span><br></pre></td></tr></table></figure>



<p><img src="/images/image-20220401202622297.png" alt="image-20220401202622297" loading="lazy"></p>
<h4 id="添加流控规则"><a href="#添加流控规则" class="headerlink" title="添加流控规则"></a>添加流控规则</h4><p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p>
<p><img src="/images/image-20210716105408723.png" alt="image-20210716105408723" loading="lazy"></p>
<p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法，只会监控<strong>controller</strong>中的方法。</p>
<p>给OrderService的queryGoods方法添加**@SentinelResource注解：**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(&quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryGoods</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;查询商品&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="添加流控规则-1"><a href="#添加流控规则-1" class="headerlink" title="添加流控规则"></a>添加流控规则</h4><p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</p>
<p><img src="/images/image-20210716105408723.png" alt="image-20210716105408723" loading="lazy"></p>
<p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</p>
<h4 id="6）Jmeter测试"><a href="#6）Jmeter测试" class="headerlink" title="6）Jmeter测试"></a>6）Jmeter测试</h4><p>选择《流控模式-链路》：</p>
<p><img src="/images/image-20210716105612312.png" alt="image-20210716105612312" loading="lazy"></p>
<p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p>
<p>一个http请求是访问/order/save：</p>
<p><img src="/images/image-20210716105812789.png" alt="image-20210716105812789" loading="lazy"></p>
<p>运行的结果：</p>
<p><img src="/images/image-20210716110027064.png" alt="image-20210716110027064" loading="lazy"></p>
<p>完全不受影响。</p>
<p>另一个是访问/order/query：</p>
<p><img src="/images/image-20210716105855951.png" alt="image-20210716105855951" loading="lazy"></p>
<p>运行结果：</p>
<p><img src="/images/image-20210716105956401.png" alt="image-20210716105956401" loading="lazy"></p>
<p>每次只有2个通过。</p>
<h3 id="2-2-3-总结"><a href="#2-2-3-总结" class="headerlink" title="2.2.3.总结"></a>2.2.3.总结</h3><p>流控模式有哪些？</p>
<p>•直接：对当前资源限流</p>
<p>•关联：高优先级资源触发阈值，对低优先级资源限流。</p>
<p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p>
<h2 id="2-3-流控效果"><a href="#2-3-流控效果" class="headerlink" title="2.3.流控效果"></a>2.3.流控效果</h2><p>在流控的高级选项中，还有一个流控效果选项：</p>
<p><img src="/images/image-20210716110225104.png" alt="image-20210716110225104" loading="lazy"></p>
<p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p>
<ul>
<li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</p>
</li>
<li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p>
</li>
<li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p>
</li>
</ul>
<h3 id="2-3-1-warm-up"><a href="#2-3-1-warm-up" class="headerlink" title="2.3.1.warm up"></a>2.3.1.warm up</h3><p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p>
<p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p>
<p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</p>
<p><img src="/images/image-20210716110629796.png" alt="image-20210716110629796" loading="lazy"></p>
<p><strong>案例</strong></p>
<p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</p>
<h4 id="1）配置流控规则："><a href="#1）配置流控规则：" class="headerlink" title="1）配置流控规则："></a>1）配置流控规则：</h4><p><img src="/images/image-20210716111012387.png" alt="image-20210716111012387" loading="lazy"></p>
<h4 id="2）Jmeter测试"><a href="#2）Jmeter测试" class="headerlink" title="2）Jmeter测试"></a>2）Jmeter测试</h4><p>选择《流控效果，warm up》：</p>
<p><img src="/images/image-20210716111136699.png" alt="image-20210716111136699" loading="lazy"></p>
<p>QPS为10.</p>
<p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</p>
<p><img src="/images/image-20210716111303701.png" alt="image-20210716111303701" loading="lazy"></p>
<p>随着时间推移，成功比例越来越高：</p>
<p><img src="/images/image-20210716111404717.png" alt="image-20210716111404717" loading="lazy"></p>
<p>到Sentinel控制台查看实时监控：</p>
<p><img src="/images/image-20210716111526480.png" alt="image-20210716111526480" loading="lazy"></p>
<p>一段时间后：</p>
<p><img src="/images/image-20210716111658541.png" alt="image-20210716111658541" loading="lazy"></p>
<h3 id="2-3-2-排队等待"><a href="#2-3-2-排队等待" class="headerlink" title="2.3.2.排队等待"></a>2.3.2.排队等待</h3><p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p>
<p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p>
<p>工作原理</p>
<p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p>
<p>那什么叫做预期等待时长呢？</p>
<p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p>
<ul>
<li>第6个请求的<strong>预期等待时长</strong> =  200 * （6 - 1） = 1000ms</li>
<li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li>
</ul>
<p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p>
<p><img src="/images/image-20210716113147176.png" alt="image-20210716113147176" loading="lazy"></p>
<p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p>
<p><img src="/images/image-20210716113426524.png" alt="image-20210716113426524" loading="lazy"></p>
<p>平滑的QPS曲线，对于服务器来说是更友好的。</p>
<p><strong>案例</strong></p>
<p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</p>
<h4 id="2）Jmeter测试-1"><a href="#2）Jmeter测试-1" class="headerlink" title="2）Jmeter测试"></a>2）Jmeter测试</h4><p>选择《流控效果，队列》：</p>
<p><img src="/images/image-20210716114243558.png" alt="image-20210716114243558" loading="lazy"></p>
<p>QPS为15，已经超过了我们设定的10。</p>
<p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</p>
<p>但是我们看看队列模式的运行结果：</p>
<p><img src="/images/image-20210716114429361.png" alt="image-20210716114429361" loading="lazy"></p>
<p>全部都通过了。</p>
<p>再去sentinel查看实时监控的QPS曲线：</p>
<p><img src="/images/image-20210716114522935.png" alt="image-20210716114522935" loading="lazy"></p>
<p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p>
<p>当队列满了以后，才会有部分请求失败：</p>
<p><img src="/images/image-20210716114651137.png" alt="image-20210716114651137" loading="lazy"></p>
<h2 id="2-4热点参数限流"><a href="#2-4热点参数限流" class="headerlink" title="2.4热点参数限流"></a>2.4热点参数限流</h2><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p>
<h3 id="2-4-1-全局参数限流"><a href="#2-4-1-全局参数限流" class="headerlink" title="2.4.1.全局参数限流"></a>2.4.1.全局参数限流</h3><p>例如，一个根据id查询商品的接口：</p>
<p><img src="/images/image-20210716115014663.png" alt="image-20210716115014663" loading="lazy"></p>
<p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p>
<p><img src="/images/image-20210716115131463.png" alt="image-20210716115131463" loading="lazy"></p>
<p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p>
<p>配置示例：</p>
<p><img src="/images/image-20210716115232426.png" alt="image-20210716115232426" loading="lazy"></p>
<p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p>
<h3 id="2-4-2-热点参数限流"><a href="#2-4-2-热点参数限流" class="headerlink" title="2.4.2.热点参数限流"></a>2.4.2.热点参数限流</h3><p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p>
<p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p>
<p><img src="/images/image-20210716115717523.png" alt="image-20210716115717523" loading="lazy"></p>
<p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p>
<p>•如果参数值是100，则每1秒允许的QPS为10</p>
<p>•如果参数值是101，则每1秒允许的QPS为15</p>
<h3 id="2-4-4-案例"><a href="#2-4-4-案例" class="headerlink" title="2.4.4.案例"></a>2.4.4.案例</h3><p><strong>案例需求</strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</p>
<p>•默认的热点参数规则是每1秒请求量不超过2</p>
<p>•给102这个参数设置例外：每1秒请求量不超过4</p>
<p>•给103这个参数设置例外：每1秒请求量不超过10</p>
<p><strong>注意事项</strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</p>
<h3 id="sentinelResource-标记资源"><a href="#sentinelResource-标记资源" class="headerlink" title="@sentinelResource()标记资源"></a>@sentinelResource()标记资源</h3><h4 id="1）标记资源"><a href="#1）标记资源" class="headerlink" title="1）标记资源"></a>1）标记资源</h4><p>给order-service中的OrderController中的/order/{orderId}资源添加注解：</p>
<p><img src="/images/image-20210716120033572.png" alt="image-20210716120033572" loading="lazy"></p>
<h4 id="2）热点参数限流规则"><a href="#2）热点参数限流规则" class="headerlink" title="2）热点参数限流规则"></a>2）热点参数限流规则</h4><p>访问该接口，可以看到我们标记的hot资源出现了：</p>
<p><img src="/images/image-20210716120208509.png" alt="image-20210716120208509" loading="lazy"></p>
<p>这里不要点击hot后面的按钮，页面有BUG</p>
<p>点击左侧菜单中<strong>热点规则</strong>菜单：</p>
<p><img src="/images/image-20210716120319009.png" alt="image-20210716120319009" loading="lazy"></p>
<p>点击新增，填写表单：</p>
<p><img src="/images/image-20210716120536714.png" alt="image-20210716120536714" loading="lazy"></p>
<h4 id="3）Jmeter测试"><a href="#3）Jmeter测试" class="headerlink" title="3）Jmeter测试"></a>3）Jmeter测试</h4><p>选择《热点参数限流 QPS1》：</p>
<p><img src="/images/image-20210716120754527.png" alt="image-20210716120754527" loading="lazy"></p>
<p>这里发起请求的QPS为5.</p>
<p>包含3个http请求：</p>
<p>普通参数，QPS阈值为2</p>
<p><img src="/images/image-20210716120840501.png" alt="image-20210716120840501" loading="lazy"></p>
<p>运行结果：</p>
<p><img src="/images/image-20210716121105567.png" alt="image-20210716121105567" loading="lazy"></p>
<p>例外项，QPS阈值为4</p>
<p><img src="/images/image-20210716120900365.png" alt="image-20210716120900365" loading="lazy"></p>
<p>运行结果：</p>
<p><img src="/images/image-20210716121201630.png" alt="image-20210716121201630" loading="lazy"></p>
<p>例外项，QPS阈值为10</p>
<p><img src="/images/image-20210716120919131.png" alt="image-20210716120919131" loading="lazy"></p>
<p>运行结果：</p>
<p><img src="/images/image-20210716121220305.png" alt="image-20210716121220305" loading="lazy"></p>
<p>3.隔离和降级</p>
<p>限流是一种预防措施,虽然限流可以尽量避免因为高并发而引起的服务故障，但服务还会因为其他原因而故障。</p>
<p>而要将这些故障控制在一定范围，避免雪崩，就要靠**线程隔离(舱壁模式)**和熔断降级手段了。</p>
<p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p>
<p><img src="/images/image-20210715173215243.png" alt="image-20210715173215243" loading="lazy"></p>
<p><strong>熔断降级</strong>:是在调用方法这边加入熔断器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p>
<p><img src="/images/image-20220402170054743.png" alt="image-20220402170054743" loading="lazy"></p>
<p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p>
<p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断</p>
<h2 id="3-1-FeignClient整合Sentinel"><a href="#3-1-FeignClient整合Sentinel" class="headerlink" title="3.1.FeignClient整合Sentinel"></a>3.1.FeignClient整合Sentinel</h2><p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p>
<h3 id="3-1-1-修改配置，开启sentinel功能"><a href="#3-1-1-修改配置，开启sentinel功能" class="headerlink" title="3.1.1.修改配置，开启sentinel功能"></a>3.1.1.修改配置，开启sentinel功能</h3><p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign对sentinel的支持‘’</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-编写失败降级逻辑"><a href="#3-1-2-编写失败降级逻辑" class="headerlink" title="3.1.2.编写失败降级逻辑"></a>3.1.2.编写失败降级逻辑</h3><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p>
<p>给FeignClient编写失败后的降级逻辑</p>
<p>①方式一：FallbackClass，无法对远程调用的异常做处理</p>
<p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p>
<p>这里我们演示方式二的失败降级处理。</p>
<p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p>
<p><img src="/images/image-20210716122403502.png" alt="image-20210716122403502" loading="lazy"></p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.feign.clients.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.clients.UserClient;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.pojo.User;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;UserClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> User <span class="title function_">findById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;查询用户异常&quot;</span>, throwable);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserClientFallbackFactory <span class="title function_">userClientFallbackFactory</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserClientFallbackFactory</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.itcast.feign.clients.fallback.UserClientFallbackFactory;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;, fallbackFactory = UserClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p>
<p><img src="/images/image-20210716123705780.png" alt="image-20210716123705780" loading="lazy"></p>
<h3 id="3-1-3-总结"><a href="#3-1-3-总结" class="headerlink" title="3.1.3.总结"></a>3.1.3.总结</h3><p>Sentinel支持的雪崩解决方案：</p>
<ul>
<li>线程隔离（仓壁模式）</li>
<li>降级熔断</li>
</ul>
<p>Feign整合Sentinel的步骤：</p>
<ul>
<li>在application.yml中配置：feign.sentienl.enable=true</li>
<li>给FeignClient编写FallbackFactory并注册为Bean</li>
<li>将FallbackFactory配置到FeignClient</li>
</ul>
<h2 id="3-2-线程隔离（舱壁模式）"><a href="#3-2-线程隔离（舱壁模式）" class="headerlink" title="3.2.线程隔离（舱壁模式）"></a>3.2.线程隔离（舱壁模式）</h2><h3 id="3-2-1-线程隔离的实现方式"><a href="#3-2-1-线程隔离的实现方式" class="headerlink" title="3.2.1.线程隔离的实现方式"></a>3.2.1.线程隔离的实现方式</h3><p>线程隔离有两种方式实现：</p>
<ul>
<li><p>线程池隔离</p>
</li>
<li><p>信号量隔离（Sentinel默认采用）</p>
</li>
</ul>
<p>如图：</p>
<p><img src="/images/image-20210716123036937.png" alt="image-20210716123036937" loading="lazy"></p>
<p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p>
<p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p>
<p>两者的优缺点：</p>
<p><img src="/images/image-20210716123240518.png" alt="image-20210716123240518" loading="lazy"></p>
<h3 id="3-2-2-sentinel的线程隔离"><a href="#3-2-2-sentinel的线程隔离" class="headerlink" title="3.2.2.sentinel的线程隔离"></a>3.2.2.sentinel的线程隔离</h3><p><strong>用法说明</strong>：</p>
<p>在添加限流规则时，可以选择两种阈值类型：</p>
<p><img src="/images/image-20210716123411217.png" alt="image-20210716123411217" loading="lazy"></p>
<ul>
<li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p>
</li>
<li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p>
</li>
</ul>
<p><strong>案例需求</strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</p>
<h4 id="1）配置隔离规则"><a href="#1）配置隔离规则" class="headerlink" title="1）配置隔离规则"></a>1）配置隔离规则</h4><p>选择feign接口后面的流控按钮：</p>
<p><img src="/images/image-20210716123831992.png" alt="image-20210716123831992" loading="lazy"></p>
<p>填写表单：</p>
<p><img src="/images/image-20210716123936844.png" alt="image-20210716123936844" loading="lazy"></p>
<h4 id="2）Jmeter测试-2"><a href="#2）Jmeter测试-2" class="headerlink" title="2）Jmeter测试"></a>2）Jmeter测试</h4><p>选择《阈值类型-线程数&lt;2》：</p>
<p><img src="/images/image-20210716124229894.png" alt="image-20210716124229894" loading="lazy"></p>
<p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p>
<p>查看运行结果：</p>
<p><img src="/images/image-20210716124147820.png" alt="image-20210716124147820" loading="lazy"></p>
<p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</p>
<h3 id="3-2-3总结"><a href="#3-2-3总结" class="headerlink" title="3.2.3总结"></a>3.2.3总结</h3><p>线程隔离的两种手段是？</p>
<ul>
<li><p>信号量隔离</p>
</li>
<li><p>线程池隔离</p>
</li>
</ul>
<p>信号量隔离的特点是？</p>
<ul>
<li>基于计数器模式，简单，开销小</li>
</ul>
<p>线程池隔离的特点是？</p>
<ul>
<li>基于线程池模式，有额外开销，但隔离控制更强</li>
</ul>
<h2 id="3-3熔断降级"><a href="#3-3熔断降级" class="headerlink" title="3.3熔断降级"></a>3.3熔断降级</h2><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p>
<p>断路器控制熔断和放行是通过状态机来完成的：</p>
<p><img src="/images/image-20210716130958518.png" alt="image-20210716130958518" loading="lazy"></p>
<p>状态机包括三个状态：</p>
<ul>
<li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li>
<li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li>
<li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。<ul>
<li>请求成功：则切换到closed状态</li>
<li>请求失败：则切换到open状态</li>
</ul>
</li>
</ul>
<p>断路器熔断策略有三种：慢调用、异常比例、异常数</p>
<h3 id="3-3-1-慢调用"><a href="#3-3-1-慢调用" class="headerlink" title="3.3.1.慢调用"></a>3.3.1.慢调用</h3><p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p>
<p>例如：</p>
<p><img src="/images/image-20210716145934347.png" alt="image-20210716145934347" loading="lazy"></p>
<p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</p>
<h4 id="1）设置慢调用"><a href="#1）设置慢调用" class="headerlink" title="1）设置慢调用"></a>1）设置慢调用</h4><p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</p>
<p><img src="/images/image-20210716150234787.png" alt="image-20210716150234787" loading="lazy"></p>
<p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</p>
<p><img src="/images/image-20210716150510956.png" alt="image-20210716150510956" loading="lazy"></p>
<p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</p>
<p><img src="/images/image-20210716150605208.png" alt="image-20210716150605208" loading="lazy"></p>
<h4 id="2）设置熔断规则"><a href="#2）设置熔断规则" class="headerlink" title="2）设置熔断规则"></a>2）设置熔断规则</h4><p>下面，给feign接口设置降级规则：</p>
<p><img src="/images/image-20210716150654094.png" alt="image-20210716150654094" loading="lazy"></p>
<p>规则：</p>
<p><img src="/images/image-20210716150740434.png" alt="image-20210716150740434" loading="lazy"></p>
<p>超过50ms的请求都会被认为是慢请求</p>
<h4 id="3）测试"><a href="#3）测试" class="headerlink" title="3）测试"></a>3）测试</h4><p>在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/101%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B05%E6%AC%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%EF%BC%9A">http://localhost:8088/order/101，快速刷新5次，可以发现：</a></p>
<p><img src="/images/image-20210716150911004.png" alt="image-20210716150911004" loading="lazy"></p>
<p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</p>
<p>在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/102%EF%BC%8C%E7%AB%9F%E7%84%B6%E4%B9%9F%E8%A2%AB%E7%86%94%E6%96%AD%E4%BA%86%EF%BC%9A">http://localhost:8088/order/102，竟然也被熔断了：</a></p>
<p><img src="/images/image-20210716151107785.png" alt="image-20210716151107785" loading="lazy"></p>
<h3 id="3-3-2-异常比例、异常数"><a href="#3-3-2-异常比例、异常数" class="headerlink" title="3.3.2.异常比例、异常数"></a>3.3.2.异常比例、异常数</h3><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p>
<p>例如，一个异常比例设置：</p>
<p><img src="/images/image-20210716131430682.png" alt="image-20210716131430682" loading="lazy"></p>
<p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p>
<p>一个异常数设置：</p>
<p><img src="/images/image-20210716131522912.png" alt="image-20210716131522912" loading="lazy"></p>
<p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</p>
<h4 id="1）设置异常请求"><a href="#1）设置异常请求" class="headerlink" title="1）设置异常请求"></a>1）设置异常请求</h4><p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p>
<p><img src="/images/image-20210716151348183.png" alt="image-20210716151348183" loading="lazy"></p>
<p>也就是说，id 为 2时，就会触发异常</p>
<h4 id="2）设置熔断规则-1"><a href="#2）设置熔断规则-1" class="headerlink" title="2）设置熔断规则"></a>2）设置熔断规则</h4><p>下面，给feign接口设置降级规则：</p>
<p><img src="/images/image-20210716150654094.png" alt="image-20210716150654094" loading="lazy"></p>
<p>规则：</p>
<p><img src="/images/image-20210716151538785.png" alt="image-20210716151538785" loading="lazy"></p>
<p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</p>
<h4 id="3）测试-1"><a href="#3）测试-1" class="headerlink" title="3）测试"></a>3）测试</h4><p>在浏览器快速访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/102%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B05%E6%AC%A1%EF%BC%8C%E8%A7%A6%E5%8F%91%E7%86%94%E6%96%AD%EF%BC%9A">http://localhost:8088/order/102，快速刷新5次，触发熔断：</a></p>
<p><img src="/images/image-20210716151722916.png" alt="image-20210716151722916" loading="lazy"></p>
<p>此时，我们去访问本来应该正常的103：</p>
<p><img src="/images/image-20210716151844817.png" alt="image-20210716151844817" loading="lazy"></p>
<h2 id="4-授权规则"><a href="#4-授权规则" class="headerlink" title="4.授权规则"></a>4.授权规则</h2><p>授权规则可以对请求方来源做判断和控制。</p>
<h2 id="4-1-授权规则"><a href="#4-1-授权规则" class="headerlink" title="4.1.授权规则"></a>4.1.授权规则</h2><h3 id="4-1-1-基本规则"><a href="#4-1-1-基本规则" class="headerlink" title="4.1.1.基本规则"></a>4.1.1.基本规则</h3><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p>
<ul>
<li><p>白名单：来源（origin）在白名单内的调用者允许访问</p>
</li>
<li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p>
</li>
</ul>
<p>点击左侧菜单的授权，可以看到授权规则：</p>
<p><img src="/images/image-20210716152010750.png" alt="image-20210716152010750" loading="lazy"></p>
<ul>
<li><p>资源名：就是受保护的资源，例如/order/{orderId}</p>
</li>
<li><p>流控应用：是来源者的名单，</p>
<ul>
<li>如果是勾选白名单，则名单中的来源被许可访问。</li>
<li>如果是勾选黑名单，则名单中的来源被禁止访问。</li>
</ul>
</li>
</ul>
<p>比如：</p>
<p><img src="/images/image-20210716152349191.png" alt="image-20210716152349191" loading="lazy"></p>
<p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p>
<h3 id="4-1-2-如何获取origin"><a href="#4-1-2-如何获取origin" class="headerlink" title="4.1.2.如何获取origin"></a>4.1.2.如何获取origin</h3><p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestOriginParser</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从请求request对象中获取origin，获取方式自定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p>
<p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p>
<p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p>
<p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeaderOriginParser</span> <span class="keyword">implements</span> <span class="title class_">RequestOriginParser</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取请求头</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.非空判断</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(origin)) &#123;</span><br><span class="line">            origin = <span class="string">&quot;blank&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们会尝试从request-header中获取origin值。</p>
<h3 id="4-1-3-给网关添加请求头"><a href="#4-1-3-给网关添加请求头" class="headerlink" title="4.1.3.给网关添加请求头"></a>4.1.3.给网关添加请求头</h3><p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p>
<p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p>
<p>修改gateway服务中的application.yml，添加一个defaultFilter：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=origin,gateway</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="comment"># ...略</span></span><br></pre></td></tr></table></figure>

<p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p>
<h3 id="4-1-4-配置授权规则"><a href="#4-1-4-配置授权规则" class="headerlink" title="4.1.4.配置授权规则"></a>4.1.4.配置授权规则</h3><p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p>
<p><img src="/images/image-20210716153250134.png" alt="image-20210716153250134" loading="lazy"></p>
<p>配置如下：</p>
<p><img src="/images/image-20210716153301069.png" alt="image-20210716153301069" loading="lazy"></p>
<p>现在，我们直接跳过网关，访问order-service服务：</p>
<p><img src="/images/image-20210716153348396.png" alt="image-20210716153348396" loading="lazy"></p>
<p>通过网关访问：</p>
<p><img src="/images/image-20210716153434095.png" alt="image-20210716153434095" loading="lazy"></p>
<h2 id="4-2-自定义异常结果"><a href="#4-2-自定义异常结果" class="headerlink" title="4.2.自定义异常结果"></a>4.2.自定义异常结果</h2><p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p>
<h3 id="4-2-1-异常类型"><a href="#4-2-1-异常类型" class="headerlink" title="4.2.1.异常类型"></a>4.2.1.异常类型</h3><p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法有三个参数：</p>
<ul>
<li>HttpServletRequest request：request对象</li>
<li>HttpServletResponse response：response对象</li>
<li>BlockException e：被sentinel拦截时抛出的异常</li>
</ul>
<p>这里的BlockException包含多个不同的子类：</p>
<table>
<thead>
<tr>
<th><strong>异常</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>FlowException</td>
<td>限流异常</td>
</tr>
<tr>
<td>ParamFlowException</td>
<td>热点参数限流的异常</td>
</tr>
<tr>
<td>DegradeException</td>
<td>降级异常</td>
</tr>
<tr>
<td>AuthorityException</td>
<td>授权规则异常</td>
</tr>
<tr>
<td>SystemBlockException</td>
<td>系统规则异常</td>
</tr>
</tbody></table>
<h3 id="4-2-2-自定义异常处理"><a href="#4-2-2-自定义异常处理" class="headerlink" title="4.2.2.自定义异常处理"></a>4.2.2.自定义异常处理</h3><p>下面，我们就在order-service定义一个自定义异常处理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">impl</span> <span class="keyword">implements</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;未知异常&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">429</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FlowException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被限流了&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParamFlowException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被热点参数限流&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DegradeException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被降级了&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AuthorityException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;没有权限访问&quot;</span>;</span><br><span class="line">            status = <span class="number">401</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.setStatus(status);</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;&#123;\&quot;msg\&quot;: &quot;</span> + msg + <span class="string">&quot;, \&quot;status\&quot;: &quot;</span> + status + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重启测试，在不同场景下，会返回不同的异常消息.</p>
<p>限流：</p>
<p><img src="/images/image-20210716153938887.png" alt="image-20210716153938887" loading="lazy"></p>
<p>授权拦截时：</p>
<p><img src="/images/image-20210716154012736.png" alt="image-20210716154012736" loading="lazy"></p>
<h2 id="5-规则持久化"><a href="#5-规则持久化" class="headerlink" title="5.规则持久化"></a>5.规则持久化</h2><p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p>
<h2 id="5-1-规则管理模式"><a href="#5-1-规则管理模式" class="headerlink" title="5.1.规则管理模式"></a>5.1.规则管理模式</h2><p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p>
<ul>
<li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li>
<li>pull模式</li>
<li>push模式</li>
</ul>
<h3 id="5-1-1-pull模式"><a href="#5-1-1-pull模式" class="headerlink" title="5.1.1.pull模式"></a>5.1.1.pull模式</h3><p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p>
<p><img src="/images/image-20210716154155238.png" alt="image-20210716154155238" loading="lazy"></p>
<h3 id="5-1-2-push模式"><a href="#5-1-2-push模式" class="headerlink" title="5.1.2.push模式"></a>5.1.2.push模式</h3><p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p>
<p><img src="/images/image-20210716154215456.png" alt="image-20210716154215456" loading="lazy"></p>
<h2 id="5-2-实现push模式"><a href="#5-2-实现push模式" class="headerlink" title="5.2.实现push模式"></a>5.2.实现push模式</h2><p>详细步骤可以参考课前资料的《sentinel规则持久化》：</p>
<p><img src="/images/image-20210716154255466.png" alt="image-20210716154255466" loading="lazy"></p>
<h2 id="6、JSR303数字校验"><a href="#6、JSR303数字校验" class="headerlink" title="6、JSR303数字校验"></a>6、JSR303数字校验</h2><h2 id="6-1-基本校验实现"><a href="#6-1-基本校验实现" class="headerlink" title="6.1.基本校验实现"></a>6.<strong>1.基本校验实现</strong></h2><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-validation --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>给bean 属性上 添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;pms_brand&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrandEntity</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 品牌id</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@TableId</span></span><br><span class="line">	<span class="keyword">private</span> Long brandId;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 品牌名</span></span><br><span class="line"><span class="comment">	 </span></span><br><span class="line"><span class="comment">	   不能为空白</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@NotBlank(message=&quot;品牌名必须提交&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 品牌logo地址</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@NotEmpty</span></span><br><span class="line">	<span class="meta">@URL(message=&quot;logo必须是一个合法的url地址&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String logo;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 介绍</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String descript;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 显示状态[0-不显示；1-显示]</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer showStatus;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 检索首字母</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@NotEmpty</span></span><br><span class="line">	<span class="meta">@Pattern(regexp = &quot;/^[a-zA-Z]$/&quot;, message = &quot;检索首字母必须是一个字母&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String firstLetter;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 排序</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">	<span class="meta">@Min(value = 0, message = &quot;排序必须大于等于0&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Integer sort;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在需要校验的方法的参数前面封装的bean  添加 <strong>@Valid</strong>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="comment">//@RequiresPermissions(&quot;product:brand:save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BrandEntity brand<span class="comment">/*,BindingResult result*/</span>)</span>&#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      *  @Valid 对 brand进行校验</span></span><br><span class="line"><span class="comment">      *  result 校验返回的结果</span></span><br><span class="line"><span class="comment">      * */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        if (result.hasErrors())&#123;</span></span><br><span class="line"><span class="comment">//            Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//            //1.获取校验提示</span></span><br><span class="line"><span class="comment">//            result.getFieldErrors().forEach(</span></span><br><span class="line"><span class="comment">//                    item-&gt;&#123;</span></span><br><span class="line"><span class="comment">//                        String message =  item.getDefaultMessage();</span></span><br><span class="line"><span class="comment">//                        //2.获取到错误属性的名字</span></span><br><span class="line"><span class="comment">//                        String field = item.getField();</span></span><br><span class="line"><span class="comment">//                        map.put(field,message);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//            );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            return R.error(400,&quot;提交的数据不合法&quot;).put(&quot;data&quot;,map);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        brandService.save(brand);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>BindingResult result</strong>  校验后的结果，可以从里面取出有问题的message 和 字段等信息。</p>
<p>在controller中然后将出错信息返给前端</p>
<h2 id="6-2、统一异常处理"><a href="#6-2、统一异常处理" class="headerlink" title="6.2、统一异常处理"></a>6.<strong>2、统一异常处理</strong></h2><ul>
<li>针对于错误状态码，是我们进行随意定义的，然而正规开发过程中，错误状态码有着严格的定义规则，如该在项目中我们的错误状态码定义</li>
</ul>
<p><img src="D:/360MoveData/Users/LIWEI/Desktop/gulimall/谷粒商城资料整理课件/谷粒商城.assets/image-20210927161514194.png" alt="image-20210927161514194" loading="lazy"></p>
<p>为了定义这些错误状态码，我们可以单独定义一个常量类，用来存储这些错误状态码。</p>
<p>在common中新建<code>BizCodeEnume</code>用来存储状态码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 错误码和错误信息定义类</span></span><br><span class="line"><span class="comment"> * 1. 错误码定义规则为5为数字</span></span><br><span class="line"><span class="comment"> * 2. 前两位表示业务场景，最后三位表示错误码。例如：100001。10:通用 001:系统未知异常</span></span><br><span class="line"><span class="comment"> * 3. 维护错误码后需要维护错误描述，将他们定义为枚举形式</span></span><br><span class="line"><span class="comment"> * 错误码列表：</span></span><br><span class="line"><span class="comment"> *  10: 通用</span></span><br><span class="line"><span class="comment"> *      001：参数格式校验</span></span><br><span class="line"><span class="comment"> *  11: 商品</span></span><br><span class="line"><span class="comment"> *  12: 订单</span></span><br><span class="line"><span class="comment"> *  13: 购物车</span></span><br><span class="line"><span class="comment"> *  14: 物流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BizCodeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    UNKNOW_EXEPTION(<span class="number">10000</span>,<span class="string">&quot;系统未知异常&quot;</span>),</span><br><span class="line"></span><br><span class="line">    VALID_EXCEPTION( <span class="number">10001</span>,<span class="string">&quot;参数格式校验失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    BizCodeEnum(<span class="type">int</span> code, String msg) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建一个类 在类上添加  </p>
</li>
<li><p><strong>@ContollerAdvice(basePackages = “com.liwei.xiaozhi.product.controller”)</strong>  </p>
<pre><code>  basePackages  监控哪些包下类的异常
  
   也可以写成
</code></pre>
<p>  <strong>@RestControllerAdvice()  = @ControllerAdvice() + @ResponseBody()</strong></p>
</li>
</ul>
<p>在类上添加方法 ,且在方法上添加注解</p>
<p><strong>@ExceptionHandler(value = MethodArgumentNotValidException.class)</strong></p>
<p>value  异常的类型,如果是此类型就触发对应的方法</p>
<p>MethodArgumentNotValidException e 异常对象</p>
<p>R   对象 直接返回给前端的对象</p>
<p>@ResponseBody  返回 json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理数据校验异常</span></span><br><span class="line"><span class="comment">//@ResponseBody // 返回 json</span></span><br><span class="line"><span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">handleValidException</span><span class="params">(MethodArgumentNotValidException e)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      e.getFieldErrors().forEach(item-&gt;&#123;</span><br><span class="line">                  <span class="comment">//错误消息</span></span><br><span class="line">                 <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> item.getDefaultMessage();</span><br><span class="line">                 <span class="comment">//错误字段</span></span><br><span class="line">                 <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> item.getField();</span><br><span class="line">                 map.put(field,message);</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> R.error(</span><br><span class="line">              BizCodeEnum.VALID_EXCEPTION.getCode(),</span><br><span class="line">              BizCodeEnum.VALID_EXCEPTION.getMsg()</span><br><span class="line">      ).put(<span class="string">&quot;data&quot;</span>,map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//处理全局异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handleAllException</span><span class="params">(Exception e)</span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> R.error(</span><br><span class="line">                  BizCodeEnum.UNKNOW_EXEPTION.getCode(),</span><br><span class="line">                  BizCodeEnum.UNKNOW_EXEPTION.getMsg());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3分组校验功能"><a href="#6-3分组校验功能" class="headerlink" title="6.3分组校验功能"></a>6.3分组校验功能</h2><p><strong>新建两个空接口</strong><code>AddGroup</code>,<code>UpdateGroup</code>用来分组,名字随意  就是一个标志而已</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId</span></span><br><span class="line"><span class="keyword">private</span> Long brandId;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 品牌名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotBlank(message=&quot;品牌名必须提交&quot;,groups = &#123;UpdateGroup.class, AddGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 品牌logo地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotEmpty</span></span><br><span class="line"><span class="meta">@URL(message=&quot;logo必须是一个合法的url地址&quot;,groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String logo;</span><br></pre></td></tr></table></figure>

<p>在需要校验的字段上的注解里添加 groups= {} 里面写 空接口的class,表示为一组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="comment">//@RequiresPermissions(&quot;product:brand:save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="comment">/*@Valid*/</span> <span class="meta">@Validated(&#123;AddGroup.class&#125;)</span> <span class="meta">@RequestBody</span> BrandEntity brand<span class="comment">/*,BindingResult result*/</span>)</span>&#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      *  @Valid 对 brand进行校验</span></span><br><span class="line"><span class="comment">      *  result 校验返回的结果</span></span><br><span class="line"><span class="comment">      * */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        if (result.hasErrors())&#123;</span></span><br><span class="line"><span class="comment">//            Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//            //1.获取校验提示</span></span><br><span class="line"><span class="comment">//            result.getFieldErrors().forEach(</span></span><br><span class="line"><span class="comment">//                    item-&gt;&#123;</span></span><br><span class="line"><span class="comment">//                        String message =  item.getDefaultMessage();</span></span><br><span class="line"><span class="comment">//                        //2.获取到错误属性的名字</span></span><br><span class="line"><span class="comment">//                        String field = item.getField();</span></span><br><span class="line"><span class="comment">//                        map.put(field,message);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//            );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            return R.error(400,&quot;提交的数据不合法&quot;).put(&quot;data&quot;,map);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        brandService.save(brand);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在需要校验的 参数bean 前面添加 @Validated({AddGroup.class})注解</p>
<p>表示 这个方法 调用时需要，校验 实体类 加了 AddGroup.class 的字段</p>
<p>如: @NotBlank(message=”品牌名必须提交”,groups = {UpdateGroup.class, AddGroup.class})</p>
<p>@NotEmpty</p>
<p>@URL(message=”logo必须是一个合法的url地址”,groups = {AddGroup.class})<br>private String logo;</p>
<p>就需要校验者两个字段。</p>
<p>默认情况下，在分组校验情况下，没有指定指定分组的校验注解，将不会生效，它只会在不分组的情况下生效</p>
<h1 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h1><p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.mode</span>=<span class="string">HTML5</span></span><br><span class="line"><span class="comment"># 页面默认存放的位置（默认值： classpath:/templates/ ）</span></span><br><span class="line"><span class="attr">spring.thymeleaf.prefix</span>=<span class="string">classpath:/templates/</span></span><br><span class="line"><span class="comment"># 在构建 URL 时添加到视图名称后的后缀（默认值： .html ）</span></span><br><span class="line"><span class="attr">spring.thymeleaf.suffix</span>=<span class="string">.html</span></span><br><span class="line"><span class="comment"># 是否开启热部署</span></span><br><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>热部署开启后 修改页面后按  CTRL+SHIFT +F9 更新页面内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(HttpServletRequest  request)</span>&#123;</span><br><span class="line">    request.setAttribute(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;好帅啊&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>; <span class="comment">//视图名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220426144715233.png" alt="image-20220426144715233" loading="lazy"></p>
<p>在页面上添加 命名空间 <strong><html lang="en"  xmlns:th="http://www.thymeleaf.org"></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>获取 hello对应的值</p>
<p><img src="/images/image-20220426145110055.png" alt="image-20220426145110055" loading="lazy"></p>
<p>字符串拼接 <strong><h1 th:text="'李伟'+${hello}"></h1></strong></p>
<p>注意中间的加号</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>  <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;李伟&#x27;+$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>开启热部署<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    获取数组</span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span> <span class="attr">th:each</span>=<span class="string">&quot;s,stat:$&#123;arr&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;值: &#x27;+$&#123;s&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;索引从0开始: &#x27;+$&#123;stat.index&#125;&quot;</span>&gt;</span>索引<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;本数组大小: &#x27;+$&#123;stat.size&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;是否是第一个: &#x27;+$&#123;stat.first&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;是否是最后一个: &#x27;+$&#123;stat.last&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;m:$&#123;arr&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;m&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    判断</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;session.age&#125;==18&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;条件成立显示&quot;</span>&gt;</span>条件不成立<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:unless</span>=<span class="string">&quot;$&#123;session.age&#125;!=18&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;条件不成立时显示&quot;</span>&gt;</span>现在不显示,,条件成立<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    超链接传值</span></span><br><span class="line"><span class="comment">    name 属性值</span></span><br><span class="line"><span class="comment">    &#123;x&#125; 占位符</span></span><br><span class="line"><span class="comment">    x=$&#123;name&#125; 将 $&#123;name&#125; 赋值给 x</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;http://localhost:8080/index2?name=&#123;x&#125;(x=$&#123;name&#125;)&#125;&quot;</span>&gt;</span>看看是谁?<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--解析样式--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;html&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;html&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--引入其他页面--&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:include</span>=<span class="string">&quot;index3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220426164613162.png" alt="image-20220426164613162" loading="lazy"></p>
<h1 id="Redisson"><a href="#Redisson" class="headerlink" title="Redisson"></a>Redisson</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jackson0714/p/redisson.html">分布式锁中的王者方案-Redisson - 悟空聊架构 - 博客园 (cnblogs.com)</a></p>
<h2 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h2><p>请求再次访问，保证每个请求都能访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;test-lock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">TestLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.获取锁，只要锁的名字一样，获取到的锁就是同一把锁。</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;WuKong-lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.加锁</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功，执行后续代码。线程 ID：&quot;</span> + 				      Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">        <span class="comment">// 3.解锁</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Finally，释放锁成功。线程 ID：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test lock ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20220609202249127.png" alt="image-20220609202249127" loading="lazy"></p>
<p>会在redis服务器中生成一个  名为 **”lock”**的key,此时就是服务锁。</p>
<p><strong>可重入锁的两个点：</strong></p>
<ul>
<li>（1）多个线程抢占锁，后面锁需要等待吗？</li>
<li>（2）如果抢占到锁的线程所在的服务停了，锁会不会被释放？</li>
</ul>
<h4 id="1-1-验证一：可重入锁是阻塞的吗？"><a href="#1-1-验证一：可重入锁是阻塞的吗？" class="headerlink" title="1.1 验证一：可重入锁是阻塞的吗？"></a>1.1 验证一：可重入锁是阻塞的吗？</h4><h4 id="先验证第一个点，用两个-http-请求来测试抢占锁。"><a href="#先验证第一个点，用两个-http-请求来测试抢占锁。" class="headerlink" title="先验证第一个点，用两个 http 请求来测试抢占锁。"></a>先验证第一个点，用两个 http 请求来测试抢占锁。</h4><p><img src="https://img-blog.csdnimg.cn/img_convert/be21a1b6cca8c9d5114aa204053f06fb.png" alt="img" loading="lazy"></p>
<p>第一个线程对应的线程 ID 为 86，10秒后，释放锁。在这期间，第二个线程需要等待锁释放。</p>
<p>第一个线程释放锁之后，第二个线程获取到了锁，10 秒后，释放锁。</p>
<p>如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/dc4e90573e817878dcd0e0c10845b4e3.png" alt="img" loading="lazy"></p>
<ul>
<li>第一步：线程 A 在 0 秒时，抢占到锁，0.1 秒后，开始执行等待 10 s。</li>
<li>第二步：线程 B 在 0.1 秒尝试抢占锁，未能抢到锁（被 A 抢占了）。</li>
<li>第三步：线程 A 在 10.1 秒后，释放锁。</li>
<li>第四步：线程 B 在 10.1 秒后抢占到锁，然后等待 10 秒后释放锁。</li>
</ul>
<p>由此可以得出结论，Redisson 的可重入锁（lock）是<strong>阻塞</strong>其他线程的，需要等待其他线程释放的。</p>
<h4 id="1-2-验证二：服务停了，锁会释放吗？"><a href="#1-2-验证二：服务停了，锁会释放吗？" class="headerlink" title="1.2 验证二：服务停了，锁会释放吗？"></a>1.2 验证二：服务停了，锁会释放吗？</h4><p>手动停掉服务，看看锁会不会释放。</p>
<p><img src="/images/image-20220609210306295.png" alt="image-20220609210306295" loading="lazy"></p>
<p>无锁状态。</p>
<p>发起请求</p>
<p><img src="/images/image-20220609210336461.png" alt="image-20220609210336461" loading="lazy"></p>
<p>生成锁。</p>
<p>手动停掉服务。</p>
<p><img src="/images/image-20220609211511310.png" alt="image-20220609211511310" loading="lazy"></p>
<p><img src="/images/image-20220609210520572.png" alt="image-20220609210520572" loading="lazy"></p>
<p>依然在。</p>
<p><img src="/images/image-20220609211409565.png" alt="image-20220609211409565" loading="lazy"></p>
<p>TTL一直在减小，30秒后 锁消失。</p>
<h4 id="原理-看门狗"><a href="#原理-看门狗" class="headerlink" title="原理 看门狗"></a>原理 看门狗</h4><p><img src="https://img-blog.csdnimg.cn/20210522084808519.gif#pic_center" alt="img" loading="lazy"></p>
<p>如果负责存储这个分布式锁的redisson节点宕机后,而且这个锁正好处于锁住状态,这个锁就会出现死锁现象。为了避免这种情况的发生, Redisson内部提供了一个监控锁的<strong>看门狗</strong>,它的作用是在Redisson实例被关闭前,不断延长锁的有效期。</p>
<p>当服务器宕机后，因为锁的有效期是 30 秒，所以会在 30 秒内自动解锁。（30秒等于宕机之前的锁占用时间+后续锁占用的时间）。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ed4e87bd7fb021a39d1734ff6da43ebd.png" alt="img" loading="lazy"></p>
<h4 id="1-3设置可重入锁的有效时间。"><a href="#1-3设置可重入锁的有效时间。" class="headerlink" title="1.3设置可重入锁的有效时间。"></a>1.3设置可重入锁的有效时间。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock.lock(<span class="number">8</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>如果业务执行时间超过 8 秒，手动释放锁将会报错，如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7754ca32b3e5c17fe365b224e9591b7a.png" alt="image-20210521102640573" loading="lazy"></p>
<p><strong>所以我们如果设置了锁的自动过期时间，则执行业务的时间一定要小于锁的自动过期时间，否则就会报错。</strong></p>
<h2 id="王者方案"><a href="#王者方案" class="headerlink" title="王者方案"></a>王者方案</h2><p><img src="https://img-blog.csdnimg.cn/img_convert/bdbaddf36d38afb1033d3bc19ea33fee.png" alt="img" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置分布式锁</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line"><span class="comment">// 2.占用锁</span></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="comment">// 3.执行业务</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 4.释放锁</span></span><br><span class="line">lock.unlock();</span><br></pre></td></tr></table></figure>

<h2 id="分布式读写锁"><a href="#分布式读写锁" class="headerlink" title="分布式读写锁"></a>分布式读写锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;read&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">read</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;liwei&quot;</span>);</span><br><span class="line">        <span class="comment">// 上锁 10 秒后自动解锁 ，无需 调用unlock方法手动解锁</span></span><br><span class="line">        lock.readLock().lock(<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;读&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;write&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">write</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;liwei&quot;</span>);</span><br><span class="line">        lock.writeLock().lock(<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;写&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同一个锁对象  <strong>redissonClient.getReadWriteLock(“liwei”);</strong></p>
<p>写锁是一个拍他锁（互斥锁），读锁是一个共享锁。</p>
<ul>
<li>读锁 + 读锁：相当于没加锁，可以并发读。</li>
<li>读锁 + 写锁：写锁需要等待读锁释放锁。</li>
<li>写锁 + 写锁：互斥，需要等待对方的锁释放。</li>
<li>写锁 + 读锁：读锁需要等待写锁释放。</li>
</ul>

</article>
    
    <div class="trm-reward">
        
            <span class="trm-reward-btn trm-glow" onclick='var qr = document.getElementById("qr"); qr.style.display = (qr.style.display === "none") ? "block" : "none";'>
                <i class="fas fa-hand-holding-usd"></i>
            </span>
        
        <p class="trm-reward-comment">感谢您来的我的世界,有疑问可联系我 ↓</p>
        <div id="qr" style="display:none;">
            
                <div style="display:inline-block">
                    <a rel="noopener" href='/images/wx.jpg' target='_blank' >
                       <img src="/images/wx.jpg" alt="微信" loading="lazy">
                    </a>
                    <p>微信</p>
                </div>
            
                <div style="display:inline-block">
                    <a rel="noopener" href='/images/qq.jpg' target='_blank' >
                       <img src="/images/qq.jpg" alt="QQ" loading="lazy">
                    </a>
                    <p>QQ</p>
                </div>
            
        </div>
    </div>

    
</div>
<div class="row">
    <div class="col-lg-12">
        <!-- title -->
        <h5 class="trm-title-with-divider">
            Other Articles
            <span data-number="02"></span>
        </h5>
    </div>
    
        <div class="col-lg-6">
    <div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40">
        <a href="/2022/10/22/Redis/" class="trm-cover-frame trm-anima-link">
            <img src="https://w.wallhaven.cc/full/nm/wallhaven-nm11ly.jpg" alt="cover">
        </a>
        <div class="trm-card-descr">
            <div class="trm-label trm-category trm-mb-20">
                <a href=" /categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                    数据库
                </a>
            </div>
            <h5>
                <a href="/2022/10/22/Redis/" class="trm-anima-link">
                    Redis
                </a>
            </h5>
            <div class="trm-divider trm-mb-20 trm-mt-20"></div>
            <ul class="trm-card-data trm-label">
                <li>22/10/22</li>
                <li>20:48</li>
                
                
            </ul>
        </div>
    </div>
</div>
    
    
        <div class="col-lg-6">
    <div class="trm-blog-card trm-scroll-animation" data-scroll data-scroll-offset="40">
        <a href="/2022/10/22/docker/" class="trm-cover-frame trm-anima-link">
            <img src="/img/block.jpg" alt="cover">
        </a>
        <div class="trm-card-descr">
            <div class="trm-label trm-category trm-mb-20">
                <a href=" #.">
                    Unclassified
                </a>
            </div>
            <h5>
                <a href="/2022/10/22/docker/" class="trm-anima-link">
                    docker
                </a>
            </h5>
            <div class="trm-divider trm-mb-20 trm-mt-20"></div>
            <ul class="trm-card-data trm-label">
                <li>22/10/22</li>
                <li>18:47</li>
                
                
            </ul>
        </div>
    </div>
</div>
    
</div>

    



                    <div class="trm-divider footer-divider"></div>

                    <!-- footer -->
                    <footer class="trm-scroll-animation" data-scroll data-scroll-offset="50">

    
        <div class="trm-footer-item">
            <a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">鄂ICP备1314520号</a>
        </div>
    

    
        <div class="trm-footer-item">
            <span>© 2020- 2022</span>
            <span class="footer-separator">·</span>
            <span class="trm-accent-color">hello、小志</span>
        </div>
    

      

    
        <div class="trm-footer-item">
            The blog has been lovely to run <span id="since" class="trm-accent-color"></span> day
        </div>
     

     
</footer>

<script>
    function show_date_time () {
        BirthDay = new Date("04/10/2022 17:00:00");
        today = new Date();
        timeold = (today.getTime() - BirthDay.getTime());
        msPerDay = 24 * 60 * 60 * 1000
        day = Math.floor(timeold / msPerDay)
        since.innerHTML = day
    }
    show_date_time()
</script>
 
                    <!-- footer end -->

                </div>
            </div>
        </div>
    </div>
</div>
            <!-- body end -->
          </div>
        </div>
      </div>
      <!-- scroll container end -->

  </div>
  <!-- app wrapper end -->

  <div id="trm-back-top" class="trm-back-top">
    <i class="fas fa-arrow-up"></i>
</div>
  
  <!-- Plugin -->



    
    

    
<script src="//cdn.jsdelivr.net/npm/locomotive-scroll@4.1.4/dist/locomotive-scroll.min.js"></script>

    
<script src="//cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>


    

    
        <script src="/js/plugins/typing.js?v=1.1.1"></script>
    

    

    <!-- 数学公式 -->
    


    <!-- 评论插件 -->
    
        
        
    



<!-- 评论插件 -->


<!-- CDN -->


    

    

    




    <!-- Service Worker -->
    
    <!-- baidu push -->
    


<script id="async-script" src="/js/main.js?v=1.1.1"></script>

</body>

</html>